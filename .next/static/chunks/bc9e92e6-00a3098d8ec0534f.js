"use strict";(self["webpackChunk_N_E"]=self["webpackChunk_N_E"]||[]).push([[992],{7015:(e,t,n)=>{n.d(t,{aU:()=>l_});var r=n(2612);var s=n(6391);var i=n(796);var o=n(9887);var a=n(2107);var u=n(927);var c=n(7358);var l=n(4134)["hp"];const h="@firebase/firestore",d="4.7.17";class f{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}f.UNAUTHENTICATED=new f(null),f.GOOGLE_CREDENTIALS=new f("google-credentials-uid"),f.FIRST_PARTY=new f("first-party-uid"),f.MOCK_USER=new f("mock-user");let m="11.9.0";const g=new i.Vy("@firebase/firestore");function p(){return g.logLevel}function y(e){g.setLogLevel(e)}function w(e,...t){if(g.logLevel<=i.$b.DEBUG){const n=t.map(_);g.debug(`Firestore (${m}): ${e}`,...n)}}function v(e,...t){if(g.logLevel<=i.$b.ERROR){const n=t.map(_);g.error(`Firestore (${m}): ${e}`,...n)}}function I(e,...t){if(g.logLevel<=i.$b.WARN){const n=t.map(_);g.warn(`Firestore (${m}): ${e}`,...n)}}function _(e){if("string"==typeof e)return e;try{return function e(e){return JSON.stringify(e)}(e)}catch(t){return e}}function T(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,b(e,r,n)}function b(e,t,n){let r=`FIRESTORE (${m}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw v(r),new Error(r)}function E(e,t,n,r){let s="Unexpected state";"string"==typeof n?s=n:r=n,e||b(t,s,r)}function x(e,t){e||T(57014,t)}function S(e,t){return e}const C={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends o.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class D{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class k{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class A{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(f.UNAUTHENTICATED))}shutdown(){}}class R{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class V{constructor(e){this.t=e,this.currentUser=f.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){E(void 0===this.o,42304);let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new D;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new D,e.enqueueRetryable(()=>r(this.currentUser))};const i=()=>{const t=s;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},o=e=>{w("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),i())};this.t.onInit(e=>o(e)),setTimeout(()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(w("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new D)}},0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(w("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(E("string"==typeof t.accessToken,31837,{l:t}),new k(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return E(null===e||"string"==typeof e,2055,{h:e}),new f(e)}}class M{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=f.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);const e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class F{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new M(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(f.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class O{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class P{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,r.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){E(void 0===this.o,3512);const n=e=>{null!=e.error&&w("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.m;return this.m=e.token,w("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};const r=e=>{w("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){const e=this.V.getImmediate({optional:!0});e?r(e):w("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new O(this.p));const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(E("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new O(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class L{getToken(){return Promise.resolve(new O(""))}invalidateToken(){}start(e,t){}shutdown(){}}function q(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}function U(){return new TextEncoder}class B{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(256/62);let n="";for(;n.length<20;){const r=q(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%62))}return n}}function z(e,t){return e<t?-1:e>t?1:0}function $(e,t){let n=0;for(;n<e.length&&n<t.length;){const r=e.codePointAt(n),s=t.codePointAt(n);if(r!==s){if(r<128&&s<128)return z(r,s);{const i=U(),o=G(i.encode(K(e,n)),i.encode(K(t,n)));return 0!==o?o:z(r,s)}}n+=r>65535?2:1}return z(e.length,t.length)}function K(e,t){return e.codePointAt(t)>65535?e.substring(t,t+2):e.substring(t,t+1)}function G(e,t){for(let n=0;n<e.length&&n<t.length;++n)if(e[n]!==t[n])return z(e[n],t[n]);return z(e.length,t.length)}function Q(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}function j(e){return e+"\0"}const W=-0xe7791f700,Y=1e6;class H{static now(){return H.fromMillis(Date.now())}static fromDate(e){return H.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*Y);return new H(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new N(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new N(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<W)throw new N(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=0x3afff44180)throw new N(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/Y}_compareTo(e){return this.seconds===e.seconds?z(this.nanoseconds,e.nanoseconds):z(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds-W;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class J{static fromTimestamp(e){return new J(e)}static min(){return new J(new H(0,0))}static max(){return new J(new H(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}const X="__name__";class Z{constructor(e,t,n){void 0===t?t=0:t>e.length&&T(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&T(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Z.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Z?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=Z.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return z(e.length,t.length)}static compareSegments(e,t){const n=Z.isNumericId(e),r=Z.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?Z.extractNumericId(e).compare(Z.extractNumericId(t)):$(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return a.jz.fromString(e.substring(4,e.length-2))}}class ee extends Z{construct(e,t,n){return new ee(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new N(C.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new ee(t)}static emptyPath(){return new ee([])}}const et=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class en extends Z{construct(e,t,n){return new en(e,t,n)}static isValidIdentifier(e){return et.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),en.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===X}static keyField(){return new en([X])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new N(C.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new N(C.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(C.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new N(C.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new en(t)}static emptyPath(){return new en([])}}class er{constructor(e){this.path=e}static fromPath(e){return new er(ee.fromString(e))}static fromName(e){return new er(ee.fromString(e).popFirst(5))}static empty(){return new er(ee.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ee.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ee.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new er(new ee(e.slice()))}}const es=-1;class ei{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function eo(e){return e.fields.find(e=>2===e.kind)}function ea(e){return e.fields.filter(e=>2!==e.kind)}function eu(e,t){let n=z(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=el(e.fields[r],t.fields[r]),0!==n)return n;return z(e.fields.length,t.fields.length)}ei.UNKNOWN_ID=-1;class ec{constructor(e,t){this.fieldPath=e,this.kind=t}}function el(e,t){const n=en.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:z(e.kind,t.kind)}class eh{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new eh(0,em.min())}}function ed(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=J.fromTimestamp(1e9===r?new H(n+1,0):new H(n,r));return new em(s,er.empty(),t)}function ef(e){return new em(e.readTime,e.key,es)}class em{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new em(J.min(),er.empty(),es)}static max(){return new em(J.max(),er.empty(),es)}}function eg(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=er.comparator(e.documentKey,t.documentKey),0!==n?n:z(e.largestBatchId,t.largestBatchId))}const ep="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ey{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ew(e){if(e.code!==C.FAILED_PRECONDITION||e.message!==ep)throw e;w("LocalStore","Unexpectedly lost primary lease")}class ev{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&T(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ev((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof ev?t:ev.resolve(t)}catch(e){return ev.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ev.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ev.reject(t)}static resolve(e){return new ev((t,n)=>{t(e)})}static reject(e){return new ev((t,n)=>{n(e)})}static waitFor(e){return new ev((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=ev.resolve(!1);for(const n of e)t=t.next(e=>e?ev.resolve(e):n());return t}static forEach(e,t){const n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ev((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next(e=>{i[u]=e,++o,o===s&&n(i)},e=>r(e))}})}static doWhile(e,t){return new ev((n,r)=>{const s=()=>{!0===e()?t().next(()=>{s()},r):n()};s()})}}const eI="SimpleDb";class e_{static open(e,t,n,r){try{return new e_(t,e.transaction(r,n))}catch(e){throw new ex(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new D,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new ex(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{const n=ek(t.target.error);this.S.reject(new ex(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(w(eI,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}v(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new eC(t)}}class eT{static delete(e){w(eI,"Removing database:",e);return eN((0,o.mS)().indexedDB.deleteDatabase(e)).toPromise()}static C(){if(!(0,o.zW)())return!1;if(eT.F())return!0;const e=(0,o.ZQ)(),t=eT.M(e),n=0<t&&t<10,r=eb(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static F(){var e;return"undefined"!=typeof c&&"YES"===(null===(e=c.__PRIVATE_env)||void 0===e?void 0:e.O)}static N(e,t){return e.store(t)}static M(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}constructor(e,t,n){this.name=e,this.version=t,this.B=n,this.L=null;12.2===eT.M((0,o.ZQ)())&&v("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async k(e){return this.db||(w(eI,"Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ex(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new N(C.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new N(C.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ex(e,r))},r.onupgradeneeded=e=>{w(eI,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;if(null!==this.L&&this.L!==e.oldVersion)throw new Error(`refusing to open IndexedDB database due to potential corruption of the IndexedDB database data; this corruption could be caused by clicking the "clear site data" button in a web browser; try reloading the web page to re-initialize the IndexedDB database: lastClosedDbVersion=${this.L}, event.oldVersion=${e.oldVersion}, event.newVersion=${e.newVersion}, db.version=${t.version}`);this.B.q(t,r.transaction,e.oldVersion,this.version).next(()=>{w(eI,"Database upgrade to version "+this.version+" complete")})}}),this.db.addEventListener("close",e=>{const t=e.target;this.L=t.version},{passive:!0})),this.$&&(this.db.onversionchange=e=>this.$(e)),this.db}U(e){this.$=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.k(e);const t=e_.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.v(),e)).catch(e=>(t.abort(e),ev.reject(e))).toPromise();return i.catch(()=>{}),await t.D,i}catch(n){const e=n,t="FirebaseError"!==e.name&&i<3;if(w(eI,"Transaction failed with error:",e.message,"Retrying:",t),this.close(),!t)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eb(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}class eE{constructor(e){this.K=e,this.W=!1,this.G=null}get isDone(){return this.W}get j(){return this.G}set cursor(e){this.K=e}done(){this.W=!0}H(e){this.G=e}delete(){return eN(this.K.delete())}}class ex extends N{constructor(e,t){super(C.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eS(e){return"IndexedDbTransactionError"===e.name}class eC{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(w(eI,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(w(eI,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eN(n)}add(e){w(eI,"ADD",this.store.name,e,e);return eN(this.store.add(e))}get(e){return eN(this.store.get(e)).next(t=>(void 0===t&&(t=null),w(eI,"GET",this.store.name,e,t),t))}delete(e){w(eI,"DELETE",this.store.name,e);return eN(this.store.delete(e))}count(){w(eI,"COUNT",this.store.name);return eN(this.store.count())}J(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new ev((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{const e=this.cursor(n),t=[];return this.Y(e,(e,n)=>{t.push(n)}).next(()=>t)}}Z(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new ev((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}X(e,t){w(eI,"DELETE ALL",this.store.name);const n=this.options(e,t);n.ee=!1;const r=this.cursor(n);return this.Y(r,(e,t,n)=>n.delete())}te(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.Y(r,t)}ne(e){const t=this.cursor({});return new ev((n,r)=>{t.onerror=e=>{const t=ek(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}Y(e,t){const n=[];return new ev((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new eE(s),o=t(s.primaryKey,s.value,i);if(o instanceof ev){const e=o.catch(e=>(i.done(),ev.reject(e)));n.push(e)}i.isDone?r():null===i.j?s.continue():s.continue(i.j)}}).next(()=>ev.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.ee?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eN(e){return new ev((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=ek(e.target.error);n(t)}})}let eD=!1;function ek(e){const t=eT.M((0,o.ZQ)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eD||(eD=!0,setTimeout(()=>{throw e},0)),e}}return e}const eA="IndexBackfiller";class eR{constructor(e,t){this.asyncQueue=e,this.re=t,this.task=null}start(){this.ie(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ie(e){w(eA,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{const e=await this.re.se();w(eA,`Documents written: ${e}`)}catch(e){eS(e)?w(eA,"Ignoring IndexedDB error during index backfill: ",e):await ew(e)}await this.ie(6e4)})}}class eV{constructor(e,t){this.localStore=e,this.persistence=t}async se(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.oe(t,e))}oe(e,t){const n=new Set;let r=t,s=!0;return ev.doWhile(()=>!0===s&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return w(eA,`Processing collection: ${t}`),this._e(e,t,r).next(e=>{r-=e,n.add(t)});s=!1})).next(()=>t-r)}_e(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next(()=>this.ae(r,n)).next(n=>(w(eA,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>s.size)}))}ae(e,t){let n=e;return t.changes.forEach((e,t)=>{const r=ef(t);eg(r,n)>0&&(n=r)}),new em(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eM{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ue(e),this.ce=e=>t.writeSequenceNumber(e))}ue(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ce&&this.ce(e),e}}eM.le=-1;const eF=-1;function eO(e){return null==e}function eP(e){return 0===e&&1/e==-1/0}function eL(e){return"number"==typeof e&&Number.isInteger(e)&&!eP(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const eq="\x01";function eU(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=ez(t)),t=eB(e.get(n),t);return ez(t)}function eB(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case eq:n+="\x01\x11";break;default:n+=r}}return n}function ez(e){return e+eq+"\x01"}function e$(e){const t=e.length;if(E(t>=2,64408,{path:e}),2===t)return E(e.charAt(0)===eq&&"\x01"===e.charAt(1),56145,{path:e}),ee.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf(eq,i);(t<0||t>n)&&T(50515,{path:e});switch(e.charAt(t+1)){case"\x01":const o=e.substring(i,t);let a;0===s.length?a=o:(s+=o,a=s,s=""),r.push(a);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:T(61167,{path:e})}i=t+2}return new ee(r)}const eK="remoteDocuments",eG="owner",eQ="owner",ej="mutationQueues",eW="userId",eY="mutations",eH="batchId",eJ="userMutationsIndex",eX=["userId","batchId"];function eZ(e,t){return[e,eU(t)]}function e0(e,t,n){return[e,eU(t),n]}const e1={},e2="documentMutations",e4="remoteDocumentsV14",e3=["prefixPath","collectionGroup","readTime","documentId"],e6="documentKeyIndex",e5=["prefixPath","collectionGroup","documentId"],e8="collectionGroupIndex",e9=["collectionGroup","readTime","prefixPath","documentId"],e7="remoteDocumentGlobal",te="remoteDocumentGlobalKey",tt="targets",tn="queryTargetsIndex",tr=["canonicalId","targetId"],ts="targetDocuments",ti=["targetId","path"],to="documentTargetsIndex",ta=["path","targetId"],tu="targetGlobalKey",tc="targetGlobal",tl="collectionParents",th=["collectionId","parent"],td="clientMetadata",tf="clientId",tm="bundles",tg="bundleId",tp="namedQueries",ty="name",tw="indexConfiguration",tv="indexId",tI="collectionGroupIndex",t_="collectionGroup",tT="indexState",tb=["indexId","uid"],tE="sequenceNumberIndex",tx=["uid","sequenceNumber"],tS="indexEntries",tC=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tN="documentKeyIndex",tD=["indexId","uid","orderedDocumentKey"],tk="documentOverlays",tA=["userId","collectionPath","documentId"],tR="collectionPathOverlayIndex",tV=["userId","collectionPath","largestBatchId"],tM="collectionGroupOverlayIndex",tF=["userId","collectionGroup","largestBatchId"],tO="globals",tP="name",tL=[...[...[...[...[ej,eY,e2,eK,tt,eG,tc,ts],td],e7],tl],tm,tp],tq=[...tL,tk],tU=[ej,eY,e2,e4,tt,eG,tc,ts,td,e7,tl,tm,tp,tk],tB=tU,tz=[...tB,tw,tT,tS],t$=tz,tK=[...tz,tO],tG=tK;class tQ extends ey{constructor(e,t){super(),this.he=e,this.currentSequenceNumber=t}}function tj(e,t){const n=S(e);return eT.N(n.he,t)}function tW(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tY(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tH(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function tJ(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tX{constructor(e,t){this.comparator=e,this.root=t||t0.EMPTY}insert(e,t){return new tX(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,t0.BLACK,null,null))}remove(e){return new tX(this.comparator,this.root.remove(e,this.comparator).copy(null,null,t0.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tZ(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tZ(this.root,e,this.comparator,!1)}getReverseIterator(){return new tZ(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tZ(this.root,e,this.comparator,!0)}}class tZ{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class t0{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:t0.RED,this.left=null!=r?r:t0.EMPTY,this.right=null!=s?s:t0.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new t0(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return t0.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return t0.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,t0.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,t0.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw T(43730,{key:this.key,value:this.value});if(this.right.isRed())throw T(14113,{key:this.key,value:this.value});const e=this.left.check();if(e!==this.right.check())throw T(27949);return e+(this.isRed()?0:1)}}t0.EMPTY=null,t0.RED=!0,t0.BLACK=!1;t0.EMPTY=new class e{constructor(){this.size=0}get key(){throw T(57766)}get value(){throw T(16141)}get color(){throw T(16727)}get left(){throw T(29726)}get right(){throw T(36894)}copy(e,t,n,r,s){return this}insert(e,t,n){return new t0(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class t1{constructor(e){this.comparator=e,this.data=new tX(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();){if(!e(n.getNext().key))return}}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new t2(this.data.getIterator())}getIteratorFrom(e){return new t2(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof t1))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new t1(this.comparator);return t.data=e,t}}class t2{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function t4(e){return e.hasNext()?e.getNext():void 0}class t3{constructor(e){this.fields=e,e.sort(en.comparator)}static empty(){return new t3([])}unionWith(e){let t=new t1(en.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new t3(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Q(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class t6 extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function t5(){return"undefined"!=typeof atob}class t8{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function e(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new t6("Invalid base64 string: "+e):e}}(e);return new t8(t)}static fromUint8Array(e){const t=function e(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new t8(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function e(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function e(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return z(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}t8.EMPTY_BYTE_STRING=new t8("");const t9=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function t7(e){if(E(!!e,39018),"string"==typeof e){let t=0;const n=t9.exec(e);if(E(!!n,46558,{timestamp:e}),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ne(e.seconds),nanos:ne(e.nanos)}}function ne(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function nt(e){return"string"==typeof e?t8.fromBase64String(e):t8.fromUint8Array(e)}const nn="server_timestamp",nr="__type__",ns="__previous_value__",ni="__local_write_time__";function no(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[nr])||void 0===n?void 0:n.stringValue)===nn}function na(e){const t=e.mapValue.fields[ns];return no(t)?na(t):t}function nu(e){const t=t7(e.mapValue.fields[ni].timestampValue);return new H(t.seconds,t.nanos)}class nc{constructor(e,t,n,r,s,i,o,a,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u,this.isUsingEmulator=c}}const nl="(default)";class nh{constructor(e,t){this.projectId=e,this.database=t||nl}static empty(){return new nh("","")}get isDefaultDatabase(){return this.database===nl}isEqual(e){return e instanceof nh&&e.projectId===this.projectId&&e.database===this.database}}const nd="__type__",nf="__max__",nm={mapValue:{fields:{__type__:{stringValue:nf}}}},ng="__vector__",np="value",ny={nullValue:"NULL_VALUE"};function nw(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?no(e)?4:nF(e)?0x1fffffffffffff:nV(e)?10:11:T(28295,{value:e})}function nv(e,t){if(e===t)return!0;const n=nw(e);if(n!==nw(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return nu(e).isEqual(nu(t));case 3:return function e(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=t7(e.timestampValue),r=t7(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function e(e,t){return nt(e.bytesValue).isEqual(nt(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function e(e,t){return ne(e.geoPointValue.latitude)===ne(t.geoPointValue.latitude)&&ne(e.geoPointValue.longitude)===ne(t.geoPointValue.longitude)}(e,t);case 2:return function e(e,t){if("integerValue"in e&&"integerValue"in t)return ne(e.integerValue)===ne(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ne(e.doubleValue),r=ne(t.doubleValue);return n===r?eP(n)===eP(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Q(e.arrayValue.values||[],t.arrayValue.values||[],nv);case 10:case 11:return function e(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tW(n)!==tW(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!nv(n[e],r[e])))return!1;return!0}(e,t);default:return T(52216,{left:e})}}function nI(e,t){return void 0!==(e.values||[]).find(e=>nv(e,t))}function n_(e,t){if(e===t)return 0;const n=nw(e),r=nw(t);if(n!==r)return z(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return z(e.booleanValue,t.booleanValue);case 2:return function e(e,t){const n=ne(e.integerValue||e.doubleValue),r=ne(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return nT(e.timestampValue,t.timestampValue);case 4:return nT(nu(e),nu(t));case 5:return $(e.stringValue,t.stringValue);case 6:return function e(e,t){const n=nt(e),r=nt(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function e(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=z(n[e],r[e]);if(0!==t)return t}return z(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function e(e,t){const n=z(ne(e.latitude),ne(t.latitude));if(0!==n)return n;return z(ne(e.longitude),ne(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return nb(e.arrayValue,t.arrayValue);case 10:return function e(e,t){var n,r,s,i;const o=e.fields||{},a=t.fields||{},u=null===(n=o[np])||void 0===n?void 0:n.arrayValue,c=null===(r=a[np])||void 0===r?void 0:r.arrayValue,l=z((null===(s=null==u?void 0:u.values)||void 0===s?void 0:s.length)||0,(null===(i=null==c?void 0:c.values)||void 0===i?void 0:i.length)||0);if(0!==l)return l;return nb(u,c)}(e.mapValue,t.mapValue);case 11:return function e(e,t){if(e===nm.mapValue&&t===nm.mapValue)return 0;if(e===nm.mapValue)return 1;if(t===nm.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=$(r[e],i[e]);if(0!==t)return t;const o=n_(n[r[e]],s[i[e]]);if(0!==o)return o}return z(r.length,i.length)}(e.mapValue,t.mapValue);default:throw T(23264,{Pe:n})}}function nT(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return z(e,t);const n=t7(e),r=t7(t),s=z(n.seconds,r.seconds);return 0!==s?s:z(n.nanos,r.nanos)}function nb(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=n_(n[e],r[e]);if(t)return t}return z(n.length,r.length)}function nE(e){return nx(e)}function nx(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function e(e){const t=t7(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function e(e){return nt(e).toBase64()}(e.bytesValue):"referenceValue"in e?function e(e){return er.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function e(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function e(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=nx(r);return t+"]"}(e.arrayValue):"mapValue"in e?function e(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${nx(e.fields[s])}`;return n+"}"}(e.mapValue):T(61005,{value:e})}function nS(e){switch(nw(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=na(e);return t?16+nS(t):16;case 5:return 2*e.stringValue.length;case 6:return nt(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function e(e){return(e.values||[]).reduce((e,t)=>e+nS(t),0)}(e.arrayValue);case 10:case 11:return function e(e){let t=0;return tY(e.fields,(e,n)=>{t+=e.length+nS(n)}),t}(e.mapValue);default:throw T(13486,{value:e})}}function nC(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function nN(e){return!!e&&"integerValue"in e}function nD(e){return!!e&&"arrayValue"in e}function nk(e){return!!e&&"nullValue"in e}function nA(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nR(e){return!!e&&"mapValue"in e}function nV(e){var t,n;return(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{})[nd])||void 0===n?void 0:n.stringValue)===ng}function nM(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return tY(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nM(n)),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nM(e.arrayValue.values[n]);return t}return Object.assign({},e)}function nF(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===nf}const nO={mapValue:{fields:{[nd]:{stringValue:ng},[np]:{arrayValue:{}}}}};function nP(e){return"nullValue"in e?ny:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?nC(nh.empty(),er.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?nV(e)?nO:{mapValue:{}}:T(35942,{value:e})}function nL(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?nC(nh.empty(),er.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?nO:"mapValue"in e?nV(e)?{mapValue:{}}:nm:T(61959,{value:e})}function nq(e,t){const n=n_(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nU(e,t){const n=n_(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nB{constructor(e){this.value=e}static empty(){return new nB({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!nR(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nM(t)}setAll(e){let t=en.emptyPath(),n={},r=[];e.forEach((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=nM(e):r.push(s.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());nR(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return nv(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nR(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){tY(t,(t,n)=>e[t]=n);for(const t of n)delete e[t]}clone(){return new nB(nM(this.value))}}function nz(e){const t=[];return tY(e.fields,(e,n)=>{const r=new en([e]);if(nR(n)){const e=nz(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)}),new t3(t)}class n${constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new n$(e,0,J.min(),J.min(),J.min(),nB.empty(),0)}static newFoundDocument(e,t,n,r){return new n$(e,1,t,J.min(),n,r,0)}static newNoDocument(e,t){return new n$(e,2,t,J.min(),J.min(),nB.empty(),0)}static newUnknownDocument(e,t){return new n$(e,3,t,J.min(),J.min(),nB.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(J.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nB.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nB.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=J.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof n$&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n$(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nK{constructor(e,t){this.position=e,this.inclusive=t}}function nG(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(i.field.isKeyField())r=er.comparator(er.fromName(o.referenceValue),n.key);else{r=n_(o,n.data.field(i.field))}if("desc"===i.dir&&(r*=-1),0!==r)break}return r}function nQ(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++){if(!nv(e.position[n],t.position[n]))return!1}return!0}class nj{constructor(e,t="asc"){this.field=e,this.dir=t}}function nW(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class nY{}class nH extends nY{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new n5(e,t,n):"array-contains"===t?new re(e,n):"in"===t?new rt(e,n):"not-in"===t?new rn(e,n):"array-contains-any"===t?new rr(e,n):new nH(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new n8(e,n):new n9(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(n_(t,this.value)):null!==t&&nw(this.value)===nw(t)&&this.matchesComparison(n_(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return T(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nJ extends nY{constructor(e,t){super(),this.filters=e,this.op=t,this.Te=null}static create(e,t){return new nJ(e,t)}matches(e){return nX(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Te||(this.Te=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Te}getFilters(){return Object.assign([],this.filters)}}function nX(e){return"and"===e.op}function nZ(e){return"or"===e.op}function n0(e){return n1(e)&&nX(e)}function n1(e){for(const t of e.filters)if(t instanceof nJ)return!1;return!0}function n2(e){if(e instanceof nH)return e.field.canonicalString()+e.op.toString()+nE(e.value);if(n0(e))return e.filters.map(e=>n2(e)).join(",");{const t=e.filters.map(e=>n2(e)).join(",");return`${e.op}(${t})`}}function n4(e,t){return e instanceof nH?function e(e,t){return t instanceof nH&&e.op===t.op&&e.field.isEqual(t.field)&&nv(e.value,t.value)}(e,t):e instanceof nJ?function e(e,t){if(t instanceof nJ&&e.op===t.op&&e.filters.length===t.filters.length){return e.filters.reduce((e,n,r)=>e&&n4(n,t.filters[r]),!0)}return!1}(e,t):void T(19439)}function n3(e,t){const n=e.filters.concat(t);return nJ.create(n,e.op)}function n6(e){return e instanceof nH?function e(e){return`${e.field.canonicalString()} ${e.op} ${nE(e.value)}`}(e):e instanceof nJ?function e(e){return e.op.toString()+" {"+e.getFilters().map(n6).join(" ,")+"}"}(e):"Filter"}class n5 extends nH{constructor(e,t,n){super(e,t,n),this.key=er.fromName(n.referenceValue)}matches(e){const t=er.comparator(e.key,this.key);return this.matchesComparison(t)}}class n8 extends nH{constructor(e,t){super(e,"in",t),this.keys=n7("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class n9 extends nH{constructor(e,t){super(e,"not-in",t),this.keys=n7("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function n7(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>er.fromName(e.referenceValue))}class re extends nH{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return nD(t)&&nI(t.arrayValue,this.value)}}class rt extends nH{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&nI(this.value.arrayValue,t)}}class rn extends nH{constructor(e,t){super(e,"not-in",t)}matches(e){if(nI(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!nI(this.value.arrayValue,t)}}class rr extends nH{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!nD(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>nI(this.value.arrayValue,e))}}class rs{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.Ie=null}}function ri(e,t=null,n=[],r=[],s=null,i=null,o=null){return new rs(e,t,n,r,s,i,o)}function ro(e){const t=S(e);if(null===t.Ie){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>n2(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>(function e(e){return e.field.canonicalString()+e.dir})(e)).join(","),eO(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>nE(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>nE(e)).join(",")),t.Ie=e}return t.Ie}function ra(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!nW(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!n4(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nQ(e.startAt,t.startAt)&&nQ(e.endAt,t.endAt)}function ru(e){return er.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function rc(e,t){return e.filters.filter(e=>e instanceof nH&&e.field.isEqual(t))}function rl(e,t,n){let r=ny,s=!0;for(const n of rc(e,t)){let e=ny,t=!0;switch(n.op){case"<":case"<=":e=nP(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=ny}nq({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i){if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];nq({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}}return{value:r,inclusive:s}}function rh(e,t,n){let r=nm,s=!0;for(const n of rc(e,t)){let e=nm,t=!0;switch(n.op){case">=":case">":e=nL(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=nm}nU({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i){if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];nU({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}}return{value:r,inclusive:s}}class rd{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.Ee=null,this.de=null,this.Ae=null,this.startAt,this.endAt}}function rf(e,t,n,r,s,i,o,a){return new rd(e,t,n,r,s,i,o,a)}function rm(e){return new rd(e)}function rg(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function rp(e){return null!==e.collectionGroup}function ry(e){const t=S(e);if(null===t.Ee){t.Ee=[];const e=new Set;for(const n of t.explicitOrderBy)t.Ee.push(n),e.add(n.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function e(e){let t=new t1(en.comparator);return e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t}(t);r.forEach(r=>{e.has(r.canonicalString())||r.isKeyField()||t.Ee.push(new nj(r,n))}),e.has(en.keyField().canonicalString())||t.Ee.push(new nj(en.keyField(),n))}return t.Ee}function rw(e){const t=S(e);return t.de||(t.de=rI(t,ry(e))),t.de}function rv(e){const t=S(e);return t.Ae||(t.Ae=rI(t,e.explicitOrderBy)),t.Ae}function rI(e,t){if("F"===e.limitType)return ri(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{const t="desc"===e.dir?"asc":"desc";return new nj(e.field,t)});const n=e.endAt?new nK(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nK(e.startAt.position,e.startAt.inclusive):null;return ri(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function r_(e,t){const n=e.filters.concat([t]);return new rd(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function rT(e,t,n){return new rd(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function rb(e,t){return ra(rw(e),rw(t))&&e.limitType===t.limitType}function rE(e){return`${ro(rw(e))}|lt:${e.limitType}`}function rx(e){return`Query(target=${function e(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map(e=>n6(e)).join(", ")}]`),eO(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map(e=>(function e(e){return`${e.field.canonicalString()} (${e.dir})`})(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nE(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nE(e)).join(",")),`Target(${t})`}(rw(e))}; limitType=${e.limitType})`}function rS(e,t){return t.isFoundDocument()&&function e(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):er.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function e(e,t){for(const n of ry(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function e(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function e(e,t){if(e.startAt&&!function e(e,t,n){const r=nG(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,ry(e),t))return!1;if(e.endAt&&!function e(e,t,n){const r=nG(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,ry(e),t))return!1;return!0}(e,t)}function rC(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function rN(e){return(t,n)=>{let r=!1;for(const s of ry(e)){const e=rD(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function rD(e,t,n){const r=e.field.isKeyField()?er.comparator(t.key,n.key):function e(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?n_(r,s):T(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return T(19790,{direction:e.dir})}}class rk{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(const[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tY(this.inner,(t,n)=>{for(const[t,r]of n)e(t,r)})}isEmpty(){return tJ(this.inner)}size(){return this.innerSize}}const rA=new tX(er.comparator);function rR(){return rA}const rV=new tX(er.comparator);function rM(...e){let t=rV;for(const n of e)t=t.insert(n.key,n);return t}function rF(e){let t=rV;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rO(){return rL()}function rP(){return rL()}function rL(){return new rk(e=>e.toString(),(e,t)=>e.isEqual(t))}const rq=new tX(er.comparator);const rU=new t1(er.comparator);function rB(...e){let t=rU;for(const n of e)t=t.add(n);return t}const rz=new t1(z);function r$(){return rz}function rK(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eP(t)?"-0":t}}function rG(e){return{integerValue:""+e}}function rQ(e,t){return eL(t)?rG(t):rK(e,t)}class rj{constructor(){this._=void 0}}function rW(e,t,n){return e instanceof rJ?function e(e,t){const n={fields:{[nr]:{stringValue:nn},[ni]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&no(t)&&(t=na(t)),t&&(n.fields[ns]=t),{mapValue:n}}(n,t):e instanceof rX?rZ(e,t):e instanceof r0?r1(e,t):function e(e,t){const n=rH(e,t),r=r4(n)+r4(e.Re);return nN(n)&&nN(e.Re)?rG(r):rK(e.serializer,r)}(e,t)}function rY(e,t,n){return e instanceof rX?rZ(e,t):e instanceof r0?r1(e,t):n}function rH(e,t){return e instanceof r2?function e(e){return nN(e)||function e(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class rJ extends rj{}class rX extends rj{constructor(e){super(),this.elements=e}}function rZ(e,t){const n=r3(t);for(const t of e.elements)n.some(e=>nv(e,t))||n.push(t);return{arrayValue:{values:n}}}class r0 extends rj{constructor(e){super(),this.elements=e}}function r1(e,t){let n=r3(t);for(const t of e.elements)n=n.filter(e=>!nv(e,t));return{arrayValue:{values:n}}}class r2 extends rj{constructor(e,t){super(),this.serializer=e,this.Re=t}}function r4(e){return ne(e.integerValue||e.doubleValue)}function r3(e){return nD(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class r6{constructor(e,t){this.field=e,this.transform=t}}function r5(e,t){return e.field.isEqual(t.field)&&function e(e,t){return e instanceof rX&&t instanceof rX||e instanceof r0&&t instanceof r0?Q(e.elements,t.elements,nv):e instanceof r2&&t instanceof r2?nv(e.Re,t.Re):e instanceof rJ&&t instanceof rJ}(e.transform,t.transform)}class r8{constructor(e,t){this.version=e,this.transformResults=t}}class r9{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new r9}static exists(e){return new r9(void 0,e)}static updateTime(e){return new r9(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function r7(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class se{}function st(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new sh(e.key,r9.none()):new so(e.key,e.data,r9.none());{const n=e.data,r=nB.empty();let s=new t1(en.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new sa(e.key,r,new t3(s.toArray()),r9.none())}}function sn(e,t,n){e instanceof so?function e(e,t,n){const r=e.value.clone(),s=sc(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof sa?function e(e,t,n){if(!r7(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=sc(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(su(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function e(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function sr(e,t,n,r){return e instanceof so?function e(e,t,n,r){if(!r7(e.precondition,t))return n;const s=e.value.clone(),i=sl(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof sa?function e(e,t,n,r){if(!r7(e.precondition,t))return n;const s=sl(e.fieldTransforms,r,t),i=t.data;if(i.setAll(su(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n)return null;return n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):function e(e,t,n){if(r7(e.precondition,t))return t.convertToNoDocument(t.version).setHasLocalMutations(),null;return n}(e,t,n)}function ss(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=rH(r.transform,e||null);null!=s&&(null===n&&(n=nB.empty()),n.set(r.field,s))}return n||null}function si(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function e(e,t){return void 0===e&&void 0===t||!(!e||!t)&&Q(e,t,(e,t)=>r5(e,t))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class so extends se{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class sa extends se{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function su(e){const t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}}),t}function sc(e,t,n){const r=new Map;E(e.length===n.length,32656,{Ve:n.length,me:e.length});for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,rY(o,a,n[s]))}return r}function sl(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,rW(e,i,t))}return r}class sh extends se{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class sd extends se{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class sf{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];if(r.key.isEqual(e.key)){sn(r,e,n[t])}}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=sr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=sr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=rP();return this.mutations.forEach(r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=st(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(J.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rB())}isEqual(e){return this.batchId===e.batchId&&Q(this.mutations,e.mutations,(e,t)=>si(e,t))&&Q(this.baseMutations,e.baseMutations,(e,t)=>si(e,t))}}class sm{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){E(e.mutations.length===n.length,58842,{fe:e.mutations.length,ge:n.length});let r=function e(){return rq}();const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new sm(e,t,n,r)}}class sg{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class sp{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class sy{constructor(e,t){this.count=e,this.unchangedNames=t}}var sw,sv;function sI(e){switch(e){case C.OK:return T(64938);case C.CANCELLED:case C.UNKNOWN:case C.DEADLINE_EXCEEDED:case C.RESOURCE_EXHAUSTED:case C.INTERNAL:case C.UNAVAILABLE:case C.UNAUTHENTICATED:return!1;case C.INVALID_ARGUMENT:case C.NOT_FOUND:case C.ALREADY_EXISTS:case C.PERMISSION_DENIED:case C.FAILED_PRECONDITION:case C.ABORTED:case C.OUT_OF_RANGE:case C.UNIMPLEMENTED:case C.DATA_LOSS:return!0;default:return T(15467,{code:e})}}function s_(e){if(void 0===e)return v("GRPC error has no .code"),C.UNKNOWN;switch(e){case sw.OK:return C.OK;case sw.CANCELLED:return C.CANCELLED;case sw.UNKNOWN:return C.UNKNOWN;case sw.DEADLINE_EXCEEDED:return C.DEADLINE_EXCEEDED;case sw.RESOURCE_EXHAUSTED:return C.RESOURCE_EXHAUSTED;case sw.INTERNAL:return C.INTERNAL;case sw.UNAVAILABLE:return C.UNAVAILABLE;case sw.UNAUTHENTICATED:return C.UNAUTHENTICATED;case sw.INVALID_ARGUMENT:return C.INVALID_ARGUMENT;case sw.NOT_FOUND:return C.NOT_FOUND;case sw.ALREADY_EXISTS:return C.ALREADY_EXISTS;case sw.PERMISSION_DENIED:return C.PERMISSION_DENIED;case sw.FAILED_PRECONDITION:return C.FAILED_PRECONDITION;case sw.ABORTED:return C.ABORTED;case sw.OUT_OF_RANGE:return C.OUT_OF_RANGE;case sw.UNIMPLEMENTED:return C.UNIMPLEMENTED;case sw.DATA_LOSS:return C.DATA_LOSS;default:return T(39323,{code:e})}}(sv=sw||(sw={}))[sv.OK=0]="OK",sv[sv.CANCELLED=1]="CANCELLED",sv[sv.UNKNOWN=2]="UNKNOWN",sv[sv.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",sv[sv.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",sv[sv.NOT_FOUND=5]="NOT_FOUND",sv[sv.ALREADY_EXISTS=6]="ALREADY_EXISTS",sv[sv.PERMISSION_DENIED=7]="PERMISSION_DENIED",sv[sv.UNAUTHENTICATED=16]="UNAUTHENTICATED",sv[sv.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",sv[sv.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",sv[sv.ABORTED=10]="ABORTED",sv[sv.OUT_OF_RANGE=11]="OUT_OF_RANGE",sv[sv.UNIMPLEMENTED=12]="UNIMPLEMENTED",sv[sv.INTERNAL=13]="INTERNAL",sv[sv.UNAVAILABLE=14]="UNAVAILABLE",sv[sv.DATA_LOSS=15]="DATA_LOSS";let sT=null;const sb=new a.jz([0xffffffff,0xffffffff],0);function sE(e){const t=U().encode(e),n=new a.VV;return n.update(t),new Uint8Array(n.digest())}function sx(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.jz([n,r],0),new a.jz([s,i],0)]}class sS{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new sC(`Invalid padding: ${t}`);if(n<0)throw new sC(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new sC(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new sC(`Invalid padding when bitmap length is 0: ${t}`);this.pe=8*e.length-t,this.ye=a.jz.fromNumber(this.pe)}we(e,t,n){let r=e.add(t.multiply(a.jz.fromNumber(n)));return 1===r.compare(sb)&&(r=new a.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.ye).toNumber()}be(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.pe)return!1;const t=sE(e),[n,r]=sx(t);for(let e=0;e<this.hashCount;e++){const t=this.we(n,r,e);if(!this.be(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new sS(s,r,t);return n.forEach(e=>i.insert(e)),i}insert(e){if(0===this.pe)return;const t=sE(e),[n,r]=sx(t);for(let e=0;e<this.hashCount;e++){const t=this.we(n,r,e);this.Se(t)}}Se(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class sC extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class sN{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,sD.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new sN(J.min(),r,new tX(z),rR(),rB())}}class sD{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new sD(n,t,rB(),rB(),rB())}}class sk{constructor(e,t,n,r){this.De=e,this.removedTargetIds=t,this.key=n,this.ve=r}}class sA{constructor(e,t){this.targetId=e,this.Ce=t}}class sR{constructor(e,t,n=t8.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class sV{constructor(){this.Fe=0,this.Me=sO(),this.xe=t8.EMPTY_BYTE_STRING,this.Oe=!1,this.Ne=!0}get current(){return this.Oe}get resumeToken(){return this.xe}get Be(){return 0!==this.Fe}get Le(){return this.Ne}ke(e){e.approximateByteSize()>0&&(this.Ne=!0,this.xe=e)}qe(){let e=rB(),t=rB(),n=rB();return this.Me.forEach((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:T(38017,{changeType:s})}}),new sD(this.xe,this.Oe,e,t,n)}Qe(){this.Ne=!1,this.Me=sO()}$e(e,t){this.Ne=!0,this.Me=this.Me.insert(e,t)}Ue(e){this.Ne=!0,this.Me=this.Me.remove(e)}Ke(){this.Fe+=1}We(){this.Fe-=1,E(this.Fe>=0,3241,{Fe:this.Fe})}Ge(){this.Ne=!0,this.Oe=!0}}class sM{constructor(e){this.ze=e,this.je=new Map,this.He=rR(),this.Je=sF(),this.Ye=sF(),this.Ze=new tX(z)}Xe(e){for(const t of e.De)e.ve&&e.ve.isFoundDocument()?this.et(t,e.ve):this.tt(t,e.key,e.ve);for(const t of e.removedTargetIds)this.tt(t,e.key,e.ve)}nt(e){this.forEachTarget(e,t=>{const n=this.rt(t);switch(e.state){case 0:this.it(t)&&n.ke(e.resumeToken);break;case 1:n.We(),n.Be||n.Qe(),n.ke(e.resumeToken);break;case 2:n.We(),n.Be||this.removeTarget(t);break;case 3:this.it(t)&&(n.Ge(),n.ke(e.resumeToken));break;case 4:this.it(t)&&(this.st(t),n.ke(e.resumeToken));break;default:T(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.je.forEach((e,n)=>{this.it(n)&&t(n)})}ot(e){const t=e.targetId,n=e.Ce.count,r=this._t(t);if(r){const s=r.target;if(ru(s))if(0===n){const e=new er(s.path);this.tt(t,e,n$.newNoDocument(e,J.min()))}else E(1===n,20013,{expectedCount:n});else{const r=this.ut(t);if(r!==n){const n=this.ct(e),s=n?this.lt(n,e,r):1;if(0!==s){this.st(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ze=this.Ze.insert(t,e)}null==sT||sT.ht(function e(e,t,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}});return h}(r,e.Ce,this.ze.Pt(),n,s))}}}}ct(e){const t=e.Ce.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=nt(n).toUint8Array()}catch(e){if(e instanceof t6)return I("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new sS(i,r,s)}catch(e){return I(e instanceof sC?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.pe?null:o}lt(e,t,n){return t.Ce.count===n-this.Tt(e,t.targetId)?0:2}Tt(e,t){const n=this.ze.getRemoteKeysForTarget(t);let r=0;return n.forEach(n=>{const s=this.ze.Pt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.tt(t,n,null),r++)}),r}It(e){const t=new Map;this.je.forEach((n,r)=>{const s=this._t(r);if(s){if(n.current&&ru(s.target)){const t=new er(s.target.path);this.Et(t).has(r)||this.dt(r,t)||this.tt(r,t,n$.newNoDocument(t,e))}n.Le&&(t.set(r,n.qe()),n.Qe())}});let n=rB();this.Ye.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{const t=this._t(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.He.forEach((t,n)=>n.setReadTime(e));const r=new sN(e,t,this.Ze,this.He,n);return this.He=rR(),this.Je=sF(),this.Ye=sF(),this.Ze=new tX(z),r}et(e,t){if(!this.it(e))return;const n=this.dt(e,t.key)?2:0;this.rt(e).$e(t.key,n),this.He=this.He.insert(t.key,t),this.Je=this.Je.insert(t.key,this.Et(t.key).add(e)),this.Ye=this.Ye.insert(t.key,this.At(t.key).add(e))}tt(e,t,n){if(!this.it(e))return;const r=this.rt(e);this.dt(e,t)?r.$e(t,1):r.Ue(t),this.Ye=this.Ye.insert(t,this.At(t).delete(e)),this.Ye=this.Ye.insert(t,this.At(t).add(e)),n&&(this.He=this.He.insert(t,n))}removeTarget(e){this.je.delete(e)}ut(e){const t=this.rt(e).qe();return this.ze.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ke(e){this.rt(e).Ke()}rt(e){let t=this.je.get(e);return t||(t=new sV,this.je.set(e,t)),t}At(e){let t=this.Ye.get(e);return t||(t=new t1(z),this.Ye=this.Ye.insert(e,t)),t}Et(e){let t=this.Je.get(e);return t||(t=new t1(z),this.Je=this.Je.insert(e,t)),t}it(e){const t=null!==this._t(e);return t||w("WatchChangeAggregator","Detected inactive target",e),t}_t(e){const t=this.je.get(e);return t&&t.Be?null:this.ze.Rt(e)}st(e){this.je.set(e,new sV);this.ze.getRemoteKeysForTarget(e).forEach(t=>{this.tt(e,t,null)})}dt(e,t){return this.ze.getRemoteKeysForTarget(e).has(t)}}function sF(){return new tX(er.comparator)}function sO(){return new tX(er.comparator)}const sP=(()=>{const e={asc:"ASCENDING",desc:"DESCENDING"};return e})(),sL=(()=>{const e={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};return e})(),sq=(()=>{const e={and:"AND",or:"OR"};return e})();class sU{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function sB(e,t){return e.useProto3Json||eO(t)?t:{value:t}}function sz(e,t){if(e.useProto3Json){return`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`}return{seconds:""+t.seconds,nanos:t.nanoseconds}}function s$(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function sK(e,t){return sz(e,t.toTimestamp())}function sG(e){return E(!!e,49232),J.fromTimestamp(function e(e){const t=t7(e);return new H(t.seconds,t.nanos)}(e))}function sQ(e,t){return sj(e,t).canonicalString()}function sj(e,t){const n=(function e(e){return new ee(["projects",e.projectId,"databases",e.database])})(e).child("documents");return void 0===t?n:n.child(t)}function sW(e){const t=ee.fromString(e);return E(id(t),10190,{key:t.toString()}),t}function sY(e,t){return sQ(e.databaseId,t.path)}function sH(e,t){const n=sW(t);if(n.get(1)!==e.databaseId.projectId)throw new N(C.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new N(C.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new er(s0(n))}function sJ(e,t){return sQ(e.databaseId,t)}function sX(e){const t=sW(e);return 4===t.length?ee.emptyPath():s0(t)}function sZ(e){return new ee(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function s0(e){return E(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function s1(e,t,n){return{name:sY(e,t),fields:n.value.mapValue.fields}}function s2(e,t,n){const r=sH(e,t.name),s=sG(t.updateTime),i=t.createTime?sG(t.createTime):J.min(),o=new nB({mapValue:{fields:t.fields}}),a=n$.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function s4(e,t){return"found"in t?function e(e,t){E(!!t.found,43571),t.found.name,t.found.updateTime;const n=sH(e,t.found.name),r=sG(t.found.updateTime),s=t.found.createTime?sG(t.found.createTime):J.min(),i=new nB({mapValue:{fields:t.found.fields}});return n$.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function e(e,t){E(!!t.missing,3894),E(!!t.readTime,22933);const n=sH(e,t.missing),r=sG(t.readTime);return n$.newNoDocument(n,r)}(e,t):T(7234,{result:t})}function s3(e,t){let n;if("targetChange"in t){t.targetChange;const r=function e(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:T(39313,{state:e})}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function e(e,t){return e.useProto3Json?(E(void 0===t||"string"==typeof t,58123),t8.fromBase64String(t||"")):(E(void 0===t||t instanceof l||t instanceof Uint8Array,16193),t8.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function e(e){const t=void 0===e.code?C.UNKNOWN:s_(e.code);return new N(t,e.message||"")}(o);n=new sR(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=sH(e,r.document.name),i=sG(r.document.updateTime),o=r.document.createTime?sG(r.document.createTime):J.min(),a=new nB({mapValue:{fields:r.document.fields}}),u=n$.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new sk(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=sH(e,r.document),i=r.readTime?sG(r.readTime):J.min(),o=n$.newNoDocument(s,i),a=r.removedTargetIds||[];n=new sk([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=sH(e,r.document),i=r.removedTargetIds||[];n=new sk([],i,s,null)}else{if(!("filter"in t))return T(11601,{Vt:t});{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new sy(r,s),o=e.targetId;n=new sA(o,i)}}return n}function s6(e,t){let n;if(t instanceof so)n={update:s1(e,t.key,t.value)};else if(t instanceof sh)n={delete:sY(e,t.key)};else if(t instanceof sa)n={update:s1(e,t.key,t.data),updateMask:ih(t.fieldMask)};else{if(!(t instanceof sd))return T(16599,{ft:t.type});n={verify:sY(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map(e=>(function e(e,t){const n=t.transform;if(n instanceof rJ)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rX)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof r0)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof r2)return{fieldPath:t.field.canonicalString(),increment:n.Re};throw T(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(n.currentDocument=function e(e,t){return void 0!==t.updateTime?{updateTime:sK(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:T(27497)}(e,t.precondition)),n}function s5(e,t){const n=t.currentDocument?function e(e){return void 0!==e.updateTime?r9.updateTime(sG(e.updateTime)):void 0!==e.exists?r9.exists(e.exists):r9.none()}(t.currentDocument):r9.none(),r=t.updateTransforms?t.updateTransforms.map(t=>(function e(e,t){let n=null;if("setToServerValue"in t)E("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rJ;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new rX(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new r0(e)}else"increment"in t?n=new r2(e,t.increment):T(16584,{proto:t});const r=en.fromServerFormat(t.fieldPath);return new r6(r,n)})(e,t)):[];if(t.update){t.update.name;const s=sH(e,t.update.name),i=new nB({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function e(e){const t=e.fieldPaths||[];return new t3(t.map(e=>en.fromServerFormat(e)))}(t.updateMask);return new sa(s,i,e,n,r)}return new so(s,i,n,r)}if(t.delete){const r=sH(e,t.delete);return new sh(r,n)}if(t.verify){const r=sH(e,t.verify);return new sd(r,n)}return T(1463,{proto:t})}function s8(e,t){return e&&e.length>0?(E(void 0!==t,14353),e.map(e=>(function e(e,t){let n=e.updateTime?sG(e.updateTime):sG(t);return n.isEqual(J.min())&&(n=sG(t)),new r8(n,e.transformResults||[])})(e,t))):[]}function s9(e,t){return{documents:[sJ(e,t.path)]}}function s7(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=sJ(e,s);const i=function e(e){if(0===e.length)return;return il(nJ.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function e(e){if(0===e.length)return;return e.map(e=>(function e(e){return{field:iu(e.field),direction:ii(e.dir)}})(e))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=sB(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function e(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function e(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{gt:n,parent:s}}function ie(e,t,n,r){const{gt:s,parent:i}=s7(e,t),o={},a=[];let u=0;return n.forEach(e=>{const t=r?e.alias:"aggregate_"+u++;o[t]=e.alias,"count"===e.aggregateType?a.push({alias:t,count:{}}):"avg"===e.aggregateType?a.push({alias:t,avg:{field:iu(e.fieldPath)}}):"sum"===e.aggregateType&&a.push({alias:t,sum:{field:iu(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:a,structuredQuery:s.structuredQuery},parent:s.parent},yt:o,parent:i}}function it(e){let t=sX(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){E(1===r,65062);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function e(e){const t=is(e);if(t instanceof nJ&&n0(t))return t.getFilters();return[t]}(n.where));let o=[];n.orderBy&&(o=function e(e){return e.map(e=>(function e(e){return new nj(ic(e.field),function e(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))})(e))}(n.orderBy));let a=null;n.limit&&(a=function e(e){let t;return t="object"==typeof e?e.value:e,eO(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function e(e){const t=!!e.before,n=e.values||[];return new nK(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function e(e){const t=!e.before,n=e.values||[];return new nK(n,t)}(n.endAt)),rf(t,s,o,i,a,"F",u,c)}function ir(e,t){const n=function e(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return T(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}function is(e){return void 0!==e.unaryFilter?function e(e){switch(e.unaryFilter.op){case"IS_NAN":const t=ic(e.unaryFilter.field);return nH.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=ic(e.unaryFilter.field);return nH.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=ic(e.unaryFilter.field);return nH.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=ic(e.unaryFilter.field);return nH.create(s,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return T(61313);default:return T(60726)}}(e):void 0!==e.fieldFilter?function e(e){return nH.create(ic(e.fieldFilter.field),function e(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return T(58110);default:return T(50506)}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function e(e){return nJ.create(e.compositeFilter.filters.map(e=>is(e)),function e(e){switch(e){case"AND":return"and";case"OR":return"or";default:return T(1026)}}(e.compositeFilter.op))}(e):T(30097,{filter:e})}function ii(e){return sP[e]}function io(e){return sL[e]}function ia(e){return sq[e]}function iu(e){return{fieldPath:e.canonicalString()}}function ic(e){return en.fromServerFormat(e.fieldPath)}function il(e){return e instanceof nH?function e(e){if("=="===e.op){if(nA(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NAN"}};if(nk(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nA(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NOT_NAN"}};if(nk(e.value))return{unaryFilter:{field:iu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iu(e.field),op:io(e.op),value:e.value}}}(e):e instanceof nJ?function e(e){const t=e.getFilters().map(e=>il(e));if(1===t.length)return t[0];return{compositeFilter:{op:ia(e.op),filters:t}}}(e):T(54877,{filter:e})}function ih(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function id(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class im{constructor(e,t,n,r,s=J.min(),i=J.min(),o=t8.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new im(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new im(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new im(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new im(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class ig{constructor(e){this.wt=e}}function ip(e,t){let n;if(t.document)n=s2(e.wt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=er.fromSegments(t.noDocument.path),r=iI(t.noDocument.readTime);n=n$.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return T(56709);{const e=er.fromSegments(t.unknownDocument.path),r=iI(t.unknownDocument.version);n=n$.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function e(e){const t=new H(e[0],e[1]);return J.fromTimestamp(t)}(t.readTime)),n}function iy(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:iw(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function e(e,t){return{name:sY(e,t.key),fields:t.data.value.mapValue.fields,updateTime:sz(e,t.version.toTimestamp()),createTime:sz(e,t.createTime.toTimestamp())}}(e.wt,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iv(t.version)};else{if(!t.isUnknownDocument())return T(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:iv(t.version)}}return r}function iw(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iv(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iI(e){const t=new H(e.seconds,e.nanoseconds);return J.fromTimestamp(t)}function i_(e,t){const n=(t.baseMutations||[]).map(t=>s5(e.wt,t));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map(t=>s5(e.wt,t)),s=H.fromMillis(t.localWriteTimeMs);return new sf(t.batchId,s,n,r)}function iT(e){const t=iI(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iI(e.lastLimboFreeSnapshotVersion):J.min();let r;return r=function e(e){return void 0!==e.documents}(e.query)?function e(e){const t=e.documents.length;return E(1===t,1966,{count:t}),rw(rm(sX(e.documents[0])))}(e.query):function e(e){return rw(it(e))}(e.query),new im(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,t8.fromBase64String(e.resumeToken))}function ib(e,t){const n=iv(t.snapshotVersion),r=iv(t.lastLimboFreeSnapshotVersion);let s;s=ru(t.target)?s9(e.wt,t.target):s7(e.wt,t.target).gt;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ro(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function iE(e){const t=it({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?rT(t,t.limit,"L"):t}function ix(e,t){return new sg(t.largestBatchId,s5(e.wt,t.overlayMutation))}function iS(e,t){const n=t.path.lastSegment();return[e,eU(t.path.popLast()),n]}function iC(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iv(r.readTime),documentKey:eU(r.documentKey.path),largestBatchId:r.largestBatchId}}class iN{getBundleMetadata(e,t){return iD(e).get(t).next(e=>{if(e)return function e(e){return{id:e.bundleId,createTime:iI(e.createTime),version:e.version}}(e)})}saveBundleMetadata(e,t){return iD(e).put(function e(e){return{bundleId:e.id,createTime:iv(sG(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return ik(e).get(t).next(e=>{if(e)return function e(e){return{name:e.name,query:iE(e.bundledQuery),readTime:iI(e.readTime)}}(e)})}saveNamedQuery(e,t){return ik(e).put(function e(e){return{name:e.name,readTime:iv(sG(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function iD(e){return tj(e,tm)}function ik(e){return tj(e,tp)}class iA{constructor(e,t){this.serializer=e,this.userId=t}static bt(e,t){const n=t.uid||"";return new iA(e,n)}getOverlay(e,t){return iR(e).get(iS(this.userId,t)).next(e=>e?ix(this.serializer,e):null)}getOverlays(e,t){const n=rO();return ev.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){const r=[];return n.forEach((n,s)=>{const i=new sg(t,s);r.push(this.St(e,i))}),ev.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach(e=>r.add(eU(e.getCollectionPath())));const s=[];return r.forEach(t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(iR(e).X(tR,r))}),ev.waitFor(s)}getOverlaysForCollection(e,t,n){const r=rO(),s=eU(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return iR(e).J(tR,i).next(e=>{for(const t of e){const e=ix(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const s=rO();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return iR(e).te({index:tM,range:o},(e,t,n)=>{const o=ix(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()}).next(()=>s)}St(e,t){return iR(e).put(function e(e,t,n){const[r,s,i]=iS(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:s6(e.wt,n.mutation)}}(this.serializer,this.userId,t))}}function iR(e){return tj(e,tk)}class iV{Dt(e){return tj(e,tO)}getSessionToken(e){return this.Dt(e).get("sessionToken").next(e=>{const t=null==e?void 0:e.value;return t?t8.fromUint8Array(t):t8.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iM{constructor(){}vt(e,t){this.Ct(e,t),t.Ft()}Ct(e,t){if("nullValue"in e)this.Mt(t,5);else if("booleanValue"in e)this.Mt(t,10),t.xt(e.booleanValue?1:0);else if("integerValue"in e)this.Mt(t,15),t.xt(ne(e.integerValue));else if("doubleValue"in e){const n=ne(e.doubleValue);isNaN(n)?this.Mt(t,13):(this.Mt(t,15),eP(n)?t.xt(0):t.xt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Mt(t,20),"string"==typeof n&&(n=t7(n)),t.Ot(`${n.seconds||""}`),t.xt(n.nanos||0)}else if("stringValue"in e)this.Nt(e.stringValue,t),this.Bt(t);else if("bytesValue"in e)this.Mt(t,30),t.Lt(nt(e.bytesValue)),this.Bt(t);else if("referenceValue"in e)this.kt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Mt(t,45),t.xt(n.latitude||0),t.xt(n.longitude||0)}else"mapValue"in e?nF(e)?this.Mt(t,Number.MAX_SAFE_INTEGER):nV(e)?this.qt(e.mapValue,t):(this.Qt(e.mapValue,t),this.Bt(t)):"arrayValue"in e?(this.$t(e.arrayValue,t),this.Bt(t)):T(19022,{Ut:e})}Nt(e,t){this.Mt(t,25),this.Kt(e,t)}Kt(e,t){t.Ot(e)}Qt(e,t){const n=e.fields||{};this.Mt(t,55);for(const e of Object.keys(n))this.Nt(e,t),this.Ct(n[e],t)}qt(e,t){var n,r;const s=e.fields||{};this.Mt(t,53);const i=np,o=(null===(r=null===(n=s[i].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.length)||0;this.Mt(t,15),t.xt(ne(o)),this.Nt(i,t),this.Ct(s[i],t)}$t(e,t){const n=e.values||[];this.Mt(t,50);for(const e of n)this.Ct(e,t)}kt(e,t){this.Mt(t,37);er.fromName(e).path.forEach(e=>{this.Mt(t,60),this.Kt(e,t)})}Mt(e,t){e.xt(t)}Bt(e){e.xt(2)}}iM.Wt=new iM;const iF=255;function iO(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}function iP(e){const t=64-function e(e){let t=0;for(let n=0;n<8;++n){const r=iO(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}class iL{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Gt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.zt(n.value),n=t.next();this.jt()}Ht(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Jt(n.value),n=t.next();this.Yt()}Zt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.zt(e);else if(e<2048)this.zt(960|e>>>6),this.zt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.zt(480|e>>>12),this.zt(128|63&e>>>6),this.zt(128|63&e);else{const e=t.codePointAt(0);this.zt(240|e>>>18),this.zt(128|63&e>>>12),this.zt(128|63&e>>>6),this.zt(128|63&e)}}this.jt()}Xt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{const e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Yt()}en(e){const t=this.tn(e),n=iP(t);this.nn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}rn(e){const t=this.tn(e),n=iP(t);this.nn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}sn(){this._n(iF),this._n(255)}an(){this.un(iF),this.un(255)}reset(){this.position=0}seed(e){this.nn(e.length),this.buffer.set(e,this.position),this.position+=e.length}cn(){return this.buffer.slice(0,this.position)}tn(e){const t=function e(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}zt(e){const t=255&e;0===t?(this._n(0),this._n(255)):t===iF?(this._n(iF),this._n(0)):this._n(t)}Jt(e){const t=255&e;0===t?(this.un(0),this.un(255)):t===iF?(this.un(iF),this.un(0)):this.un(e)}jt(){this._n(0),this._n(1)}Yt(){this.un(0),this.un(1)}_n(e){this.nn(1),this.buffer[this.position++]=e}un(e){this.nn(1),this.buffer[this.position++]=~e}nn(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iq{constructor(e){this.ln=e}Lt(e){this.ln.Gt(e)}Ot(e){this.ln.Zt(e)}xt(e){this.ln.en(e)}Ft(){this.ln.sn()}}class iU{constructor(e){this.ln=e}Lt(e){this.ln.Ht(e)}Ot(e){this.ln.Xt(e)}xt(e){this.ln.rn(e)}Ft(){this.ln.an()}}class iB{constructor(){this.ln=new iL,this.hn=new iq(this.ln),this.Pn=new iU(this.ln)}seed(e){this.ln.seed(e)}Tn(e){return 0===e?this.hn:this.Pn}cn(){return this.ln.cn()}reset(){this.ln.reset()}}class iz{constructor(e,t,n,r){this.In=e,this.En=t,this.dn=n,this.An=r}Rn(){const e=this.An.length,t=0===e||255===this.An[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.An,0),t!==e?n.set([0],this.An.length):++n[n.length-1],new iz(this.In,this.En,this.dn,n)}Vn(e,t,n){return{indexId:this.In,uid:e,arrayValue:iG(this.dn),directionalValue:iG(this.An),orderedDocumentKey:iG(t),documentKey:n.path.toArray()}}mn(e,t,n){const r=this.Vn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function i$(e,t){let n=e.In-t.In;return 0!==n?n:(n=iK(e.dn,t.dn),0!==n?n:(n=iK(e.An,t.An),0!==n?n:er.comparator(e.En,t.En)))}function iK(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function iG(e){return(0,o.Ov)()?function e(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function iQ(e){return"string"!=typeof e?e:function e(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class ij{constructor(e){this.fn=new t1((e,t)=>en.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.gn=e.orderBy,this.pn=[];for(const t of e.filters){const e=t;e.isInequality()?this.fn=this.fn.add(e):this.pn.push(e)}}get yn(){return this.fn.size>1}wn(e){if(E(e.collectionGroup===this.collectionId,49279),this.yn)return!1;const t=eo(e);if(void 0!==t&&!this.bn(t))return!1;const n=ea(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.bn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.fn.size>0){const e=this.fn.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.Sn(e,t)||!this.Dn(this.gn[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.gn.length||!this.Dn(this.gn[i++],e))return!1}return!0}vn(){if(this.yn)return null;let e=new t1(en.comparator);const t=[];for(const n of this.pn){if(n.field.isKeyField())continue;if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ec(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ec(n.field,0))}}for(const n of this.gn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ec(n.field,"asc"===n.dir?0:1)));return new ei(ei.UNKNOWN_ID,this.collectionId,t,eh.empty())}bn(e){for(const t of this.pn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}Dn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iW(e){var t,n;if(E(e instanceof nH||e instanceof nJ,20012),e instanceof nH){if(e instanceof rt){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map(t=>nH.create(e.field,"==",t)))||[];return nJ.create(r,"or")}return e}const r=e.filters.map(e=>iW(e));return nJ.create(r,e.op)}function iY(e){if(0===e.getFilters().length)return[];const t=iZ(iW(e));return E(iX(t),7391),iH(t)||iJ(t)?[t]:t.getFilters()}function iH(e){return e instanceof nH}function iJ(e){return e instanceof nJ&&n0(e)}function iX(e){return iH(e)||iJ(e)||function e(e){if(e instanceof nJ&&nZ(e)){for(const t of e.getFilters())if(!iH(t)&&!iJ(t))return!1;return!0}return!1}(e)}function iZ(e){if(E(e instanceof nH||e instanceof nJ,34018),e instanceof nH)return e;if(1===e.filters.length)return iZ(e.filters[0]);const t=e.filters.map(e=>iZ(e));let n=nJ.create(t,e.op);return n=i2(n),iX(n)?n:(E(n instanceof nJ,64498),E(nX(n),40251),E(n.filters.length>1,57927),n.filters.reduce((e,t)=>i0(e,t)))}function i0(e,t){let n;return E(e instanceof nH||e instanceof nJ,38388),E(t instanceof nH||t instanceof nJ,25473),n=e instanceof nH?t instanceof nH?function e(e,t){return nJ.create([e,t],"and")}(e,t):i1(e,t):t instanceof nH?i1(t,e):function e(e,t){if(E(e.filters.length>0&&t.filters.length>0,48005),nX(e)&&nX(t))return n3(e,t.getFilters());const n=nZ(e)?e:t,r=nZ(e)?t:e,s=n.filters.map(e=>i0(e,r));return nJ.create(s,"or")}(e,t),i2(n)}function i1(e,t){if(nX(t))return n3(t,e.getFilters());{const n=t.filters.map(t=>i0(e,t));return nJ.create(n,"or")}}function i2(e){if(E(e instanceof nH||e instanceof nJ,11850),e instanceof nH)return e;const t=e.getFilters();if(1===t.length)return i2(t[0]);if(n1(e))return e;const n=t.map(e=>i2(e)),r=[];return n.forEach(t=>{t instanceof nH?r.push(t):t instanceof nJ&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nJ.create(r,e.op)}class i4{constructor(){this.Cn=new i3}addToCollectionParentIndex(e,t){return this.Cn.add(t),ev.resolve()}getCollectionParents(e,t){return ev.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return ev.resolve()}deleteFieldIndex(e,t){return ev.resolve()}deleteAllFieldIndexes(e){return ev.resolve()}createTargetIndexes(e,t){return ev.resolve()}getDocumentsMatchingTarget(e,t){return ev.resolve(null)}getIndexType(e,t){return ev.resolve(0)}getFieldIndexes(e,t){return ev.resolve([])}getNextCollectionGroupToUpdate(e){return ev.resolve(null)}getMinOffset(e,t){return ev.resolve(em.min())}getMinOffsetFromCollectionGroup(e,t){return ev.resolve(em.min())}updateCollectionGroup(e,t,n){return ev.resolve()}updateIndexEntries(e,t){return ev.resolve()}}class i3{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new t1(ee.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new t1(ee.comparator)).toArray()}}const i6="IndexedDbIndexManager",i5=new Uint8Array(0);class i8{constructor(e,t){this.databaseId=t,this.Fn=new i3,this.Mn=new rk(e=>ro(e),(e,t)=>ra(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.Fn.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.Fn.add(t)});const s={collectionId:n,parent:eU(r)};return i9(e).put(s)}return ev.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[j(t),""],!1,!0);return i9(e).J(r).next(e=>{for(const r of e){if(r.collectionId!==t)break;n.push(e$(r.parent))}return n})}addFieldIndex(e,t){const n=oe(e),r=function e(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=ot(e);return s.next(e=>{n.put(iC(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=oe(e),r=ot(e),s=i7(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=oe(e),n=i7(e),r=ot(e);return t.X().next(()=>n.X()).next(()=>r.X())}createTargetIndexes(e,t){return ev.forEach(this.xn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){const n=new ij(t).vn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){const n=i7(e);let r=!0;const s=new Map;return ev.forEach(this.xn(t),t=>this.On(e,t).next(e=>{r&&(r=!!e),s.set(t,e)})).next(()=>{if(r){let e=rB();const r=[];return ev.forEach(s,(s,i)=>{w(i6,`Using index ${function e(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`}(s)} to execute ${ro(t)}`);const o=function e(e,t){const n=eo(t);if(void 0===n)return null;for(const t of rc(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),a=function e(e,t){const n=new Map;for(const r of ea(t))for(const t of rc(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function e(e,t){const n=[];let r=!0;for(const s of ea(t)){const t=0===s.kind?rl(e,s.fieldPath,e.startAt):rh(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nK(n,r)}(i,s),c=function e(e,t){const n=[];let r=!0;for(const s of ea(t)){const t=0===s.kind?rh(e,s.fieldPath,e.endAt):rl(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nK(n,r)}(i,s),l=this.Nn(s,i,u),h=this.Nn(s,i,c),d=this.Bn(s,i,a),f=this.Ln(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return ev.forEach(f,s=>n.Z(s,t.limit).next(t=>{t.forEach(t=>{const n=er.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ev.resolve(null)})}xn(e){let t=this.Mn.get(e);if(t)return t;if(0===e.filters.length)t=[e];else{t=iY(nJ.create(e.filters,"and")).map(t=>ri(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))}return this.Mn.set(e,t),t}Ln(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.kn(t[l/u]):i5,h=this.qn(e,a,n[l%u],r),d=this.Qn(e,a,s[l%u],i),f=o.map(t=>this.qn(e,a,t,!0));c.push(...this.createRange(h,d,f))}return c}qn(e,t,n,r){const s=new iz(e,er.empty(),t,n);return r?s:s.Rn()}Qn(e,t,n,r){const s=new iz(e,er.empty(),t,n);return r?s.Rn():s}On(e,t){const n=new ij(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(const r of e){n.wn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r)}return t})}getIndexType(e,t){let n=2;const r=this.xn(t);return ev.forEach(r,t=>this.On(e,t).next(e=>{e?0!==n&&e.fields.length<function e(e){let t=new t1(en.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>(function e(e){return null!==e.limit})(t)&&r.length>1&&2===n?1:n)}$n(e,t){const n=new iB;for(const r of ea(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Tn(r.kind);iM.Wt.vt(e,s)}return n.cn()}kn(e){const t=new iB;return iM.Wt.vt(e,t.Tn(0)),t.cn()}Un(e,t){const n=new iB;return iM.Wt.vt(nC(this.databaseId,t),n.Tn(function e(e){const t=ea(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.cn()}Bn(e,t,n){if(null===n)return[];let r=[];r.push(new iB);let s=0;for(const i of ea(e)){const e=n[s++];for(const n of r)if(this.Kn(t,i.fieldPath)&&nD(e))r=this.Wn(r,i,e);else{const t=n.Tn(i.kind);iM.Wt.vt(e,t)}}return this.Gn(r)}Nn(e,t,n){return this.Bn(e,t,n.position)}Gn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].cn();return t}Wn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new iB;r.seed(n.cn()),iM.Wt.vt(e,r.Tn(t.kind)),s.push(r)}return s}Kn(e,t){return!!e.filters.find(e=>e instanceof nH&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=oe(e),r=ot(e);return(t?n.J(tI,IDBKeyRange.bound(t,t)):n.J()).next(e=>{const t=[];return ev.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function e(e,t){const n=t?new eh(t.sequenceNumber,new em(iI(t.readTime),new er(e$(t.documentKey)),t.largestBatchId)):eh.empty(),r=e.fields.map(([e,t])=>new ec(en.fromServerFormat(e),t));return new ei(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:z(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){const r=oe(e),s=ot(e);return this.zn(e).next(e=>r.J(tI,IDBKeyRange.bound(t,t)).next(t=>ev.forEach(t,t=>s.put(iC(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){const n=new Map;return ev.forEach(t,(t,r)=>{const s=n.get(t.collectionGroup);return(s?ev.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next(s=>(n.set(t.collectionGroup,s),ev.forEach(s,n=>this.jn(e,t,n).next(t=>{const s=this.Hn(r,n);return t.isEqual(s)?ev.resolve():this.Jn(e,r,n,t,s)}))))})}Yn(e,t,n,r){return i7(e).put(r.Vn(this.uid,this.Un(n,t.key),t.key))}Zn(e,t,n,r){return i7(e).delete(r.mn(this.uid,this.Un(n,t.key),t.key))}jn(e,t,n){const r=i7(e);let s=new t1(i$);return r.te({index:tN,range:IDBKeyRange.only([n.indexId,this.uid,iG(this.Un(n,t))])},(e,r)=>{s=s.add(new iz(n.indexId,t,iQ(r.arrayValue),iQ(r.directionalValue)))}).next(()=>s)}Hn(e,t){let n=new t1(i$);const r=this.$n(t,e);if(null==r)return n;const s=eo(t);if(null!=s){const i=e.data.field(s.fieldPath);if(nD(i))for(const s of i.arrayValue.values||[])n=n.add(new iz(t.indexId,e.key,this.kn(s),r))}else n=n.add(new iz(t.indexId,e.key,i5,r));return n}Jn(e,t,n,r,s){w(i6,"Updating index entries for document '%s'",t.key);const i=[];return function e(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=t4(i),u=t4(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=t4(o)):t?(s(a),a=t4(i)):(a=t4(i),u=t4(o))}}(r,s,i$,r=>{i.push(this.Yn(e,t,n,r))},r=>{i.push(this.Zn(e,t,n,r))}),ev.waitFor(i)}zn(e){let t=1;return ot(e).te({index:tE,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>i$(e,t)).filter((e,t,n)=>!t||0!==i$(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=i$(s,e),i=i$(s,t);if(0===n)r[0]=e.Rn();else if(n>0&&i<0)r.push(s),r.push(s.Rn());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.Xn(r[e],r[e+1]))return[];const t=r[e].mn(this.uid,i5,er.empty()),n=r[e+1].mn(this.uid,i5,er.empty());s.push(IDBKeyRange.bound(t,n))}return s}Xn(e,t){return i$(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(on)}getMinOffset(e,t){return ev.mapArray(this.xn(t),t=>this.On(e,t).next(e=>e||T(44426))).next(on)}}function i9(e){return tj(e,tl)}function i7(e){return tj(e,tS)}function oe(e){return tj(e,tw)}function ot(e){return tj(e,tT)}function on(e){E(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;eg(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new em(t.readTime,t.documentKey,n)}const or={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},os=0x2800000;class oi{static withCacheSize(e){return new oi(e,oi.DEFAULT_COLLECTION_PERCENTILE,oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function oo(e,t,n){const r=e.store(eY),s=e.store(e2),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.te({range:o},(e,t,n)=>(a++,n.delete()));i.push(u.next(()=>{E(1===a,47070,{batchId:n.batchId})}));const c=[];for(const e of n.mutations){const r=e0(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return ev.waitFor(i).next(()=>c)}function oa(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw T(14731);t=e.noDocument}return JSON.stringify(t).length}oi.DEFAULT_COLLECTION_PERCENTILE=10,oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,oi.DEFAULT=new oi(os,oi.DEFAULT_COLLECTION_PERCENTILE,oi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),oi.DISABLED=new oi(-1,0,0);class ou{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.er={}}static bt(e,t,n,r){E(""!==e.uid,64387);const s=e.isAuthenticated()?e.uid:"";return new ou(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ol(e).te({index:eJ,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){const s=oh(e),i=ol(e);return i.add({}).next(o=>{E("number"==typeof o,49019);const a=new sf(o,t,n,r),u=function e(e,t,n){const r=n.baseMutations.map(t=>s6(e.wt,t)),s=n.mutations.map(t=>s6(e.wt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new t1((e,t)=>z(e.canonicalString(),t.canonicalString()));for(const e of r){const t=e0(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,e1))}return l.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.er[o]=a.keys()}),ev.waitFor(c).next(()=>a)})}lookupMutationBatch(e,t){return ol(e).get(t).next(e=>e?(E(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),i_(this.serializer,e)):null)}tr(e,t){return this.er[t]?ev.resolve(this.er[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){const n=e.keys();return this.er[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ol(e).te({index:eJ,range:r},(e,t,r)=>{t.userId===this.userId&&(E(t.batchId>=n,47524,{nr:n}),s=i_(this.serializer,t)),r.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=eF;return ol(e).te({index:eJ,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,eF],[this.userId,Number.POSITIVE_INFINITY]);return ol(e).J(eJ,t).next(e=>e.map(e=>i_(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=eZ(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return oh(e).te({range:r},(n,r,i)=>{const[o,a,u]=n,c=e$(a);if(o===this.userId&&t.path.isEqual(c))return ol(e).get(u).next(e=>{if(!e)throw T(61480,{rr:n,batchId:u});E(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:u}),s.push(i_(this.serializer,e))});i.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new t1(z);const r=[];return t.forEach(t=>{const s=eZ(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=oh(e).te({range:i},(e,r,s)=>{const[i,o,a]=e,u=e$(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()});r.push(o)}),ev.waitFor(r).next(()=>this.ir(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=eZ(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new t1(z);return oh(e).te({range:i},(e,t,s)=>{const[i,a,u]=e,c=e$(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()}).next(()=>this.ir(e,o))}ir(e,t){const n=[],r=[];return t.forEach(t=>{r.push(ol(e).get(t).next(e=>{if(null===e)throw T(35274,{batchId:t});E(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(i_(this.serializer,e))}))}),ev.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return oo(e.he,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.sr(t.batchId)}),ev.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}sr(e){delete this.er[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ev.resolve();const n=IDBKeyRange.lowerBound(function e(e){return[e]}(this.userId)),r=[];return oh(e).te({range:n},(e,t,n)=>{if(e[0]===this.userId){const t=e$(e[1]);r.push(t)}else n.done()}).next(()=>{E(0===r.length,56720,{_r:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return oc(e,this.userId,t)}ar(e){return od(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:eF,lastStreamToken:""})}}function oc(e,t,n){const r=eZ(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return oh(e).te({range:i,ee:!0},(e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()}).next(()=>o)}function ol(e){return tj(e,eY)}function oh(e){return tj(e,e2)}function od(e){return tj(e,ej)}class of{constructor(e){this.ur=e}next(){return this.ur+=2,this.ur}static cr(){return new of(0)}static lr(){return new of(-1)}}class om{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.hr(e).next(t=>{const n=new of(t.highestTargetId);return t.highestTargetId=n.next(),this.Pr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.hr(e).next(e=>J.fromTimestamp(new H(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.hr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.hr(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Pr(e,r)))}addTargetData(e,t){return this.Tr(e,t).next(()=>this.hr(e).next(n=>(n.targetCount+=1,this.Ir(t,n),this.Pr(e,n))))}updateTargetData(e,t){return this.Tr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>og(e).delete(t.targetId)).next(()=>this.hr(e)).next(t=>(E(t.targetCount>0,8065),t.targetCount-=1,this.Pr(e,t)))}removeTargets(e,t,n){let r=0;const s=[];return og(e).te((i,o)=>{const a=iT(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))}).next(()=>ev.waitFor(s)).next(()=>r)}forEachTarget(e,t){return og(e).te((e,n)=>{const r=iT(n);t(r)})}hr(e){return op(e).get(tu).next(e=>(E(null!==e,2888),e))}Pr(e,t){return op(e).put(tu,t)}Tr(e,t){return og(e).put(ib(this.serializer,t))}Ir(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.hr(e).next(e=>e.targetCount)}getTargetData(e,t){const n=ro(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return og(e).te({range:r,index:tn},(e,n,r)=>{const i=iT(n);ra(t,i.target)&&(s=i,r.done())}).next(()=>s)}addMatchingKeys(e,t,n){const r=[],s=oy(e);return t.forEach(t=>{const i=eU(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))}),ev.waitFor(r)}removeMatchingKeys(e,t,n){const r=oy(e);return ev.forEach(t,t=>{const s=eU(t.path);return ev.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){const n=oy(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=oy(e);let s=rB();return r.te({range:n,ee:!0},(e,t,n)=>{const r=e$(e[1]),i=new er(r);s=s.add(i)}).next(()=>s)}containsKey(e,t){const n=eU(t.path),r=IDBKeyRange.bound([n],[j(n)],!1,!0);let s=0;return oy(e).te({index:to,ee:!0,range:r},([e,t],n,r)=>{0!==e&&(s++,r.done())}).next(()=>s>0)}Rt(e,t){return og(e).get(t).next(e=>e?iT(e):null)}}function og(e){return tj(e,tt)}function op(e){return tj(e,tc)}function oy(e){return tj(e,ts)}const ow="LruGarbageCollector",ov=1048576;function oI([e,t],[n,r]){const s=z(e,n);return 0===s?z(t,r):s}class o_{constructor(e){this.Er=e,this.buffer=new t1(oI),this.dr=0}Ar(){return++this.dr}Rr(e){const t=[e,this.Ar()];if(this.buffer.size<this.Er)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();oI(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class oT{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Vr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.mr(6e4)}stop(){this.Vr&&(this.Vr.cancel(),this.Vr=null)}get started(){return null!==this.Vr}mr(e){w(ow,`Garbage collection scheduled in ${e}ms`),this.Vr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Vr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eS(e)?w(ow,"Ignoring IndexedDB error during garbage collection: ",e):await ew(e)}await this.mr(3e5)})}}class ob{constructor(e,t){this.gr=e,this.params=t}calculateTargetCount(e,t){return this.gr.pr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ev.resolve(eM.le);const n=new o_(t);return this.gr.forEachTarget(e,e=>n.Rr(e.sequenceNumber)).next(()=>this.gr.yr(e,e=>n.Rr(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.gr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.gr.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(w("LruGarbageCollector","Garbage collection skipped; disabled"),ev.resolve(or)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(w("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),or):this.wr(e,t))}getCacheSize(e){return this.gr.getCacheSize(e)}wr(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(w("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>{if(c=Date.now(),p()<=i.$b.DEBUG){w("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-l}ms
	Determined least recently used ${r} in `+(a-o)+"ms\n"+`	Removed ${s} targets in `+(u-a)+"ms\n"+`	Removed ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`)}return ev.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e})})}}function oE(e,t){return new ob(e,t)}class ox{constructor(e,t){this.db=e,this.garbageCollector=oE(this,t)}pr(e){const t=this.br(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}br(e){let t=0;return this.yr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}yr(e,t){return this.Sr(e,(e,n)=>t(n))}addReference(e,t,n){return oS(e,n)}removeReference(e,t,n){return oS(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return oS(e,t)}Dr(e,t){return function e(e,t){let n=!1;return od(e).ne(r=>oc(e,r,t).next(e=>(e&&(n=!0),ev.resolve(!e)))).next(()=>n)}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Sr(e,(i,o)=>{if(o<=t){const t=this.Dr(e,i).next(t=>{if(!t)return s++,n.getEntry(e,i).next(()=>(n.removeEntry(i,J.min()),oy(e).delete(function e(e){return[0,eU(e.path)]}(i))))});r.push(t)}}).next(()=>ev.waitFor(r)).next(()=>n.apply(e)).next(()=>s)}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return oS(e,t)}Sr(e,t){const n=oy(e);let r,s=eM.le;return n.te({index:to},([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==eM.le&&t(new er(e$(r)),s),s=o,r=i):s=eM.le}).next(()=>{s!==eM.le&&t(new er(e$(r)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function oS(e,t){return oy(e).put(function e(e,t){return{targetId:0,path:eU(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class oC{constructor(){this.changes=new rk(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,n$.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?ev.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class oN{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return oR(e).put(n)}removeEntry(e,t,n){return oR(e).delete(function e(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],iw(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.vr(e,n)))}getEntry(e,t){let n=n$.newInvalidDocument(t);return oR(e).te({index:e6,range:IDBKeyRange.only(oV(t))},(e,r)=>{n=this.Cr(t,r)}).next(()=>n)}Fr(e,t){let n={size:0,document:n$.newInvalidDocument(t)};return oR(e).te({index:e6,range:IDBKeyRange.only(oV(t))},(e,r)=>{n={document:this.Cr(t,r),size:oa(r)}}).next(()=>n)}getEntries(e,t){let n=rR();return this.Mr(e,t,(e,t)=>{const r=this.Cr(e,t);n=n.insert(e,r)}).next(()=>n)}Or(e,t){let n=rR(),r=new tX(er.comparator);return this.Mr(e,t,(e,t)=>{const s=this.Cr(e,t);n=n.insert(e,s),r=r.insert(e,oa(t))}).next(()=>({documents:n,Nr:r}))}Mr(e,t,n){if(t.isEmpty())return ev.resolve();let r=new t1(oF);t.forEach(e=>r=r.add(e));const s=IDBKeyRange.bound(oV(r.first()),oV(r.last())),i=r.getIterator();let o=i.getNext();return oR(e).te({index:e6,range:s},(e,t,r)=>{const s=er.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&oF(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.H(oV(o)):r.done()}).next(()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),iw(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return oR(e).J(IDBKeyRange.bound(o,a,!0)).next(e=>{null==s||s.incrementDocumentReadCount(e.length);let n=rR();for(const s of e){const e=this.Cr(er.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(rS(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let s=rR();const i=oM(t,n),o=oM(t,em.max());return oR(e).te({index:e8,range:IDBKeyRange.bound(i,o,!0)},(e,t,n)=>{const i=this.Cr(er.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new ok(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return oA(e).get(te).next(e=>(E(!!e,20021),e))}vr(e,t){return oA(e).put(te,t)}Cr(e,t){if(t){const e=ip(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(J.min())))return e}return n$.newInvalidDocument(e)}}function oD(e){return new oN(e)}class ok extends oC{constructor(e,t){super(),this.Br=e,this.trackRemovals=t,this.Lr=new rk(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){const t=[];let n=0,r=new t1((e,t)=>z(e.canonicalString(),t.canonicalString()));return this.changes.forEach((s,i)=>{const o=this.Lr.get(s);if(t.push(this.Br.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=iy(this.Br.serializer,i);r=r.add(s.path.popLast());const u=oa(a);n+=u-o.size,t.push(this.Br.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=iy(this.Br.serializer,i.convertToNoDocument(J.min()));t.push(this.Br.addEntry(e,s,n))}}),r.forEach(n=>{t.push(this.Br.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Br.updateMetadata(e,n)),ev.waitFor(t)}getFromCache(e,t){return this.Br.Fr(e,t).next(e=>(this.Lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Br.Or(e,t).next(({documents:e,Nr:t})=>(t.forEach((t,n)=>{this.Lr.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function oA(e){return tj(e,e7)}function oR(e){return tj(e,e4)}function oV(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function oM(e,t){const n=t.documentKey.path.toArray();return[e,iw(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function oF(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=z(n[e],r[e]),s)return s;return s=z(n.length,r.length),s||(s=z(n[n.length-2],r[r.length-2]),s||z(n[n.length-1],r[r.length-1]))}class oO{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class oP{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&sr(n.mutation,e,t3.empty(),H.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rB()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rB()){const r=rO();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rM();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){const n=rO();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rB()))}populateOverlays(e,t,n){const r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let s=rR();const i=rL(),o=function e(){return rL()}();return t.forEach((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof sa)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),sr(o.mutation,t,o.mutation.getFieldMask(),H.now())):i.set(t.key,t3.empty())}),this.recalculateAndSaveOverlays(e,s).next(e=>(e.forEach((e,t)=>i.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new oO(t,null!==(n=i.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(e,t){const n=rL();let r=new tX((e,t)=>e-t),s=rB();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(const s of e)s.keys().forEach(e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||t3.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||rB()).add(e);r=r.insert(s.batchId,a)})}).next(()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=rP();u.forEach(e=>{if(!s.has(e)){const r=st(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}}),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return ev.waitFor(i)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return function e(e){return er.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):rp(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):ev.resolve(rO());let o=es,a=s;return i.next(t=>ev.forEach(t,(t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?ev.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{a=a.insert(t,e)}))).next(()=>this.populateOverlays(e,t,s)).next(()=>this.computeViews(e,a,t,rB())).next(e=>({batchId:o,changes:rF(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new er(t)).next(e=>{let t=rM();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=rM();return this.indexManager.getCollectionParents(e,s).next(o=>ev.forEach(o,o=>{const a=function e(e,t){return new rd(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next(e=>{e.forEach((e,t)=>{i=i.insert(e,t)})})}).next(()=>i))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r))).next(e=>{s.forEach((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,n$.newInvalidDocument(r)))});let n=rM();return e.forEach((e,r)=>{const i=s.get(e);void 0!==i&&sr(i.mutation,r,t3.empty(),H.now()),rS(t,r)&&(n=n.insert(e,r))}),n})}}class oL{constructor(e){this.serializer=e,this.kr=new Map,this.qr=new Map}getBundleMetadata(e,t){return ev.resolve(this.kr.get(t))}saveBundleMetadata(e,t){return this.kr.set(t.id,function e(e){return{id:e.id,version:e.version,createTime:sG(e.createTime)}}(t)),ev.resolve()}getNamedQuery(e,t){return ev.resolve(this.qr.get(t))}saveNamedQuery(e,t){return this.qr.set(t.name,function e(e){return{name:e.name,query:iE(e.bundledQuery),readTime:sG(e.readTime)}}(t)),ev.resolve()}}class oq{constructor(){this.overlays=new tX(er.comparator),this.Qr=new Map}getOverlay(e,t){return ev.resolve(this.overlays.get(t))}getOverlays(e,t){const n=rO();return ev.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.St(e,t,r)}),ev.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Qr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Qr.delete(n)),ev.resolve()}getOverlaysForCollection(e,t,n){const r=rO(),s=t.length+1,i=new er(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ev.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new tX((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=rO(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=rO(),a=s.getIterator();for(;a.hasNext();){if(a.getNext().value.forEach((e,t)=>o.set(e,t)),o.size()>=r)break}return ev.resolve(o)}St(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.Qr.get(r.largestBatchId).delete(n.key);this.Qr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new sg(t,n));let s=this.Qr.get(t);void 0===s&&(s=rB(),this.Qr.set(t,s)),this.Qr.set(t,s.add(n.key))}}class oU{constructor(){this.sessionToken=t8.EMPTY_BYTE_STRING}getSessionToken(e){return ev.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ev.resolve()}}class oB{constructor(){this.$r=new t1(oz.Ur),this.Kr=new t1(oz.Wr)}isEmpty(){return this.$r.isEmpty()}addReference(e,t){const n=new oz(e,t);this.$r=this.$r.add(n),this.Kr=this.Kr.add(n)}Gr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.zr(new oz(e,t))}jr(e,t){e.forEach(e=>this.removeReference(e,t))}Hr(e){const t=new er(new ee([])),n=new oz(t,e),r=new oz(t,e+1),s=[];return this.Kr.forEachInRange([n,r],e=>{this.zr(e),s.push(e.key)}),s}Jr(){this.$r.forEach(e=>this.zr(e))}zr(e){this.$r=this.$r.delete(e),this.Kr=this.Kr.delete(e)}Yr(e){const t=new er(new ee([])),n=new oz(t,e),r=new oz(t,e+1);let s=rB();return this.Kr.forEachInRange([n,r],e=>{s=s.add(e.key)}),s}containsKey(e){const t=new oz(e,0),n=this.$r.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class oz{constructor(e,t){this.key=e,this.Zr=t}static Ur(e,t){return er.comparator(e.key,t.key)||z(e.Zr,t.Zr)}static Wr(e,t){return z(e.Zr,t.Zr)||er.comparator(e.key,t.key)}}class o${constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.nr=1,this.Xr=new t1(oz.Ur)}checkEmpty(e){return ev.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.nr;this.nr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new sf(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.Xr=this.Xr.add(new oz(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ev.resolve(i)}lookupMutationBatch(e,t){return ev.resolve(this.ei(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ti(n),s=r<0?0:r;return ev.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return ev.resolve(0===this.mutationQueue.length?eF:this.nr-1)}getAllMutationBatches(e){return ev.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new oz(t,0),r=new oz(t,Number.POSITIVE_INFINITY),s=[];return this.Xr.forEachInRange([n,r],e=>{const t=this.ei(e.Zr);s.push(t)}),ev.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new t1(z);return t.forEach(e=>{const t=new oz(e,0),r=new oz(e,Number.POSITIVE_INFINITY);this.Xr.forEachInRange([t,r],e=>{n=n.add(e.Zr)})}),ev.resolve(this.ni(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;er.isDocumentKey(s)||(s=s.child(""));const i=new oz(new er(s),0);let o=new t1(z);return this.Xr.forEachWhile(e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.Zr)),!0)},i),ev.resolve(this.ni(o))}ni(e){const t=[];return e.forEach(e=>{const n=this.ei(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){E(0===this.ri(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Xr;return ev.forEach(t.mutations,r=>{const s=new oz(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Xr=n})}sr(e){}containsKey(e,t){const n=new oz(t,0),r=this.Xr.firstAfterOrEqual(n);return ev.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ev.resolve()}ri(e,t){return this.ti(e)}ti(e){if(0===this.mutationQueue.length)return 0;return e-this.mutationQueue[0].batchId}ei(e){const t=this.ti(e);if(t<0||t>=this.mutationQueue.length)return null;return this.mutationQueue[t]}}class oK{constructor(e){this.ii=e,this.docs=function e(){return new tX(er.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.ii(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return ev.resolve(n?n.document.mutableCopy():n$.newInvalidDocument(t))}getEntries(e,t){let n=rR();return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():n$.newInvalidDocument(e))}),ev.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=rR();const i=t.path,o=new er(i.child("__id-9223372036854775808__")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||eg(ef(o),n)<=0||(r.has(o.key)||rS(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return ev.resolve(s)}getAllFromCollectionGroup(e,t,n,r){T(9500)}si(e,t){return ev.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new oG(this)}getSize(e){return ev.resolve(this.size)}}class oG extends oC{constructor(e){super(),this.Br=e}applyChanges(e){const t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Br.addEntry(e,r)):this.Br.removeEntry(n)}),ev.waitFor(t)}getFromCache(e,t){return this.Br.getEntry(e,t)}getAllFromCache(e,t){return this.Br.getEntries(e,t)}}class oQ{constructor(e){this.persistence=e,this.oi=new rk(e=>ro(e),ra),this.lastRemoteSnapshotVersion=J.min(),this.highestTargetId=0,this._i=0,this.ai=new oB,this.targetCount=0,this.ui=of.cr()}forEachTarget(e,t){return this.oi.forEach((e,n)=>t(n)),ev.resolve()}getLastRemoteSnapshotVersion(e){return ev.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ev.resolve(this._i)}allocateTargetId(e){return this.highestTargetId=this.ui.next(),ev.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this._i&&(this._i=t),ev.resolve()}Tr(e){this.oi.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.ui=new of(t),this.highestTargetId=t),e.sequenceNumber>this._i&&(this._i=e.sequenceNumber)}addTargetData(e,t){return this.Tr(t),this.targetCount+=1,ev.resolve()}updateTargetData(e,t){return this.Tr(t),ev.resolve()}removeTargetData(e,t){return this.oi.delete(t.target),this.ai.Hr(t.targetId),this.targetCount-=1,ev.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.oi.forEach((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.oi.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)}),ev.waitFor(s).next(()=>r)}getTargetCount(e){return ev.resolve(this.targetCount)}getTargetData(e,t){const n=this.oi.get(t)||null;return ev.resolve(n)}addMatchingKeys(e,t,n){return this.ai.Gr(t,n),ev.resolve()}removeMatchingKeys(e,t,n){this.ai.jr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),ev.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.ai.Hr(t),ev.resolve()}getMatchingKeysForTargetId(e,t){const n=this.ai.Yr(t);return ev.resolve(n)}containsKey(e,t){return ev.resolve(this.ai.containsKey(t))}}class oj{constructor(e,t){this.ci={},this.overlays={},this.li=new eM(0),this.hi=!1,this.hi=!0,this.Pi=new oU,this.referenceDelegate=e(this),this.Ti=new oQ(this);this.indexManager=new i4,this.remoteDocumentCache=function e(e){return new oK(e)}(e=>this.referenceDelegate.Ii(e)),this.serializer=new ig(t),this.Ei=new oL(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.hi=!1,Promise.resolve()}get started(){return this.hi}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new oq,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.ci[e.toKey()];return n||(n=new o$(t,this.referenceDelegate),this.ci[e.toKey()]=n),n}getGlobalsCache(){return this.Pi}getTargetCache(){return this.Ti}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ei}runTransaction(e,t,n){w("MemoryPersistence","Starting transaction:",e);const r=new oW(this.li.next());return this.referenceDelegate.di(),n(r).next(e=>this.referenceDelegate.Ai(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ri(e,t){return ev.or(Object.values(this.ci).map(n=>()=>n.containsKey(e,t)))}}class oW extends ey{constructor(e){super(),this.currentSequenceNumber=e}}class oY{constructor(e){this.persistence=e,this.Vi=new oB,this.mi=null}static fi(e){return new oY(e)}get gi(){if(this.mi)return this.mi;throw T(60996)}addReference(e,t,n){return this.Vi.addReference(n,t),this.gi.delete(n.toString()),ev.resolve()}removeReference(e,t,n){return this.Vi.removeReference(n,t),this.gi.add(n.toString()),ev.resolve()}markPotentiallyOrphaned(e,t){return this.gi.add(t.toString()),ev.resolve()}removeTarget(e,t){this.Vi.Hr(t.targetId).forEach(e=>this.gi.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.gi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}di(){this.mi=new Set}Ai(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ev.forEach(this.gi,n=>{const r=er.fromPath(n);return this.pi(e,r).next(e=>{e||t.removeEntry(r,J.min())})}).next(()=>(this.mi=null,t.apply(e)))}updateLimboDocument(e,t){return this.pi(e,t).next(e=>{e?this.gi.delete(t.toString()):this.gi.add(t.toString())})}Ii(e){return 0}pi(e,t){return ev.or([()=>ev.resolve(this.Vi.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ri(e,t)])}}class oH{constructor(e,t){this.persistence=e,this.yi=new rk(e=>eU(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=oE(this,t)}static fi(e,t){return new oH(e,t)}di(){}Ai(e){return ev.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}pr(e){const t=this.br(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}br(e){let t=0;return this.yr(e,e=>{t++}).next(()=>t)}yr(e,t){return ev.forEach(this.yi,(n,r)=>this.Dr(e,n,r).next(e=>e?ev.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.si(e,r=>this.Dr(e,r,t).next(e=>{e||(n++,s.removeEntry(r,J.min()))})).next(()=>s.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.yi.set(t,e.currentSequenceNumber),ev.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.yi.set(n,e.currentSequenceNumber),ev.resolve()}removeReference(e,t,n){return this.yi.set(n,e.currentSequenceNumber),ev.resolve()}updateLimboDocument(e,t){return this.yi.set(t,e.currentSequenceNumber),ev.resolve()}Ii(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=nS(e.data.value)),t}Dr(e,t,n){return ev.or([()=>this.persistence.Ri(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.yi.get(t);return ev.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class oJ{constructor(e){this.serializer=e}q(e,t,n,r){const s=new e_("createOrUpgrade",t);n<1&&r>=1&&(!function e(e){e.createObjectStore(eG)}(e),function e(e){e.createObjectStore(ej,{keyPath:eW});const t=e.createObjectStore(eY,{keyPath:eH,autoIncrement:!0});t.createIndex(eJ,eX,{unique:!0}),e.createObjectStore(e2)}(e),oX(e),function e(e){e.createObjectStore(eK)}(e));let i=ev.resolve();return n<3&&r>=3&&(0!==n&&(!function e(e){e.deleteObjectStore(ts),e.deleteObjectStore(tt),e.deleteObjectStore(tc)}(e),oX(e)),i=i.next(()=>(function e(e){const t=e.store(tc),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:J.min().toTimestamp(),targetCount:0};return t.put(tu,n)})(s))),n<4&&r>=4&&(0!==n&&(i=i.next(()=>(function e(e,t){const n=t.store(eY);return n.J().next(n=>{e.deleteObjectStore(eY);e.createObjectStore(eY,{keyPath:eH,autoIncrement:!0}).createIndex(eJ,eX,{unique:!0});const r=t.store(eY),s=n.map(e=>r.put(e));return ev.waitFor(s)})})(e,s))),i=i.next(()=>{!function e(e){e.createObjectStore(td,{keyPath:tf})}(e)})),n<5&&r>=5&&(i=i.next(()=>this.wi(s))),n<6&&r>=6&&(i=i.next(()=>((function e(e){e.createObjectStore(e7)})(e),this.bi(s)))),n<7&&r>=7&&(i=i.next(()=>this.Si(s))),n<8&&r>=8&&(i=i.next(()=>this.Di(e,s))),n<9&&r>=9&&(i=i.next(()=>{!function e(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)})),n<10&&r>=10&&(i=i.next(()=>this.Ci(s))),n<11&&r>=11&&(i=i.next(()=>{!function e(e){e.createObjectStore(tm,{keyPath:tg})}(e),function e(e){e.createObjectStore(tp,{keyPath:ty})}(e)})),n<12&&r>=12&&(i=i.next(()=>{!function e(e){const t=e.createObjectStore(tk,{keyPath:tA});t.createIndex(tR,tV,{unique:!1}),t.createIndex(tM,tF,{unique:!1})}(e)})),n<13&&r>=13&&(i=i.next(()=>(function e(e){const t=e.createObjectStore(e4,{keyPath:e3});t.createIndex(e6,e5),t.createIndex(e8,e9)})(e)).next(()=>this.Fi(e,s)).next(()=>e.deleteObjectStore(eK))),n<14&&r>=14&&(i=i.next(()=>this.Mi(e,s))),n<15&&r>=15&&(i=i.next(()=>(function e(e){const t=e.createObjectStore(tw,{keyPath:tv,autoIncrement:!0});t.createIndex(tI,t_,{unique:!1});const n=e.createObjectStore(tT,{keyPath:tb});n.createIndex(tE,tx,{unique:!1});const r=e.createObjectStore(tS,{keyPath:tC});r.createIndex(tN,tD,{unique:!1})})(e))),n<16&&r>=16&&(i=i.next(()=>{t.objectStore(tT).clear()}).next(()=>{t.objectStore(tS).clear()})),n<17&&r>=17&&(i=i.next(()=>{!function e(e){e.createObjectStore(tO,{keyPath:tP})}(e)})),n<18&&r>=18&&(0,o.Ov)()&&(i=i.next(()=>{t.objectStore(tT).clear()}).next(()=>{t.objectStore(tS).clear()})),i}bi(e){let t=0;return e.store(eK).te((e,n)=>{t+=oa(n)}).next(()=>{const n={byteSize:t};return e.store(e7).put(te,n)})}wi(e){const t=e.store(ej),n=e.store(eY);return t.J().next(t=>ev.forEach(t,t=>{const r=IDBKeyRange.bound([t.userId,eF],[t.userId,t.lastAcknowledgedBatchId]);return n.J(eJ,r).next(n=>ev.forEach(n,n=>{E(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});const r=i_(this.serializer,n);return oo(e,t.userId,r).next(()=>{})}))}))}Si(e){const t=e.store(ts),n=e.store(eK);return e.store(tc).get(tu).next(e=>{const r=[];return n.te((n,s)=>{const i=new ee(n),o=function e(e){return[0,eU(e)]}(i);r.push(t.get(o).next(n=>n?ev.resolve():(n=>t.put({targetId:0,path:eU(n),sequenceNumber:e.highestListenSequenceNumber}))(i)))}).next(()=>ev.waitFor(r))})}Di(e,t){e.createObjectStore(tl,{keyPath:th});const n=t.store(tl),r=new i3,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eU(r)})}};return t.store(eK).te({ee:!0},(e,t)=>{const n=new ee(e);return s(n.popLast())}).next(()=>t.store(e2).te({ee:!0},([e,t,n],r)=>{const i=e$(t);return s(i.popLast())}))}Ci(e){const t=e.store(tt);return t.te((e,n)=>{const r=iT(n),s=ib(this.serializer,r);return t.put(s)})}Fi(e,t){const n=t.store(eK),r=[];return n.te((e,n)=>{const s=t.store(e4),i=(function e(e){return e.document?new er(ee.fromString(e.document.name).popFirst(5)):e.noDocument?er.fromSegments(e.noDocument.path):e.unknownDocument?er.fromSegments(e.unknownDocument.path):T(36783)})(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))}).next(()=>ev.waitFor(r))}Mi(e,t){const n=t.store(eY),r=oD(this.serializer),s=new oj(oY.fi,this.serializer.wt);return n.J().next(e=>{const n=new Map;return e.forEach(e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:rB();i_(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),ev.forEach(n,(e,n)=>{const i=new f(n),o=iA.bt(this.serializer,i),a=s.getIndexManager(i),u=ou.bt(i,this.serializer,a,s.referenceDelegate);return new oP(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new tQ(t,eM.le),e).next()})})}}function oX(e){e.createObjectStore(ts,{keyPath:ti}).createIndex(to,ta,{unique:!0});e.createObjectStore(tt,{keyPath:"targetId"}).createIndex(tn,tr,{unique:!0}),e.createObjectStore(tc)}const oZ="IndexedDbPersistence",o0=18e5,o1=5e3,o2="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",o4="main";class o3{constructor(e,t,n,r,s,i,o,a,u,c,l=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.xi=s,this.window=i,this.document=o,this.Oi=u,this.Ni=c,this.Bi=l,this.li=null,this.hi=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Li=null,this.inForeground=!1,this.ki=null,this.qi=null,this.Qi=Number.NEGATIVE_INFINITY,this.$i=e=>Promise.resolve(),!o3.C())throw new N(C.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ox(this,r),this.Ui=t+o4,this.serializer=new ig(a),this.Ki=new eT(this.Ui,this.Bi,new oJ(this.serializer)),this.Pi=new iV,this.Ti=new om(this.referenceDelegate,this.serializer),this.remoteDocumentCache=oD(this.serializer),this.Ei=new iN,this.window&&this.window.localStorage?this.Wi=this.window.localStorage:(this.Wi=null,!1===c&&v(oZ,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Gi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(C.FAILED_PRECONDITION,o2);return this.zi(),this.ji(),this.Hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ti.getHighestSequenceNumber(e))}).then(e=>{this.li=new eM(e,this.Oi)}).then(()=>{this.hi=!0}).catch(e=>(this.Ki&&this.Ki.close(),Promise.reject(e)))}Ji(e){return this.$i=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ki.U(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.xi.enqueueAndForget(async()=>{this.started&&await this.Gi()}))}Gi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>o5(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Yi(e).next(e=>{e||(this.isPrimary=!1,this.xi.enqueueRetryable(()=>this.$i(!1)))})}).next(()=>this.Zi(e)).next(t=>this.isPrimary&&!t?this.Xi(e).next(()=>!1):!!t&&this.es(e).next(()=>!0))).catch(e=>{if(eS(e))return w(oZ,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return w(oZ,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.xi.enqueueRetryable(()=>this.$i(e)),this.isPrimary=e})}Yi(e){return o6(e).get(eQ).next(e=>ev.resolve(this.ts(e)))}ns(e){return o5(e).delete(this.clientId)}async rs(){if(this.isPrimary&&!this.ss(this.Qi,o0)){this.Qi=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const t=tj(e,td);return t.J().next(e=>{const n=this._s(e,o0),r=e.filter(e=>-1===n.indexOf(e));return ev.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Wi)for(const t of e)this.Wi.removeItem(this.us(t.clientId))}}Hi(){this.qi=this.xi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Gi().then(()=>this.rs()).then(()=>this.Hi()))}ts(e){return!!e&&e.ownerId===this.clientId}Zi(e){if(this.Ni)return ev.resolve(!0);return o6(e).get(eQ).next(t=>{if(null!==t&&this.ss(t.leaseTimestampMs,o1)&&!this.cs(t.ownerId)){if(this.ts(t)&&this.networkEnabled)return!0;if(!this.ts(t)){if(!t.allowTabSynchronization)throw new N(C.FAILED_PRECONDITION,o2);return!1}}return!(!this.networkEnabled||!this.inForeground)||o5(e).J().next(e=>void 0===this._s(e,o1).find(e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&w(oZ,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.hi=!1,this.ls(),this.qi&&(this.qi.cancel(),this.qi=null),this.hs(),this.Ps(),await this.Ki.runTransaction("shutdown","readwrite",[eG,td],e=>{const t=new tQ(e,eM.le);return this.Xi(t).next(()=>this.ns(t))}),this.Ki.close(),this.Ts()}_s(e,t){return e.filter(e=>this.ss(e.updateTimeMs,t)&&!this.cs(e.clientId))}Is(){return this.runTransaction("getActiveClients","readonly",e=>o5(e).J().next(e=>this._s(e,o0).map(e=>e.clientId)))}get started(){return this.hi}getGlobalsCache(){return this.Pi}getMutationQueue(e,t){return ou.bt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ti}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i8(e,this.serializer.wt.databaseId)}getDocumentOverlayCache(e){return iA.bt(this.serializer,e)}getBundleCache(){return this.Ei}runTransaction(e,t,n){w(oZ,"Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function e(e){return 18===e?tG:17===e?tK:16===e?t$:15===e?tz:14===e?tB:13===e?tU:12===e?tq:11===e?tL:void T(60245)}(this.Bi);let i;return this.Ki.runTransaction(e,r,s,r=>(i=new tQ(r,this.li?this.li.next():eM.le),"readwrite-primary"===t?this.Yi(i).next(e=>!!e||this.Zi(i)).next(t=>{if(!t)throw v(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.xi.enqueueRetryable(()=>this.$i(!1)),new N(C.FAILED_PRECONDITION,ep);return n(i)}).next(e=>this.es(i).next(()=>e)):this.Es(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Es(e){return o6(e).get(eQ).next(e=>{if(null!==e&&this.ss(e.leaseTimestampMs,o1)&&!this.cs(e.ownerId)&&!this.ts(e)&&!(this.Ni||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(C.FAILED_PRECONDITION,o2)})}es(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return o6(e).put(eQ,t)}static C(){return eT.C()}Xi(e){const t=o6(e);return t.get(eQ).next(e=>this.ts(e)?(w(oZ,"Releasing primary lease."),t.delete(eQ)):ev.resolve())}ss(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(v(`Detected an update time that is in the future: ${e} > ${n}`),!1))}zi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ki=()=>{this.xi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Gi()))},this.document.addEventListener("visibilitychange",this.ki),this.inForeground="visible"===this.document.visibilityState)}hs(){this.ki&&(this.document.removeEventListener("visibilitychange",this.ki),this.ki=null)}ji(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Li=()=>{this.ls();const e=/(?:Version|Mobile)\/1[456]/;(0,o.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.xi.enterRestrictedMode(!0),this.xi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Li))}Ps(){this.Li&&(this.window.removeEventListener("pagehide",this.Li),this.Li=null)}cs(e){var t;try{const n=null!==(null===(t=this.Wi)||void 0===t?void 0:t.getItem(this.us(e)));return w(oZ,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return v(oZ,"Failed to get zombied client id.",e),!1}}ls(){if(this.Wi)try{this.Wi.setItem(this.us(this.clientId),String(Date.now()))}catch(e){v("Failed to set zombie client id.",e)}}Ts(){if(this.Wi)try{this.Wi.removeItem(this.us(this.clientId))}catch(e){}}us(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function o6(e){return tj(e,eG)}function o5(e){return tj(e,td)}function o8(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class o9{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.ds=n,this.As=r}static Rs(e,t){let n=rB(),r=rB();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new o9(e,t.fromCache,n,r)}}class o7{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class ae{constructor(){this.Vs=!1,this.fs=!1,this.gs=100,this.ps=function e(){return(0,o.nr)()?8:eb((0,o.ZQ)())>0?6:4}()}initialize(e,t){this.ys=e,this.indexManager=t,this.Vs=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.ws(e,t).next(e=>{s.result=e}).next(()=>{if(!s.result)return this.bs(e,t,r,n).next(e=>{s.result=e})}).next(()=>{if(s.result)return;const n=new o7;return this.Ss(e,t,n).next(r=>{if(s.result=r,this.fs)return this.Ds(e,t,n,r.size)})}).next(()=>s.result)}Ds(e,t,n,r){return n.documentReadCount<this.gs?(p()<=i.$b.DEBUG&&w("QueryEngine","SDK will not create cache indexes for query:",rx(t),"since it only creates cache indexes for collection contains","more than or equal to",this.gs,"documents"),ev.resolve()):(p()<=i.$b.DEBUG&&w("QueryEngine","Query:",rx(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ps*r?(p()<=i.$b.DEBUG&&w("QueryEngine","The SDK decides to create cache indexes for query:",rx(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,rw(t))):ev.resolve())}ws(e,t){if(rg(t))return ev.resolve(null);let n=rw(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(t=rT(t,null,"F"),n=rw(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{const s=rB(...r);return this.ys.getDocuments(e,s).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{const i=this.vs(t,r);return this.Cs(t,i,s,n.readTime)?this.ws(e,rT(t,null,"F")):this.Fs(e,i,t,n)}))})))}bs(e,t,n,r){return rg(t)||r.isEqual(J.min())?ev.resolve(null):this.ys.getDocuments(e,n).next(s=>{const o=this.vs(t,s);return this.Cs(t,o,n,r)?ev.resolve(null):(p()<=i.$b.DEBUG&&w("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),rx(t)),this.Fs(e,o,t,ed(r,es)).next(e=>e))})}vs(e,t){let n=new t1(rN(e));return t.forEach((t,r)=>{rS(e,r)&&(n=n.add(r))}),n}Cs(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ss(e,t,n){return p()<=i.$b.DEBUG&&w("QueryEngine","Using full collection scan to execute query:",rx(t)),this.ys.getDocumentsMatchingQuery(e,t,em.min(),n)}Fs(e,t,n,r){return this.ys.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}const at="LocalStore",an=3e8;class ar{constructor(e,t,n,r){this.persistence=e,this.Ms=t,this.serializer=r,this.xs=new tX(z),this.Os=new rk(e=>ro(e),ra),this.Ns=new Map,this.Bs=e.getRemoteDocumentCache(),this.Ti=e.getTargetCache(),this.Ei=e.getBundleCache(),this.Ls(n)}Ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new oP(this.Bs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Ms.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.xs))}}function as(e,t,n,r){return new ar(e,t,n,r)}async function ai(e,t){const n=S(e);return await n.persistence.runTransaction("Handle user change","readonly",e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next(s=>(r=s,n.Ls(t),n.mutationQueue.getAllMutationBatches(e))).next(t=>{const s=[],i=[];let o=rB();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next(e=>({ks:e,removedBatchIds:s,addedBatchIds:i}))})})}function ao(e,t){const n=S(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const r=t.batch.keys(),s=n.Bs.newChangeBuffer({trackRemovals:!0});return(function e(e,t,n,r){const s=n.batch,i=s.keys();let o=ev.resolve();return i.forEach(e=>{o=o.next(()=>r.getEntry(t,e)).next(t=>{const i=n.docVersions.get(e);E(null!==i,48541),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),o.next(()=>e.mutationQueue.removeMutationBatch(t,s))})(n,e,t,s).next(()=>s.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function e(e){let t=rB();for(let n=0;n<e.mutationResults.length;++n){e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key))}return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))})}function aa(e){const t=S(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Ti.getLastRemoteSnapshotVersion(e))}function au(e,t){const n=S(e),r=t.snapshotVersion;let s=n.xs;return n.persistence.runTransaction("Apply remote event","readwrite-primary",e=>{const i=n.Bs.newChangeBuffer({trackRemovals:!0});s=n.xs;const o=[];t.targetChanges.forEach((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Ti.removeMatchingKeys(e,i.removedDocuments,a).next(()=>n.Ti.addMatchingKeys(e,i.addedDocuments,a)));let c=u.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?c=c.withResumeToken(t8.EMPTY_BYTE_STRING,J.min()).withLastLimboFreeSnapshotVersion(J.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function e(e,t,n){if(0===e.resumeToken.approximateByteSize())return!0;const r=t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds();if(r>=an)return!0;const s=n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size;return s>0}(u,c,i)&&o.push(n.Ti.updateTargetData(e,c))});let a=rR(),u=rB();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))}),o.push(ac(e,i,t.documentUpdates).next(e=>{a=e.qs,u=e.Qs})),!r.isEqual(J.min())){const t=n.Ti.getLastRemoteSnapshotVersion(e).next(t=>n.Ti.setTargetsMetadata(e,e.currentSequenceNumber,r));o.push(t)}return ev.waitFor(o).next(()=>i.apply(e)).next(()=>n.localDocuments.getLocalViewOfDocuments(e,a,u)).next(()=>a)}).then(e=>(n.xs=s,e))}function ac(e,t,n){let r=rB(),s=rB();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=rR();return n.forEach((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(J.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):w(at,"Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)}),{qs:r,Qs:s}})}function al(e,t){const n=S(e);return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=eF),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}function ah(e,t){const n=S(e);return n.persistence.runTransaction("Allocate target","readwrite",e=>{let r;return n.Ti.getTargetData(e,t).next(s=>s?(r=s,ev.resolve(r)):n.Ti.allocateTargetId(e).next(s=>(r=new im(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Ti.addTargetData(e,r).next(()=>r))))}).then(e=>{const r=n.xs.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.xs=n.xs.insert(e.targetId,e),n.Os.set(t,e.targetId)),e})}async function ad(e,t,n){const r=S(e),s=r.xs.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!eS(e))throw e;w(at,`Failed to update sequence numbers for target ${t}: ${e}`)}r.xs=r.xs.remove(t),r.Os.delete(s.target)}function af(e,t,n){const r=S(e);let s=J.min(),i=rB();return r.persistence.runTransaction("Execute query","readwrite",e=>(function e(e,t,n){const r=S(e),s=r.Os.get(n);return void 0!==s?ev.resolve(r.xs.get(s)):r.Ti.getTargetData(t,n)})(r,e,rw(t)).next(t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Ti.getMatchingKeysForTargetId(e,t.targetId).next(e=>{i=e})}).next(()=>r.Ms.getDocumentsMatchingQuery(e,t,n?s:J.min(),n?i:rB())).next(e=>(ap(r,rC(t),e),{documents:e,$s:i})))}function am(e,t){const n=S(e),r=S(n.Ti),s=n.xs.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.Rt(e,t).next(e=>e?e.target:null))}function ag(e,t){const n=S(e),r=n.Ns.get(t)||J.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Bs.getAllFromCollectionGroup(e,t,ed(r,es),Number.MAX_SAFE_INTEGER)).then(e=>(ap(n,t,e),e))}function ap(e,t,n){let r=e.Ns.get(t)||J.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Ns.set(t,r)}async function ay(e,t,n,r){const s=S(e);let i=rB(),o=rR();for(const e of n){const n=t.Us(e.metadata.name);e.document&&(i=i.add(n));const r=t.Ks(e);r.setReadTime(t.Ws(e.metadata.readTime)),o=o.insert(n,r)}const a=s.Bs.newChangeBuffer({trackRemovals:!0}),u=await ah(s,function e(e){return rw(rm(ee.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>ac(e,a,o).next(t=>(a.apply(e),t)).next(t=>s.Ti.removeMatchingKeysForTargetId(e,u.targetId).next(()=>s.Ti.addMatchingKeys(e,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(e,t.qs,t.Qs)).next(()=>t.qs)))}async function aw(e,t,n=rB()){const r=await ah(e,rw(iE(t.bundledQuery))),s=S(e);return s.persistence.runTransaction("Save named query","readwrite",e=>{const i=sG(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ei.saveNamedQuery(e,t);const o=r.withResumeToken(t8.EMPTY_BYTE_STRING,i);return s.xs=s.xs.insert(o.targetId,o),s.Ti.updateTargetData(e,o).next(()=>s.Ti.removeMatchingKeysForTargetId(e,r.targetId)).next(()=>s.Ti.addMatchingKeys(e,n,r.targetId)).next(()=>s.Ei.saveNamedQuery(e,t))})}const av="firestore_clients";function aI(e,t){return`${av}_${e}_${t}`}const a_="firestore_mutations";function aT(e,t,n){let r=`${a_}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}const ab="firestore_targets";function aE(e,t){return`${ab}_${e}_${t}`}const ax="SharedClientState";class aS{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Gs(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new N(r.error.code,r.error.message))),i?new aS(e,t,r.state,s):(v(ax,`Failed to parse mutation state for ID '${t}': ${n}`),null)}zs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aC{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Gs(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new N(n.error.code,n.error.message))),s?new aC(e,n.state,r):(v(ax,`Failed to parse target state for ID '${e}': ${t}`),null)}zs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class aN{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Gs(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=r$();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eL(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new aN(e,s):(v(ax,`Failed to parse client data for instance '${e}': ${t}`),null)}}class aD{constructor(e,t){this.clientId=e,this.onlineState=t}static Gs(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new aD(t.clientId,t.onlineState):(v(ax,`Failed to parse online state: ${e}`),null)}}class ak{constructor(){this.activeTargetIds=r$()}js(e){this.activeTargetIds=this.activeTargetIds.add(e)}Hs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}zs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class aA{constructor(e,t,n,r,s){this.window=e,this.xi=t,this.persistenceKey=n,this.Js=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Ys=this.Zs.bind(this),this.Xs=new tX(z),this.started=!1,this.eo=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.no=aI(this.persistenceKey,this.Js),this.ro=function e(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.Xs=this.Xs.insert(this.Js,new ak),this.io=new RegExp(`^${av}_${i}_([^_]*)$`),this.so=new RegExp(`^${a_}_${i}_(\\d+)(?:_(.*))?$`),this.oo=new RegExp(`^${ab}_${i}_(\\d+)$`),this._o=function e(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.ao=function e(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.Ys)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Is();for(const t of e){if(t===this.Js)continue;const e=this.getItem(aI(this.persistenceKey,t));if(e){const n=aN.Gs(t,e);n&&(this.Xs=this.Xs.insert(n.clientId,n))}}this.uo();const t=this.storage.getItem(this._o);if(t){const e=this.co(t);e&&this.lo(e)}for(const e of this.eo)this.Zs(e);this.eo=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.ro,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ho(this.Xs)}isActiveQueryTarget(e){let t=!1;return this.Xs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.Po(e,"pending")}updateMutationState(e,t,n){this.Po(e,t,n),this.To(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const t=this.storage.getItem(aE(this.persistenceKey,e));if(t){const r=aC.Gs(e,t);r&&(n=r.state)}}return t&&this.Io.js(e),this.uo(),n}removeLocalQueryTarget(e){this.Io.Hs(e),this.uo()}isLocalQueryTarget(e){return this.Io.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(aE(this.persistenceKey,e))}updateQueryState(e,t,n){this.Eo(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.To(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ao(e)}notifyBundleLoaded(e){this.Ro(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Ys),this.removeItem(this.no),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return w(ax,"READ",e,t),t}setItem(e,t){w(ax,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){w(ax,"REMOVE",e),this.storage.removeItem(e)}Zs(e){const t=e;if(t.storageArea===this.storage){if(w(ax,"EVENT",t.key,t.newValue),t.key===this.no)return void v("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.xi.enqueueRetryable(async()=>{if(this.started){if(null!==t.key){if(this.io.test(t.key)){if(null==t.newValue){const e=this.Vo(t.key);return this.mo(e,null)}{const e=this.fo(t.key,t.newValue);if(e)return this.mo(e.clientId,e)}}else if(this.so.test(t.key)){if(null!==t.newValue){const e=this.po(t.key,t.newValue);if(e)return this.yo(e)}}else if(this.oo.test(t.key)){if(null!==t.newValue){const e=this.wo(t.key,t.newValue);if(e)return this.bo(e)}}else if(t.key===this._o){if(null!==t.newValue){const e=this.co(t.newValue);if(e)return this.lo(e)}}else if(t.key===this.ro){const e=function e(e){let t=eM.le;if(null!=e)try{const n=JSON.parse(e);E("number"==typeof n,30636,{So:e}),t=n}catch(e){v(ax,"Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==eM.le&&this.sequenceNumberHandler(e)}else if(t.key===this.ao){const e=this.Do(t.newValue);await Promise.all(e.map(e=>this.syncEngine.vo(e)))}}}else this.eo.push(t)})}}get Io(){return this.Xs.get(this.Js)}uo(){this.setItem(this.no,this.Io.zs())}Po(e,t,n){const r=new aS(this.currentUser,e,t,n),s=aT(this.persistenceKey,this.currentUser,e);this.setItem(s,r.zs())}To(e){const t=aT(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ao(e){const t={clientId:this.Js,onlineState:e};this.storage.setItem(this._o,JSON.stringify(t))}Eo(e,t,n){const r=aE(this.persistenceKey,e),s=new aC(e,t,n);this.setItem(r,s.zs())}Ro(e){const t=JSON.stringify(Array.from(e));this.setItem(this.ao,t)}Vo(e){const t=this.io.exec(e);return t?t[1]:null}fo(e,t){const n=this.Vo(e);return aN.Gs(n,t)}po(e,t){const n=this.so.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return aS.Gs(new f(s),r,t)}wo(e,t){const n=this.oo.exec(e),r=Number(n[1]);return aC.Gs(r,t)}co(e){return aD.Gs(e)}Do(e){return JSON.parse(e)}async yo(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);w(ax,`Ignoring mutation for non-active user ${e.user.uid}`)}bo(e){return this.syncEngine.Fo(e.targetId,e.state,e.error)}mo(e,t){const n=t?this.Xs.insert(e,t):this.Xs.remove(e),r=this.ho(this.Xs),s=this.ho(n),i=[],o=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||o.push(e)}),this.syncEngine.Mo(i,o).then(()=>{this.Xs=n})}lo(e){this.Xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ho(e){let t=r$();return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class aR{constructor(){this.xo=new ak,this.Oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.xo.js(e),this.Oo[e]||"not-current"}updateQueryState(e,t,n){this.Oo[e]=t}removeLocalQueryTarget(e){this.xo.Hs(e)}isLocalQueryTarget(e){return this.xo.activeTargetIds.has(e)}clearQueryState(e){delete this.Oo[e]}getAllActiveQueryTargets(){return this.xo.activeTargetIds}isActiveQueryTarget(e){return this.xo.activeTargetIds.has(e)}start(){return this.xo=new ak,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class aV{No(e){}shutdown(){}}const aM="ConnectivityMonitor";class aF{constructor(){this.Bo=()=>this.Lo(),this.ko=()=>this.qo(),this.Qo=[],this.$o()}No(e){this.Qo.push(e)}shutdown(){window.removeEventListener("online",this.Bo),window.removeEventListener("offline",this.ko)}$o(){window.addEventListener("online",this.Bo),window.addEventListener("offline",this.ko)}Lo(){w(aM,"Network connectivity changed: AVAILABLE");for(const e of this.Qo)e(0)}qo(){w(aM,"Network connectivity changed: UNAVAILABLE");for(const e of this.Qo)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let aO=null;function aP(){return null===aO?aO=function e(){return 0x10000000+Math.round(0x80000000*Math.random())}():aO++,"0x"+aO.toString(16)}const aL="RestConnection",aq={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class aU{get Uo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Ko=t+"://"+e.host,this.Wo=`projects/${n}/databases/${r}`,this.Go=this.databaseId.database===nl?`project_id=${n}`:`project_id=${n}&database_id=${r}`}zo(e,t,n,r,s){const i=aP(),a=this.jo(e,t.toUriEncodedString());w(aL,`Sending RPC '${e}' ${i}:`,a,n);const u={"google-cloud-resource-prefix":this.Wo,"x-goog-request-params":this.Go};this.Ho(u,r,s);const{host:c}=new URL(a),l=(0,o.zJ)(c);return this.Jo(e,a,u,n,l).then(t=>(w(aL,`Received RPC '${e}' ${i}: `,t),t),t=>{throw I(aL,`RPC '${e}' ${i} failed with error: `,t,"url: ",a,"request:",n),t})}Yo(e,t,n,r,s,i){return this.zo(e,t,n,r,s)}Ho(e,t,n){e["X-Goog-Api-Client"]=function e(){return"gl-js/ fire/"+m}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}jo(e,t){const n=aq[e];return`${this.Ko}/v1/${t}:${n}`}terminate(){}}class aB{constructor(e){this.Zo=e.Zo,this.Xo=e.Xo}e_(e){this.t_=e}n_(e){this.r_=e}i_(e){this.s_=e}onMessage(e){this.o_=e}close(){this.Xo()}send(e){this.Zo(e)}__(){this.t_()}a_(){this.r_()}u_(e){this.s_(e)}c_(e){this.o_(e)}}const az="WebChannelConnection";class a$ extends aU{constructor(e){super(e),this.l_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,n,r,s){const i=aP();return new Promise((s,o)=>{const a=new u.ZS;a.setWithCredentials(!0),a.listenOnce(u.Bx.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case u.O4.NO_ERROR:const t=a.getResponseJson();w(az,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case u.O4.TIMEOUT:w(az,`RPC '${e}' ${i} timed out`),o(new N(C.DEADLINE_EXCEEDED,"Request time out"));break;case u.O4.HTTP_ERROR:const n=a.getStatus();if(w(az,`RPC '${e}' ${i} failed with status:`,n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function e(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(C).indexOf(t)>=0?t:C.UNKNOWN}(t.status);o(new N(e,t.message))}else o(new N(C.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new N(C.UNAVAILABLE,"Connection failed."));break;default:T(9055,{h_:e,streamId:i,P_:a.getLastErrorCode(),T_:a.getLastError()})}}finally{w(az,`RPC '${e}' ${i} completed.`)}});const c=JSON.stringify(r);w(az,`RPC '${e}' ${i} sending request:`,r),a.send(t,"POST",c,n,15)})}I_(e,t,n){const r=aP(),s=[this.Ko,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,u.fF)(),o=(0,u.Ao)(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Ho(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=s.join("");w(az,`Creating RPC '${e}' stream ${r}: ${l}`,a);const h=i.createWebChannel(l,a);this.E_(h);let d=!1,f=!1;const m=new aB({Zo:t=>{f?w(az,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(w(az,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),w(az,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},Xo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,u.iO.EventType.OPEN,()=>{f||(w(az,`RPC '${e}' stream ${r} transport opened.`),m.__())}),g(h,u.iO.EventType.CLOSE,()=>{f||(f=!0,w(az,`RPC '${e}' stream ${r} transport closed`),m.u_(),this.d_(h))}),g(h,u.iO.EventType.ERROR,t=>{f||(f=!0,I(az,`RPC '${e}' stream ${r} transport errored. Name:`,t.name,"Message:",t.message),m.u_(new N(C.UNAVAILABLE,"The operation could not be completed")))}),g(h,u.iO.EventType.MESSAGE,t=>{var n;if(!f){const s=t.data[0];E(!!s,16349);const i=s,o=(null==i?void 0:i.error)||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){w(az,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function e(e){const t=sw[e];if(void 0!==t)return s_(t)}(t),s=o.message;void 0===n&&(n=C.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,m.u_(new N(n,s)),h.close()}else w(az,`RPC '${e}' stream ${r} received:`,s),m.c_(s)}}),g(o,u.Jh.STAT_EVENT,t=>{t.stat===u.ro.PROXY?w(az,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===u.ro.NOPROXY&&w(az,`RPC '${e}' stream ${r} detected no buffering proxy`)}),setTimeout(()=>{m.a_()},0),m}terminate(){this.l_.forEach(e=>e.close()),this.l_=[]}E_(e){this.l_.push(e)}d_(e){this.l_=this.l_.filter(t=>t===e)}}function aK(){return"undefined"!=typeof window?window:null}function aG(){return"undefined"!=typeof document?document:null}function aQ(e){return new sU(e,!0)}class aj{constructor(e,t,n=1e3,r=1.5,s=6e4){this.xi=e,this.timerId=t,this.A_=n,this.R_=r,this.V_=s,this.m_=0,this.f_=null,this.g_=Date.now(),this.reset()}reset(){this.m_=0}p_(){this.m_=this.V_}y_(e){this.cancel();const t=Math.floor(this.m_+this.w_()),n=Math.max(0,Date.now()-this.g_),r=Math.max(0,t-n);r>0&&w("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.m_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.f_=this.xi.enqueueAfterDelay(this.timerId,r,()=>(this.g_=Date.now(),e())),this.m_*=this.R_,this.m_<this.A_&&(this.m_=this.A_),this.m_>this.V_&&(this.m_=this.V_)}b_(){null!==this.f_&&(this.f_.skipDelay(),this.f_=null)}cancel(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}w_(){return(Math.random()-.5)*this.m_}}const aW="PersistentStream";class aY{constructor(e,t,n,r,s,i,o,a){this.xi=e,this.S_=n,this.D_=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.v_=0,this.C_=null,this.F_=null,this.stream=null,this.M_=0,this.x_=new aj(e,t)}O_(){return 1===this.state||5===this.state||this.N_()}N_(){return 2===this.state||3===this.state}start(){this.M_=0,4!==this.state?this.auth():this.B_()}async stop(){this.O_()&&await this.close(0)}L_(){this.state=0,this.x_.reset()}k_(){this.N_()&&null===this.C_&&(this.C_=this.xi.enqueueAfterDelay(this.S_,6e4,()=>this.q_()))}Q_(e){this.U_(),this.stream.send(e)}async q_(){if(this.N_())return this.close(0)}U_(){this.C_&&(this.C_.cancel(),this.C_=null)}K_(){this.F_&&(this.F_.cancel(),this.F_=null)}async close(e,t){this.U_(),this.K_(),this.x_.cancel(),this.v_++,4!==e?this.x_.reset():t&&t.code===C.RESOURCE_EXHAUSTED?(v(t.toString()),v("Using maximum backoff delay to prevent overloading the backend."),this.x_.p_()):t&&t.code===C.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.W_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.i_(t)}W_(){}auth(){this.state=1;const e=this.G_(this.v_),t=this.v_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.v_===t&&this.z_(e,n)},t=>{e(()=>{const e=new N(C.UNKNOWN,"Fetching auth token failed: "+t.message);return this.j_(e)})})}z_(e,t){const n=this.G_(this.v_);this.stream=this.H_(e,t),this.stream.e_(()=>{n(()=>this.listener.e_())}),this.stream.n_(()=>{n(()=>(this.state=2,this.F_=this.xi.enqueueAfterDelay(this.D_,1e4,()=>(this.N_()&&(this.state=3),Promise.resolve())),this.listener.n_()))}),this.stream.i_(e=>{n(()=>this.j_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.M_?this.J_(e):this.onNext(e))})}B_(){this.state=5,this.x_.y_(async()=>{this.state=0,this.start()})}j_(e){return w(aW,`close with error: ${e}`),this.stream=null,this.close(4,e)}G_(e){return t=>{this.xi.enqueueAndForget(()=>this.v_===e?t():(w(aW,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aH extends aY{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}H_(e,t){return this.connection.I_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.x_.reset();const t=s3(this.serializer,e),n=function e(e){if(!("targetChange"in e))return J.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?J.min():t.readTime?sG(t.readTime):J.min()}(e);return this.listener.Y_(t,n)}Z_(e){const t={};t.database=sZ(this.serializer),t.addTarget=function e(e,t){let n;const r=t.target;if(n=ru(r)?{documents:s9(e,r)}:{query:s7(e,r).gt},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=s$(e,t.resumeToken);const r=sB(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(J.min())>0){n.readTime=sz(e,t.snapshotVersion.toTimestamp());const r=sB(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=ir(this.serializer,e);n&&(t.labels=n),this.Q_(t)}X_(e){const t={};t.database=sZ(this.serializer),t.removeTarget=e,this.Q_(t)}}class aJ extends aY{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}get ea(){return this.M_>0}start(){this.lastStreamToken=void 0,super.start()}W_(){this.ea&&this.ta([])}H_(e,t){return this.connection.I_("Write",e,t)}J_(e){return E(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,E(!e.writeResults||0===e.writeResults.length,55816),this.listener.na()}onNext(e){E(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.x_.reset();const t=s8(e.writeResults,e.commitTime),n=sG(e.commitTime);return this.listener.ra(n,t)}ia(){const e={};e.database=sZ(this.serializer),this.Q_(e)}ta(e){const t={streamToken:this.lastStreamToken,writes:e.map(e=>s6(this.serializer,e))};this.Q_(t)}}class aX{}class aZ extends aX{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.sa=!1}oa(){if(this.sa)throw new N(C.FAILED_PRECONDITION,"The client has already been terminated.")}zo(e,t,n,r){return this.oa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,i])=>this.connection.zo(e,sj(t,n),r,s,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(C.UNKNOWN,e.toString())})}Yo(e,t,n,r,s){return this.oa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,o])=>this.connection.Yo(e,sj(t,n),r,i,o,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(C.UNKNOWN,e.toString())})}terminate(){this.sa=!0,this.connection.terminate()}}class a0{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this._a=0,this.aa=null,this.ua=!0}ca(){0===this._a&&(this.la("Unknown"),this.aa=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.aa=null,this.ha("Backend didn't respond within 10 seconds."),this.la("Offline"),Promise.resolve())))}Pa(e){"Online"===this.state?this.la("Unknown"):(this._a++,this._a>=1&&(this.Ta(),this.ha(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.la("Offline")))}set(e){this.Ta(),this._a=0,"Online"===e&&(this.ua=!1),this.la(e)}la(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}ha(e){const t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ua?(v(t),this.ua=!1):w("OnlineStateTracker",t)}Ta(){null!==this.aa&&(this.aa.cancel(),this.aa=null)}}const a1="RemoteStore";class a2{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ia=[],this.Ea=new Map,this.da=new Set,this.Aa=[],this.Ra=s,this.Ra.No(e=>{n.enqueueAndForget(async()=>{ut(this)&&(w(a1,"Restarting streams for network reachability change."),await async function e(e){const t=S(e);t.da.add(4),await a3(t),t.Va.set("Unknown"),t.da.delete(4),await a4(t)}(this))})}),this.Va=new a0(n,r)}}async function a4(e){if(ut(e))for(const t of e.Aa)await t(!0)}async function a3(e){for(const t of e.Aa)await t(!1)}function a6(e,t){const n=S(e);n.Ea.has(t.targetId)||(n.Ea.set(t.targetId,t),ue(n)?a7(n):uI(n).N_()&&a8(n,t))}function a5(e,t){const n=S(e),r=uI(n);n.Ea.delete(t),r.N_()&&a9(n,t),0===n.Ea.size&&(r.N_()?r.k_():ut(n)&&n.Va.set("Unknown"))}function a8(e,t){if(e.ma.Ke(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(J.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}uI(e).Z_(t)}function a9(e,t){e.ma.Ke(t),uI(e).X_(t)}function a7(e){e.ma=new sM({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Rt:t=>e.Ea.get(t)||null,Pt:()=>e.datastore.serializer.databaseId}),uI(e).start(),e.Va.ca()}function ue(e){return ut(e)&&!uI(e).O_()&&e.Ea.size>0}function ut(e){return 0===S(e).da.size}function un(e){e.ma=void 0}async function ur(e){e.Va.set("Online")}async function us(e){e.Ea.forEach((t,n)=>{a8(e,t)})}async function ui(e,t){un(e),ue(e)?(e.Va.Pa(t),a7(e)):e.Va.set("Unknown")}async function uo(e,t,n){if(e.Va.set("Online"),t instanceof sR&&2===t.state&&t.cause)try{await async function e(e,t){const n=t.cause;for(const r of t.targetIds)e.Ea.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ea.delete(r),e.ma.removeTarget(r))}(e,t)}catch(n){w(a1,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await ua(e,n)}else if(t instanceof sk?e.ma.Xe(t):t instanceof sA?e.ma.ot(t):e.ma.nt(t),!n.isEqual(J.min()))try{const t=await aa(e.localStore);n.compareTo(t)>=0&&await function e(e,t){const n=e.ma.It(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.Ea.get(r);s&&e.Ea.set(r,s.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{const r=e.Ea.get(t);if(!r)return;e.Ea.set(t,r.withResumeToken(t8.EMPTY_BYTE_STRING,r.snapshotVersion)),a9(e,t);const s=new im(r.target,t,n,r.sequenceNumber);a8(e,s)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){w(a1,"Failed to raise snapshot:",t),await ua(e,t)}}async function ua(e,t,n){if(!eS(t))throw t;e.da.add(1),await a3(e),e.Va.set("Offline"),n||(n=()=>aa(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{w(a1,"Retrying IndexedDB access"),await n(),e.da.delete(1),await a4(e)})}function uu(e,t){return t().catch(n=>ua(e,n,t))}async function uc(e){const t=S(e),n=u_(t);let r=t.Ia.length>0?t.Ia[t.Ia.length-1].batchId:eF;for(;ul(t);)try{const e=await al(t.localStore,r);if(null===e){0===t.Ia.length&&n.k_();break}r=e.batchId,uh(t,e)}catch(e){await ua(t,e)}ud(t)&&uf(t)}function ul(e){return ut(e)&&e.Ia.length<10}function uh(e,t){e.Ia.push(t);const n=u_(e);n.N_()&&n.ea&&n.ta(t.mutations)}function ud(e){return ut(e)&&!u_(e).O_()&&e.Ia.length>0}function uf(e){u_(e).start()}async function um(e){u_(e).ia()}async function ug(e){const t=u_(e);for(const n of e.Ia)t.ta(n.mutations)}async function up(e,t,n){const r=e.Ia.shift(),s=sm.from(r,t,n);await uu(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await uc(e)}async function uy(e,t){t&&u_(e).ea&&await async function e(e,t){if(function e(e){return sI(e)&&e!==C.ABORTED}(t.code)){const n=e.Ia.shift();u_(e).L_(),await uu(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await uc(e)}}(e,t),ud(e)&&uf(e)}async function uw(e,t){const n=S(e);n.asyncQueue.verifyOperationInProgress(),w(a1,"RemoteStore received new credentials");const r=ut(n);n.da.add(3),await a3(n),r&&n.Va.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.da.delete(3),await a4(n)}async function uv(e,t){const n=S(e);t?(n.da.delete(2),await a4(n)):t||(n.da.add(2),await a3(n),n.Va.set("Unknown"))}function uI(e){return e.fa||(e.fa=function e(e,t,n){const r=S(e);return r.oa(),new aH(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{e_:ur.bind(null,e),n_:us.bind(null,e),i_:ui.bind(null,e),Y_:uo.bind(null,e)}),e.Aa.push(async t=>{t?(e.fa.L_(),ue(e)?a7(e):e.Va.set("Unknown")):(await e.fa.stop(),un(e))})),e.fa}function u_(e){return e.ga||(e.ga=function e(e,t,n){const r=S(e);return r.oa(),new aJ(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{e_:()=>Promise.resolve(),n_:um.bind(null,e),i_:uy.bind(null,e),na:ug.bind(null,e),ra:up.bind(null,e)}),e.Aa.push(async t=>{t?(e.ga.L_(),await uc(e)):(await e.ga.stop(),e.Ia.length>0&&(w(a1,`Stopping write stream with ${e.Ia.length} pending writes`),e.Ia=[]))})),e.ga}class uT{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new D,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new uT(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(C.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ub(e,t){if(v("AsyncQueue",`${t}: ${e}`),eS(e))return new N(C.UNAVAILABLE,`${t}: ${e}`);throw e}class uE{static emptySet(e){return new uE(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||er.comparator(t.key,n.key):(e,t)=>er.comparator(e.key,t.key),this.keyedMap=rM(),this.sortedSet=new tX(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof uE))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new uE;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ux{constructor(){this.pa=new tX(er.comparator)}track(e){const t=e.doc.key,n=this.pa.get(t);n?0!==e.type&&3===n.type?this.pa=this.pa.insert(t,e):3===e.type&&1!==n.type?this.pa=this.pa.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.pa=this.pa.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.pa=this.pa.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.pa=this.pa.remove(t):1===e.type&&2===n.type?this.pa=this.pa.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.pa=this.pa.insert(t,{type:2,doc:e.doc}):T(63341,{Vt:e,ya:n}):this.pa=this.pa.insert(t,e)}wa(){const e=[];return this.pa.inorderTraversal((t,n)=>{e.push(n)}),e}}class uS{constructor(e,t,n,r,s,i,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new uS(e,t,uE.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&rb(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class uC{constructor(){this.ba=void 0,this.Sa=[]}Da(){return this.Sa.some(e=>e.va())}}class uN{constructor(){this.queries=uD(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function e(e,t){const n=S(e),r=n.queries;n.queries=uD(),r.forEach((e,n)=>{for(const e of n.Sa)e.onError(t)})}(this,new N(C.ABORTED,"Firestore shutting down"))}}function uD(){return new rk(e=>rE(e),rb)}async function uk(e,t){const n=S(e);let r=3;const s=t.query;let i=n.queries.get(s);i?!i.Da()&&t.va()&&(r=2):(i=new uC,r=t.va()?0:1);try{switch(r){case 0:i.ba=await n.onListen(s,!0);break;case 1:i.ba=await n.onListen(s,!1);break;case 2:await n.onFirstRemoteStoreListen(s)}}catch(n){const e=ub(n,`Initialization of query '${rx(t.query)}' failed`);return void t.onError(e)}if(n.queries.set(s,i),i.Sa.push(t),t.Fa(n.onlineState),i.ba){t.Ma(i.ba)&&uM(n)}}async function uA(e,t){const n=S(e),r=t.query;let s=3;const i=n.queries.get(r);if(i){const e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?s=t.va()?0:1:!i.Da()&&t.va()&&(s=2))}switch(s){case 0:return n.queries.delete(r),n.onUnlisten(r,!0);case 1:return n.queries.delete(r),n.onUnlisten(r,!1);case 2:return n.onLastRemoteStoreUnlisten(r);default:return}}function uR(e,t){const n=S(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.Sa)t.Ma(e)&&(r=!0);s.ba=e}}r&&uM(n)}function uV(e,t,n){const r=S(e),s=r.queries.get(t);if(s)for(const e of s.Sa)e.onError(n);r.queries.delete(t)}function uM(e){e.Ca.forEach(e=>{e.next()})}var uF,uO;(uO=uF||(uF={})).xa="default",uO.Cache="cache";class uP{constructor(e,t,n){this.query=e,this.Oa=t,this.Na=!1,this.Ba=null,this.onlineState="Unknown",this.options=n||{}}Ma(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new uS(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Na?this.La(e)&&(this.Oa.next(e),t=!0):this.ka(e,this.onlineState)&&(this.qa(e),t=!0),this.Ba=e,t}onError(e){this.Oa.error(e)}Fa(e){this.onlineState=e;let t=!1;return this.Ba&&!this.Na&&this.ka(this.Ba,e)&&(this.qa(this.Ba),t=!0),t}ka(e,t){if(!e.fromCache)return!0;if(!this.va())return!0;const n="Offline"!==t;return(!this.options.Qa||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}La(e){if(e.docChanges.length>0)return!0;const t=this.Ba&&this.Ba.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}qa(e){e=uS.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Na=!0,this.Oa.next(e)}va(){return this.options.source!==uF.Cache}}class uL{constructor(e,t){this.$a=e,this.byteLength=t}Ua(){return"metadata"in this.$a}}class uq{constructor(e){this.serializer=e}Us(e){return sH(this.serializer,e)}Ks(e){return e.metadata.exists?s2(this.serializer,e.document,!1):n$.newNoDocument(this.Us(e.metadata.name),this.Ws(e.metadata.readTime))}Ws(e){return sG(e)}}class uU{constructor(e,t,n){this.Ka=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=uB(e)}Wa(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.$a.namedQuery)this.queries.push(e.$a.namedQuery);else if(e.$a.documentMetadata){this.documents.push({metadata:e.$a.documentMetadata}),e.$a.documentMetadata.exists||++t;const n=ee.fromString(e.$a.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.$a.document&&(this.documents[this.documents.length-1].document=e.$a.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Ga(e){const t=new Map,n=new uq(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.Us(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||rB()).add(e);t.set(n,r)}}return t}async complete(){const e=await ay(this.localStore,new uq(this.serializer),this.documents,this.Ka.id),t=this.Ga(this.documents);for(const e of this.queries)await aw(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,za:this.collectionGroups,ja:e}}}function uB(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class uz{constructor(e){this.key=e}}class u${constructor(e){this.key=e}}class uK{constructor(e,t){this.query=e,this.Ha=t,this.Ja=null,this.hasCachedResults=!1,this.current=!1,this.Ya=rB(),this.mutatedKeys=rB(),this.Za=rN(e),this.Xa=new uE(this.Za)}get eu(){return this.Ha}tu(e,t){const n=t?t.nu:new ux,r=t?t.Xa:this.Xa;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{const c=r.get(e),l=rS(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;if(c&&l){c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.ru(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Za(l,a)>0||u&&this.Za(l,u)<0)&&(o=!0))}else!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0));f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))}),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Xa:i,nu:n,Cs:o,mutatedKeys:s}}ru(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.Xa;this.Xa=e.Xa,this.mutatedKeys=e.mutatedKeys;const i=e.nu.wa();i.sort((e,t)=>(function e(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return T(20277,{Vt:e})}};return n(e)-n(t)})(e.type,t.type)||this.Za(e.doc,t.doc)),this.iu(n),r=null!=r&&r;const o=t&&!r?this.su():[],a=0===this.Ya.size&&this.current&&!r?1:0,u=a!==this.Ja;if(this.Ja=a,0!==i.length||u){return{snapshot:new uS(this.query,e.Xa,s,i,e.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),ou:o}}return{ou:o}}Fa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Xa:this.Xa,nu:new ux,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{ou:[]}}_u(e){return!this.Ha.has(e)&&!!this.Xa.has(e)&&!this.Xa.get(e).hasLocalMutations}iu(e){e&&(e.addedDocuments.forEach(e=>this.Ha=this.Ha.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ha=this.Ha.delete(e)),this.current=e.current)}su(){if(!this.current)return[];const e=this.Ya;this.Ya=rB(),this.Xa.forEach(e=>{this._u(e.key)&&(this.Ya=this.Ya.add(e.key))});const t=[];return e.forEach(e=>{this.Ya.has(e)||t.push(new u$(e))}),this.Ya.forEach(n=>{e.has(n)||t.push(new uz(n))}),t}au(e){this.Ha=e.$s,this.Ya=rB();const t=this.tu(e.documents);return this.applyChanges(t,!0)}uu(){return uS.fromInitialDocuments(this.query,this.Xa,this.mutatedKeys,0===this.Ja,this.hasCachedResults)}}const uG="SyncEngine";class uQ{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class uj{constructor(e){this.key=e,this.cu=!1}}class uW{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.lu={},this.hu=new rk(e=>rE(e),rb),this.Pu=new Map,this.Tu=new Set,this.Iu=new tX(er.comparator),this.Eu=new Map,this.du=new oB,this.Au={},this.Ru=new Map,this.Vu=of.lr(),this.onlineState="Unknown",this.mu=void 0}get isPrimaryClient(){return!0===this.mu}}async function uY(e,t,n=!0){const r=cy(e);let s;const i=r.hu.get(t);return i?(r.sharedClientState.addLocalQueryTarget(i.targetId),s=i.view.uu()):s=await uJ(r,t,n,!0),s}async function uH(e,t){const n=cy(e);await uJ(n,t,!0,!1)}async function uJ(e,t,n,r){const s=await ah(e.localStore,rw(t)),i=s.targetId,o=e.sharedClientState.addLocalQueryTarget(i,n);let a;return r&&(a=await uX(e,t,i,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&a6(e.remoteStore,s),a}async function uX(e,t,n,r,s){e.fu=(t,n,r)=>(async function e(e,t,n,r){let s=t.view.tu(n);s.Cs&&(s=await af(e.localStore,t.query,!1).then(({documents:e})=>t.view.tu(e,s)));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return cn(e,t.targetId,a.ou),a.snapshot})(e,t,n,r);const i=await af(e.localStore,t,!0),o=new uK(t,i.$s),a=o.tu(i.documents),u=sD.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),c=o.applyChanges(a,e.isPrimaryClient,u);cn(e,n,c.ou);const l=new uQ(t,n,o);return e.hu.set(t,l),e.Pu.has(n)?e.Pu.get(n).push(t):e.Pu.set(n,[t]),c.snapshot}async function uZ(e,t,n){const r=S(e),s=r.hu.get(t),i=r.Pu.get(s.targetId);if(i.length>1)return r.Pu.set(s.targetId,i.filter(e=>!rb(e,t))),void r.hu.delete(t);if(r.isPrimaryClient){r.sharedClientState.removeLocalQueryTarget(s.targetId);r.sharedClientState.isActiveQueryTarget(s.targetId)||await ad(r.localStore,s.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(s.targetId),n&&a5(r.remoteStore,s.targetId),ce(r,s.targetId)}).catch(ew)}else ce(r,s.targetId),await ad(r.localStore,s.targetId,!0)}async function u0(e,t){const n=S(e),r=n.hu.get(t),s=n.Pu.get(r.targetId);n.isPrimaryClient&&1===s.length&&(n.sharedClientState.removeLocalQueryTarget(r.targetId),a5(n.remoteStore,r.targetId))}async function u1(e,t,n){const r=cw(e);try{const e=await function e(e,t){const n=S(e),r=H.now(),s=t.reduce((e,t)=>e.add(t.key),rB());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",e=>{let a=rR(),u=rB();return n.Bs.getEntries(e,s).next(e=>{a=e,a.forEach((e,t)=>{t.isValidDocument()||(u=u.add(e))})}).next(()=>n.localDocuments.getOverlayedDocuments(e,a)).next(s=>{i=s;const o=[];for(const e of t){const t=ss(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new sa(e.key,t,nz(t.value.mapValue),r9.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)}).next(t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)})}).then(()=>({batchId:o.batchId,changes:rF(i)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function e(e,t,n){let r=e.Au[e.currentUser.toKey()];r||(r=new tX(z));r=r.insert(t,n),e.Au[e.currentUser.toKey()]=r}(r,e.batchId,n),await ci(r,e.changes),await uc(r.remoteStore)}catch(t){const e=ub(t,"Failed to persist write");n.reject(e)}}async function u2(e,t){const n=S(e);try{const e=await au(n.localStore,t);t.targetChanges.forEach((e,t)=>{const r=n.Eu.get(t);r&&(E(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1,22616),e.addedDocuments.size>0?r.cu=!0:e.modifiedDocuments.size>0?E(r.cu,14607):e.removedDocuments.size>0&&(E(r.cu,42227),r.cu=!1))}),await ci(n,e,t)}catch(e){await ew(e)}}function u4(e,t,n){const r=S(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.hu.forEach((n,r)=>{const s=r.view.Fa(t);s.snapshot&&e.push(s.snapshot)}),function e(e,t){const n=S(e);n.onlineState=t;let r=!1;n.queries.forEach((e,n)=>{for(const e of n.Sa)e.Fa(t)&&(r=!0)}),r&&uM(n)}(r.eventManager,t),e.length&&r.lu.Y_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function u3(e,t,n){const r=S(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Eu.get(t),i=s&&s.key;if(i){let e=new tX(er.comparator);e=e.insert(i,n$.newNoDocument(i,J.min()));const n=rB().add(i),s=new sN(J.min(),new Map,new tX(z),e,n);await u2(r,s),r.Iu=r.Iu.remove(i),r.Eu.delete(t),cs(r)}else await ad(r.localStore,t,!1).then(()=>ce(r,t,n)).catch(ew)}async function u6(e,t){const n=S(e),r=t.batch.batchId;try{const e=await ao(n.localStore,t);u7(n,r,null),u9(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ci(n,e)}catch(e){await ew(e)}}async function u5(e,t,n){const r=S(e);try{const e=await function e(e,t){const n=S(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(E(null!==t,37113),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))})}(r.localStore,t);u7(r,t,n),u9(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await ci(r,e)}catch(e){await ew(e)}}async function u8(e,t){const n=S(e);ut(n.remoteStore)||w(uG,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function e(e){const t=S(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}(n.localStore);if(e===eF)return void t.resolve();const r=n.Ru.get(e)||[];r.push(t),n.Ru.set(e,r)}catch(n){const e=ub(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function u9(e,t){(e.Ru.get(t)||[]).forEach(e=>{e.resolve()}),e.Ru.delete(t)}function u7(e,t,n){const r=S(e);let s=r.Au[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Au[r.currentUser.toKey()]=s}}function ce(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Pu.get(t))e.hu.delete(r),n&&e.lu.gu(r,n);if(e.Pu.delete(t),e.isPrimaryClient){e.du.Hr(t).forEach(t=>{e.du.containsKey(t)||ct(e,t)})}}function ct(e,t){e.Tu.delete(t.path.canonicalString());const n=e.Iu.get(t);null!==n&&(a5(e.remoteStore,n),e.Iu=e.Iu.remove(t),e.Eu.delete(n),cs(e))}function cn(e,t,n){for(const r of n)if(r instanceof uz)e.du.addReference(r.key,t),cr(e,r);else if(r instanceof u$){w(uG,"Document no longer in limbo: "+r.key),e.du.removeReference(r.key,t);e.du.containsKey(r.key)||ct(e,r.key)}else T(19791,{pu:r})}function cr(e,t){const n=t.key,r=n.path.canonicalString();e.Iu.get(n)||e.Tu.has(r)||(w(uG,"New document in limbo: "+n),e.Tu.add(r),cs(e))}function cs(e){for(;e.Tu.size>0&&e.Iu.size<e.maxConcurrentLimboResolutions;){const t=e.Tu.values().next().value;e.Tu.delete(t);const n=new er(ee.fromString(t)),r=e.Vu.next();e.Eu.set(r,new uj(n)),e.Iu=e.Iu.insert(n,r),a6(e.remoteStore,new im(rw(rm(n.path)),r,"TargetPurposeLimboResolution",eM.le))}}async function ci(e,t,n){const r=S(e),s=[],i=[],o=[];r.hu.isEmpty()||(r.hu.forEach((e,a)=>{o.push(r.fu(a,t,n).then(e=>{var t;if((e||n)&&r.isPrimaryClient){const s=e?!e.fromCache:null===(t=null==n?void 0:n.targetChanges.get(a.targetId))||void 0===t?void 0:t.current;r.sharedClientState.updateQueryState(a.targetId,s?"current":"not-current")}if(e){s.push(e);const t=o9.Rs(a.targetId,e);i.push(t)}}))}),await Promise.all(o),r.lu.Y_(s),await async function e(e,t){const n=S(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",e=>ev.forEach(t,t=>ev.forEach(t.ds,r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r)).next(()=>ev.forEach(t.As,r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))}catch(e){if(!eS(e))throw e;w(at,"Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.xs.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.xs=n.xs.insert(t,s)}}}(r.localStore,i))}async function co(e,t){const n=S(e);if(!n.currentUser.isEqual(t)){w(uG,"User change. New user:",t.toKey());const e=await ai(n.localStore,t);n.currentUser=t,function e(e,t){e.Ru.forEach(e=>{e.forEach(e=>{e.reject(new N(C.CANCELLED,t))})}),e.Ru.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await ci(n,e.ks)}}function ca(e,t){const n=S(e),r=n.Eu.get(t);if(r&&r.cu)return rB().add(r.key);{let e=rB();const r=n.Pu.get(t);if(!r)return e;for(const t of r){const r=n.hu.get(t);e=e.unionWith(r.view.eu)}return e}}async function cu(e,t){const n=S(e),r=await af(n.localStore,t.query,!0),s=t.view.au(r);return n.isPrimaryClient&&cn(n,t.targetId,s.ou),s}async function cc(e,t){const n=S(e);return ag(n.localStore,t).then(e=>ci(n,e))}async function cl(e,t,n,r){const s=S(e),i=await function e(e,t){const n=S(e),r=S(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",e=>r.tr(e,t).next(t=>t?n.localDocuments.getDocuments(e,t):ev.resolve(null)))}(s.localStore,t);null!==i?("pending"===n?await uc(s.remoteStore):"acknowledged"===n||"rejected"===n?(u7(s,t,r||null),u9(s,t),function e(e,t){S(S(e).mutationQueue).sr(t)}(s.localStore,t)):T(6720,"Unknown batchState",{yu:n}),await ci(s,i)):w(uG,"Cannot apply mutation batch with id: "+t)}async function ch(e,t){const n=S(e);if(cy(n),cw(n),!0===t&&!0!==n.mu){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await cd(n,e.toArray());n.mu=!0,await uv(n.remoteStore,!0);for(const e of t)a6(n.remoteStore,e)}else if(!1===t&&!1!==n.mu){const e=[];let t=Promise.resolve();n.Pu.forEach((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then(()=>(ce(n,s),ad(n.localStore,s,!0))),a5(n.remoteStore,s)}),await t,await cd(n,e),function e(e){const t=S(e);t.Eu.forEach((e,n)=>{a5(t.remoteStore,n)}),t.du.Jr(),t.Eu=new Map,t.Iu=new tX(er.comparator)}(n),n.mu=!1,await uv(n.remoteStore,!1)}}async function cd(e,t,n){const r=S(e),s=[],i=[];for(const e of t){let t;const n=r.Pu.get(e);if(n&&0!==n.length){t=await ah(r.localStore,rw(n[0]));for(const e of n){const t=r.hu.get(e),n=await cu(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await am(r.localStore,e);t=await ah(r.localStore,n),await uX(r,cf(n),e,!1,t.resumeToken)}s.push(t)}return r.lu.Y_(i),s}function cf(e){return rf(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function cm(e){return function e(e){return S(S(e).persistence).Is()}(S(e).localStore)}async function cg(e,t,n,r){const s=S(e);if(s.mu)return void w(uG,"Ignoring unexpected query state notification.");const i=s.Pu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await ag(s.localStore,rC(i[0])),r=sN.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,t8.EMPTY_BYTE_STRING);await ci(s,e,r);break}case"rejected":await ad(s.localStore,t,!0),ce(s,t,r);break;default:T(64155,n)}}async function cp(e,t,n){const r=cy(e);if(r.mu){for(const e of t){if(r.Pu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){w(uG,"Adding an already active target "+e);continue}const t=await am(r.localStore,e),n=await ah(r.localStore,t);await uX(r,cf(t),n.targetId,!1,n.resumeToken),a6(r.remoteStore,n)}for(const e of n)r.Pu.has(e)&&await ad(r.localStore,e,!1).then(()=>{a5(r.remoteStore,e),ce(r,e)}).catch(ew)}}function cy(e){const t=S(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=u2.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=ca.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=u3.bind(null,t),t.lu.Y_=uR.bind(null,t.eventManager),t.lu.gu=uV.bind(null,t.eventManager),t}function cw(e){const t=S(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=u6.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=u5.bind(null,t),t}function cv(e,t,n){const r=S(e);(async function e(e,t,n){try{const r=await t.getMetadata();if(await function e(e,t){const n=S(e),r=sG(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ei.getBundleMetadata(e,t.id)).then(e=>!!e&&e.createTime.compareTo(r)>=0)}(e.localStore,r))return await t.close(),n._completeWith(function e(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(uB(r));const s=new uU(r,e.localStore,t.serializer);let i=await t.wu();for(;i;){const e=await s.Wa(i);e&&n._updateProgress(e),i=await t.wu()}const o=await s.complete();return await ci(e,o.ja,void 0),await function e(e,t){const n=S(e);return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ei.saveBundleMetadata(e,t))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.za)}catch(e){return I(uG,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}class cI{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=aQ(e.databaseInfo.databaseId),this.sharedClientState=this.bu(e),this.persistence=this.Su(e),await this.persistence.start(),this.localStore=this.Du(e),this.gcScheduler=this.vu(e,this.localStore),this.indexBackfillerScheduler=this.Cu(e,this.localStore)}vu(e,t){return null}Cu(e,t){return null}Du(e){return as(this.persistence,new ae,e.initialUser,this.serializer)}Su(e){return new oj(oY.fi,this.serializer)}bu(e){return new aR}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}cI.provider={build:()=>new cI};class c_ extends cI{constructor(e){super(),this.cacheSizeBytes=e}vu(e,t){E(this.persistence.referenceDelegate instanceof oH,46915);const n=this.persistence.referenceDelegate.garbageCollector;return new oT(n,e.asyncQueue,t)}Su(e){const t=void 0!==this.cacheSizeBytes?oi.withCacheSize(this.cacheSizeBytes):oi.DEFAULT;return new oj(e=>oH.fi(e,t),this.serializer)}}class cT extends cI{constructor(e,t,n){super(),this.Fu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Fu.initialize(this,e),await cw(this.Fu.syncEngine),await uc(this.Fu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}Du(e){return as(this.persistence,new ae,e.initialUser,this.serializer)}vu(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new oT(n,e.asyncQueue,t)}Cu(e,t){const n=new eV(t,this.persistence);return new eR(e.asyncQueue,n)}Su(e){const t=o8(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?oi.withCacheSize(this.cacheSizeBytes):oi.DEFAULT;return new o3(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,aK(),aG(),this.serializer,this.sharedClientState,!!this.forceOwnership)}bu(e){return new aR}}class cb extends cT{constructor(e,t){super(e,t,!1),this.Fu=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Fu.syncEngine;this.sharedClientState instanceof aA&&(this.sharedClientState.syncEngine={Co:cl.bind(null,t),Fo:cg.bind(null,t),Mo:cp.bind(null,t),Is:cm.bind(null,t),vo:cc.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ji(async e=>{await ch(this.Fu.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}bu(e){const t=aK();if(!aA.C(t))throw new N(C.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=o8(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new aA(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class cE{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>u4(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=co.bind(null,this.syncEngine),await uv(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return function e(){return new uN}()}createDatastore(e){const t=aQ(e.databaseInfo.databaseId),n=function e(e){return new a$(e)}(e.databaseInfo);return function e(e,t,n,r){return new aZ(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function e(e,t,n,r,s){return new a2(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,e=>u4(this.syncEngine,e,0),function e(){return aF.C()?new aF:new aV}())}createSyncEngine(e,t){return function e(e,t,n,r,s,i,o){const a=new uW(e,t,n,r,s,i);return o&&(a.mu=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function e(e){const t=S(e);w(a1,"RemoteStore shutting down."),t.da.add(5),await a3(t),t.Ra.shutdown(),t.Va.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate(),null===(t=this.eventManager)||void 0===t||t.terminate()}}cE.provider={build:()=>new cE};function cx(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class cS{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Mu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Mu(this.observer.error,e):v("Uncaught Error in snapshot listener:",e.toString()))}xu(){this.muted=!0}Mu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class cC{constructor(e,t){this.Ou=e,this.serializer=t,this.metadata=new D,this.buffer=new Uint8Array,this.Nu=function e(){return new TextDecoder("utf-8")}(),this.Bu().then(e=>{e&&e.Ua()?this.metadata.resolve(e.$a.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(null==e?void 0:e.$a)}`))},e=>this.metadata.reject(e))}close(){return this.Ou.cancel()}async getMetadata(){return this.metadata.promise}async wu(){return await this.getMetadata(),this.Bu()}async Bu(){const e=await this.Lu();if(null===e)return null;const t=this.Nu.decode(e),n=Number(t);isNaN(n)&&this.ku(`length string (${t}) is not valid number`);const r=await this.qu(n);return new uL(JSON.parse(r),e.length+n)}Qu(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Lu(){for(;this.Qu()<0;){if(await this.$u())break}if(0===this.buffer.length)return null;const e=this.Qu();e<0&&this.ku("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async qu(e){for(;this.buffer.length<e;){await this.$u()&&this.ku("Reached the end of bundle when more is expected.")}const t=this.Nu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}ku(e){throw this.Ou.cancel(),new Error(`Invalid bundle format: ${e}`)}async $u(){const e=await this.Ou.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class cN{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new N(C.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function e(e,t){const n=S(e),r={documents:t.map(e=>sY(n.serializer,e))},s=await n.Yo("BatchGetDocuments",n.serializer.databaseId,ee.emptyPath(),r,t.length),i=new Map;s.forEach(e=>{const t=s4(n.serializer,e);i.set(t.key.toString(),t)});const o=[];return t.forEach(e=>{const t=i.get(e.toString());E(!!t,55234,{key:e}),o.push(t)}),o}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new sh(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{const n=er.fromPath(t);this.mutations.push(new sd(n,this.precondition(n)))}),await async function e(e,t){const n=S(e),r={writes:t.map(e=>s6(n.serializer,e))};await n.zo("Commit",n.serializer.databaseId,ee.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw T(50498,{Uu:e.constructor.name});t=J.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new N(C.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(J.min())?r9.exists(!1):r9.updateTime(t):r9.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(J.min()))throw new N(C.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return r9.updateTime(t)}return r9.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class cD{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Ku=n.maxAttempts,this.x_=new aj(this.asyncQueue,"transaction_retry")}Wu(){this.Ku-=1,this.Gu()}Gu(){this.x_.y_(async()=>{const e=new cN(this.datastore),t=this.zu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.ju(e)}))}).catch(e=>{this.ju(e)})})}zu(e){try{const t=this.updateFunction(e);return!eO(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}ju(e){this.Ku>0&&this.Hu(e)?(this.Ku-=1,this.asyncQueue.enqueueAndForget(()=>(this.Gu(),Promise.resolve()))):this.deferred.reject(e)}Hu(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!sI(t)}return!1}}const ck="FirestoreClient";class cA{constructor(e,t,n,r,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=f.UNAUTHENTICATED,this.clientId=B.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,async e=>{w(ck,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(w(ck,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new D;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){const t=ub(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function cR(e,t){e.asyncQueue.verifyOperationInProgress(),w(ck,"Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await ai(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function cV(e,t){e.asyncQueue.verifyOperationInProgress();const n=await cM(e);w(ck,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>uw(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>uw(t.remoteStore,n)),e._onlineComponents=t}async function cM(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){w(ck,"Using user provided OfflineComponentProvider");try{await cR(e,e._uninitializedComponentsProvider._offline)}catch(n){const t=n;if(!function e(e){return"FirebaseError"===e.name?e.code===C.FAILED_PRECONDITION||e.code===C.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}(t))throw t;I("Error using user provided cache. Falling back to memory cache: "+t),await cR(e,new cI)}}else w(ck,"Using default OfflineComponentProvider"),await cR(e,new c_(void 0));return e._offlineComponents}async function cF(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(w(ck,"Using user provided OnlineComponentProvider"),await cV(e,e._uninitializedComponentsProvider._online)):(w(ck,"Using default OnlineComponentProvider"),await cV(e,new cE))),e._onlineComponents}function cO(e){return cM(e).then(e=>e.persistence)}function cP(e){return cM(e).then(e=>e.localStore)}function cL(e){return cF(e).then(e=>e.remoteStore)}function cq(e){return cF(e).then(e=>e.syncEngine)}function cU(e){return cF(e).then(e=>e.datastore)}async function cB(e){const t=await cF(e),n=t.eventManager;return n.onListen=uY.bind(null,t.syncEngine),n.onUnlisten=uZ.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=uH.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=u0.bind(null,t.syncEngine),n}function cz(e){return e.asyncQueue.enqueue(async()=>{const t=await cO(e),n=await cL(e);return t.setNetworkEnabled(!0),function e(e){const t=S(e);return t.da.delete(0),a4(t)}(n)})}function c$(e){return e.asyncQueue.enqueue(async()=>{const t=await cO(e),n=await cL(e);return t.setNetworkEnabled(!1),async function e(e){const t=S(e);t.da.add(0),await a3(t),t.Va.set("Offline")}(n)})}function cK(e,t){const n=new D;return e.asyncQueue.enqueueAndForget(async()=>(async function e(e,t,n){try{const r=await function e(e,t){const n=S(e);return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new N(C.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){const e=ub(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await cP(e),t,n)),n.promise}function cG(e,t,n={}){const r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t,n,r,s){const i=new cS({next:a=>{i.xu(),t.enqueueAndForget(()=>uA(e,o));const u=a.docs.has(n);!u&&a.fromCache?s.reject(new N(C.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&a.fromCache&&r&&"server"===r.source?s.reject(new N(C.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(a)},error:e=>s.reject(e)}),o=new uP(rm(n.path),i,{includeMetadataChanges:!0,Qa:!0});return uk(e,o)})(await cB(e),e.asyncQueue,t,n,r)),r.promise}function cQ(e,t){const n=new D;return e.asyncQueue.enqueueAndForget(async()=>(async function e(e,t,n){try{const r=await af(e,t,!0),s=new uK(t,r.$s),i=s.tu(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(r){const e=ub(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await cP(e),t,n)),n.promise}function cj(e,t,n={}){const r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t,n,r,s){const i=new cS({next:n=>{i.xu(),t.enqueueAndForget(()=>uA(e,o)),n.fromCache&&"server"===r.source?s.reject(new N(C.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new uP(n,i,{includeMetadataChanges:!0,Qa:!0});return uk(e,o)})(await cB(e),e.asyncQueue,t,n,r)),r.promise}function cW(e,t,n){const r=new D;return e.asyncQueue.enqueueAndForget(async()=>{try{const s=await cU(e);r.resolve(async function e(e,t,n){var r;const s=S(e),{request:i,yt:o,parent:a}=ie(s.serializer,rv(t),n);s.connection.Uo||delete i.parent;const u=(await s.Yo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter(e=>!!e.result);E(1===u.length,64727);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce((e,t)=>(e[o[t]]=c[t],e),{})}(s,t,n))}catch(e){r.reject(e)}}),r.promise}function cY(e,t){const n=new cS(t);return e.asyncQueue.enqueueAndForget(async()=>(function e(e,t){S(e).Ca.add(t),t.next()})(await cB(e),n)),()=>{n.xu(),e.asyncQueue.enqueueAndForget(async()=>(function e(e,t){S(e).Ca.delete(t)})(await cB(e),n))}}function cH(e,t,n,r){const s=function e(e,t){let n;n="string"==typeof e?U().encode(e):e;return function e(e,t){return new cC(e,t)}(function e(e,t){if(e instanceof Uint8Array)return cx(e,t);if(e instanceof ArrayBuffer)return cx(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,aQ(t));e.asyncQueue.enqueueAndForget(async()=>{cv(await cq(e),s,r)})}function cJ(e,t){return e.asyncQueue.enqueue(async()=>(function e(e,t){const n=S(e);return n.persistence.runTransaction("Get named query","readonly",e=>n.Ei.getNamedQuery(e,t))})(await cP(e),t))}function cX(e,t){return e.asyncQueue.enqueue(async()=>(async function e(e,t){const n=S(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",e=>r.getFieldIndexes(e).next(n=>(function e(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(e[u],t[a]);i<0?s(e[u++]):i>0?r(t[a++]):(a++,u++)}for(;a<o;)r(t[a++]);for(;u<i;)s(e[u++])})(n,t,eu,t=>{s.push(r.addFieldIndex(e,t))},t=>{s.push(r.deleteFieldIndex(e,t))})).next(()=>ev.waitFor(s)))})(await cP(e),t))}function cZ(e,t){return e.asyncQueue.enqueue(async()=>(function e(e,t){S(e).Ms.fs=t})(await cP(e),t))}function c0(e){return e.asyncQueue.enqueue(async()=>(function e(e){const t=S(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",e=>n.deleteAllFieldIndexes(e))})(await cP(e)))}function c1(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const c2=new Map;function c4(e,t,n){if(!n)throw new N(C.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function c3(e,t,n,r){if(!0===t&&!0===r)throw new N(C.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function c6(e){if(!er.isDocumentKey(e))throw new N(C.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function c5(e){if(er.isDocumentKey(e))throw new N(C.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function c8(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function e(e){if(e.constructor)return e.constructor.name;return null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":T(12329,{type:typeof e})}function c9(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(C.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=c8(e);throw new N(C.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function c7(e,t){if(t<=0)throw new N(C.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const le="firestore.googleapis.com",lt=!0;class ln{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new N(C.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=le,this.ssl=lt}else this.host=e.host,this.ssl=null!==(t=e.ssl)&&void 0!==t?t:lt;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=os;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<ov)throw new N(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}c3("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=true:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=c1(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function e(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function e(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lr{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ln({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new N(C.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(C.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ln(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function e(e){if(!e)return new A;switch(e.type){case"firstParty":return new F(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(C.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function e(e){const t=c2.get(e);t&&(w("ComponentProvider","Removing Datastore"),c2.delete(e),t.terminate())}(this),Promise.resolve()}}function ls(e,t,n,r={}){var s;e=c9(e,lr);const i=(0,o.zJ)(t),a=e._getSettings(),u=Object.assign(Object.assign({},a),{emulatorOptions:e._getEmulatorOptions()}),c=`${t}:${n}`;i&&((0,o.gE)(`https://${c}`),(0,o.P1)("Firestore",!0)),a.host!==le&&a.host!==c&&I("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");const l=Object.assign(Object.assign({},a),{host:c,ssl:i,emulatorOptions:r});if(!(0,o.bD)(l,u)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=f.MOCK_USER;else{t=(0,o.Fy)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new N(C.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new f(i)}e._authCredentials=new R(new k(t,n))}}class li{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new li(this.firestore,e,this._query)}}class lo{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new la(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lo(this.firestore,e,this._key)}}class la extends li{constructor(e,t,n){super(e,t,rm(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new lo(this.firestore,null,new er(e))}withConverter(e){return new la(this.firestore,e,this._path)}}function lu(e,t,...n){if(e=getModularInstance(e),c4("collection","path",t),e instanceof lr){const r=ee.fromString(t,...n);return c5(r),new la(e,null,r)}{if(!(e instanceof lo||e instanceof la))throw new N(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(ee.fromString(t,...n));return c5(r),new la(e.firestore,null,r)}}function lc(e,t){if(e=c9(e,lr),c4("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new N(C.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new li(e,null,function e(e){return new rd(ee.emptyPath(),e)}(t))}function ll(e,t,...n){if(e=getModularInstance(e),1===arguments.length&&(t=B.newId()),c4("doc","path",t),e instanceof lr){const r=ee.fromString(t,...n);return c6(r),new lo(e,null,new er(r))}{if(!(e instanceof lo||e instanceof la))throw new N(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(ee.fromString(t,...n));return c6(r),new lo(e.firestore,e instanceof la?e.converter:null,new er(r))}}function lh(e,t){return e=getModularInstance(e),t=getModularInstance(t),(e instanceof lo||e instanceof la)&&(t instanceof lo||t instanceof la)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function ld(e,t){return e=getModularInstance(e),t=getModularInstance(t),e instanceof li&&t instanceof li&&e.firestore===t.firestore&&rb(e._query,t._query)&&e.converter===t.converter}const lf="AsyncQueue";class lm{constructor(e=Promise.resolve()){this.Ju=[],this.Yu=!1,this.Zu=[],this.Xu=null,this.ec=!1,this.tc=!1,this.nc=[],this.x_=new aj(this,"async_queue_retry"),this.rc=()=>{const e=aG();e&&w(lf,"Visibility state changed to "+e.visibilityState),this.x_.b_()},this.sc=e;const t=aG();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.rc)}get isShuttingDown(){return this.Yu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.oc(),this._c(e)}enterRestrictedMode(e){if(!this.Yu){this.Yu=!0,this.tc=e||!1;const t=aG();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.rc)}}enqueue(e){if(this.oc(),this.Yu)return new Promise(()=>{});const t=new D;return this._c(()=>this.Yu&&this.tc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Ju.push(e),this.ac()))}async ac(){if(0!==this.Ju.length){try{await this.Ju[0](),this.Ju.shift(),this.x_.reset()}catch(e){if(!eS(e))throw e;w(lf,"Operation failed with retryable error: "+e)}this.Ju.length>0&&this.x_.y_(()=>this.ac())}}_c(e){const t=this.sc.then(()=>(this.ec=!0,e().catch(e=>{this.Xu=e,this.ec=!1;throw v("INTERNAL UNHANDLED ERROR: ",lg(e)),e}).then(e=>(this.ec=!1,e))));return this.sc=t,t}enqueueAfterDelay(e,t,n){this.oc(),this.nc.indexOf(e)>-1&&(t=0);const r=uT.createAndSchedule(this,e,t,n,e=>this.uc(e));return this.Zu.push(r),r}oc(){this.Xu&&T(47125,{cc:lg(this.Xu)})}verifyOperationInProgress(){}async lc(){let e;do{e=this.sc,await e}while(e!==this.sc)}hc(e){for(const t of this.Zu)if(t.timerId===e)return!0;return!1}Pc(e){return this.lc().then(()=>{this.Zu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const t of this.Zu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.lc()})}Tc(e){this.nc.push(e)}uc(e){const t=this.Zu.indexOf(e);this.Zu.splice(t,1)}}function lg(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}function lp(e){return function e(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of t)if(e in n&&"function"==typeof n[e])return!0;return!1}(e,["next","error","complete"])}class ly{constructor(){this._progressObserver={},this._taskCompletionResolver=new D,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const lw=null&&-1;class lv extends lr{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lm,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new lm(e),this._firestoreClient=void 0,await e}}}function lI(e,t,n){n||(n=nl);const r=_getProvider(e,"firestore");if(r.isInitialized(n)){const e=r.getImmediate({identifier:n}),s=r.getOptions(n);if(deepEqual(s,t))return e;throw new N(C.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new N(C.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<ov)throw new N(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return t.host&&isCloudWorkstation(t.host)&&pingServer(t.host),r.initialize({options:t,instanceIdentifier:n})}function l_(e,t){const n="object"==typeof e?e:(0,r.Sx)(),s="string"==typeof e?e:t||nl,i=(0,r.j6)(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=(0,o.yU)("firestore");e&&ls(i,...e)}return i}function lT(e){if(e._terminated)throw new N(C.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lb(e),e._firestoreClient}function lb(e){var t,n,r;const s=e._freezeSettings(),i=function e(e,t,n,r){return new nc(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,c1(r.experimentalLongPollingOptions),r.useFetchStreams,r.isUsingEmulator)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._componentsProvider||(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider}),e._firestoreClient=new cA(e._authCredentials,e._appCheckCredentials,e._queue,i,e._componentsProvider&&function e(e){const t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}function lE(e,t){I("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings();return lS(e,cE.provider,{build:e=>new cT(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()}async function lx(e){I("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=e._freezeSettings();lS(e,cE.provider,{build:e=>new cb(e,t.cacheSizeBytes)})}function lS(e,t,n){if((e=c9(e,lv))._firestoreClient||e._terminated)throw new N(C.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new N(C.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},lb(e)}function lC(e){if(e._initialized&&!e._terminated)throw new N(C.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new D;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function e(e){if(!eT.C())return Promise.resolve();const t=e+o4;await eT.delete(t)}(o8(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}function lN(e){return function e(e){const t=new D;return e.asyncQueue.enqueueAndForget(async()=>u8(await cq(e),t)),t.promise}(lT(e=c9(e,lv)))}function lD(e){return cz(lT(e=c9(e,lv)))}function lk(e){return c$(lT(e=c9(e,lv)))}function lA(e){return _removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()}function lR(e,t){const n=lT(e=c9(e,lv)),r=new ly;return cH(n,e._databaseId,t,r),r}function lV(e,t){return cJ(lT(e=c9(e,lv)),t).then(t=>t?new li(e,null,t.query):null)}class lM{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class lF{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class lO{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lO(t8.fromBase64String(e))}catch(e){throw new N(C.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lO(t8.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class lP{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(C.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new en(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function lL(){return new lP(X)}class lq{constructor(e){this._methodName=e}}class lU{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(C.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(C.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return z(this._lat,e._lat)||z(this._long,e._long)}}class lB{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function e(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}const lz=/^__.*__$/;class l${constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new sa(e,this.data,this.fieldMask,t,this.fieldTransforms):new so(e,this.data,t,this.fieldTransforms)}}class lK{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new sa(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lG(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw T(40011,{Ic:e})}}class lQ{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Ec(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Ic(){return this.settings.Ic}dc(e){return new lQ(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ac(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.dc({path:n,Rc:!1});return r.Vc(e),r}mc(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.dc({path:n,Rc:!1});return r.Ec(),r}fc(e){return this.dc({path:void 0,Rc:!0})}gc(e){return hn(e,this.settings.methodName,this.settings.yc||!1,this.path,this.settings.wc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Ec(){if(this.path)for(let e=0;e<this.path.length;e++)this.Vc(this.path.get(e))}Vc(e){if(0===e.length)throw this.gc("Document fields must not be empty");if(lG(this.Ic)&&lz.test(e))throw this.gc('Document fields cannot begin and end with "__"')}}class lj{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||aQ(e)}bc(e,t,n,r=!1){return new lQ({Ic:e,methodName:t,wc:n,path:en.emptyPath(),Rc:!1,yc:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lW(e){const t=e._freezeSettings(),n=aQ(e._databaseId);return new lj(e._databaseId,!!t.ignoreUndefinedProperties,n)}function lY(e,t,n,r,s,i={}){const o=e.bc(i.merge||i.mergeFields?2:0,t,n,s);l9("Data must be an object, but it was:",o,r);const a=l5(r,o);let u,c;if(i.merge)u=new t3(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=l7(t,r,n);if(!o.contains(s))throw new N(C.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);hr(e,s)||e.push(s)}u=new t3(e),c=o.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=o.fieldTransforms;return new l$(new nB(a),u,c)}class lH extends lq{_toFieldTransform(e){if(2!==e.Ic)throw 1===e.Ic?e.gc(`${this._methodName}() can only appear at the top level of your update data`):e.gc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof lH}}function lJ(e,t,n){return new lQ({Ic:3,wc:t.settings.wc,methodName:e._methodName,Rc:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lX extends(null&&lq){_toFieldTransform(e){return new r6(e.path,new rJ)}isEqual(e){return e instanceof lX}}class lZ extends lq{constructor(e,t){super(e),this.Sc=t}_toFieldTransform(e){const t=lJ(this,e,!0),n=this.Sc.map(e=>l6(e,t)),r=new rX(n);return new r6(e.path,r)}isEqual(e){return e instanceof lZ&&(0,o.bD)(this.Sc,e.Sc)}}class l0 extends lq{constructor(e,t){super(e),this.Sc=t}_toFieldTransform(e){const t=lJ(this,e,!0),n=this.Sc.map(e=>l6(e,t)),r=new r0(n);return new r6(e.path,r)}isEqual(e){return e instanceof l0&&(0,o.bD)(this.Sc,e.Sc)}}class l1 extends lq{constructor(e,t){super(e),this.Dc=t}_toFieldTransform(e){const t=new r2(e.serializer,rQ(e.serializer,this.Dc));return new r6(e.path,t)}isEqual(e){return e instanceof l1&&this.Dc===e.Dc}}function l2(e,t,n,r){const s=e.bc(1,t,n);l9("Data must be an object, but it was:",s,r);const i=[],a=nB.empty();tY(r,(e,r)=>{const u=ht(t,e,n);r=(0,o.Ku)(r);const c=s.mc(u);if(r instanceof lH)i.push(u);else{const e=l6(r,c);null!=e&&(i.push(u),a.set(u,e))}});const u=new t3(i);return new lK(a,u,s.fieldTransforms)}function l4(e,t,n,r,s,i){const a=e.bc(1,t,n),u=[l7(t,r,n)],c=[s];if(i.length%2!=0)throw new N(C.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)u.push(l7(t,i[e])),c.push(i[e+1]);const l=[],h=nB.empty();for(let e=u.length-1;e>=0;--e)if(!hr(l,u[e])){const t=u[e];let n=c[e];n=(0,o.Ku)(n);const r=a.mc(t);if(n instanceof lH)l.push(t);else{const e=l6(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new t3(l);return new lK(h,d,a.fieldTransforms)}function l3(e,t,n,r=!1){return l6(n,e.bc(r?4:3,t))}function l6(e,t){if(l8(e=(0,o.Ku)(e)))return l9("Unsupported field value:",t,e),l5(e,t);if(e instanceof lq)return function e(e,t){if(!lG(t.Ic))throw t.gc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.gc(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Rc&&4!==t.Ic)throw t.gc("Nested arrays are not supported");return function e(e,t){const n=[];let r=0;for(const s of e){let e=l6(s,t.fc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function e(e,t){if(null===(e=(0,o.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rQ(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=H.fromDate(e);return{timestampValue:sz(t.serializer,n)}}if(e instanceof H){const n=new H(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:sz(t.serializer,n)}}if(e instanceof lU)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lO)return{bytesValue:s$(t.serializer,e._byteString)};if(e instanceof lo){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.gc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:sQ(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lB)return function e(e,t){const n={fields:{[nd]:{stringValue:ng},[np]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.gc("VectorValues must only contain numeric values.");return rK(t.serializer,e)})}}}};return{mapValue:n}}(e,t);throw t.gc(`Unsupported field value: ${c8(e)}`)}(e,t)}function l5(e,t){const n={};return tJ(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tY(e,(e,r)=>{const s=l6(r,t.Ac(e));null!=s&&(n[e]=s)}),{mapValue:{fields:n}}}function l8(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof H||e instanceof lU||e instanceof lO||e instanceof lo||e instanceof lq||e instanceof lB)}function l9(e,t,n){if(!l8(n)||!function e(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=c8(n);throw"an object"===r?t.gc(e+" a custom object"):t.gc(e+" "+r)}}function l7(e,t,n){if((t=(0,o.Ku)(t))instanceof lP)return t._internalPath;if("string"==typeof t)return ht(e,t);throw hn("Field path arguments must be of type string or ",e,!1,void 0,n)}const he=new RegExp("[~\\*/\\[\\]]");function ht(e,t,n){if(t.search(he)>=0)throw hn(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new lP(...t.split("."))._internalPath}catch(r){throw hn(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function hn(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new N(C.INVALID_ARGUMENT,a+e+u)}function hr(e,t){return e.some(e=>e.isEqual(t))}class hs{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new lo(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new hi(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(ho("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class hi extends hs{data(){return super.data()}}function ho(e,t){return"string"==typeof t?ht(e,t):t instanceof lP?t._internalPath:t._delegate._internalPath}function ha(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new N(C.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class hu{}class hc extends hu{}function hl(e,t,...n){let r=[];t instanceof hu&&r.push(t),r=r.concat(n),function e(e){const t=e.filter(e=>e instanceof hf).length,n=e.filter(e=>e instanceof hh).length;if(t>1||t>0&&n>0)throw new N(C.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class hh extends hc{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new hh(e,t,n)}_apply(e){const t=this._parse(e);return hk(e._query,t),new li(e.firestore,e.converter,r_(e._query,t))}_parse(e){const t=lW(e.firestore),n=function e(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new N(C.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){hD(o,i);const t=[];for(const n of o)t.push(hN(r,e,n));a={arrayValue:{values:t}}}else a=hN(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||hD(o,i),a=l3(n,t,o,"in"===i||"not-in"===i);const u=nH.create(s,i,a);return u}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function hd(e,t,n){const r=t,s=ho("where",e);return hh._create(s,r,n)}class hf extends hu{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new hf(e,t)}_parse(e){const t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nJ.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function e(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)hk(n,e),n=r_(n,e)}(e._query,t),new li(e.firestore,e.converter,r_(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function hm(...e){return e.forEach(e=>hA("or",e)),hf._create("or",e)}function hg(...e){return e.forEach(e=>hA("and",e)),hf._create("and",e)}class hp extends hc{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new hp(e,t)}_apply(e){const t=function e(e,t,n){if(null!==e.startAt)throw new N(C.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(C.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new nj(t,n);return r}(e._query,this._field,this._direction);return new li(e.firestore,e.converter,function e(e,t){const n=e.explicitOrderBy.concat([t]);return new rd(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function hy(e,t="asc"){const n=t,r=ho("orderBy",e);return hp._create(r,n)}class hw extends hc{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new hw(e,t,n)}_apply(e){return new li(e.firestore,e.converter,rT(e._query,this._limit,this._limitType))}}function hv(e){return c7("limit",e),hw._create("limit",e,"F")}function hI(e){return c7("limitToLast",e),hw._create("limitToLast",e,"L")}class h_ extends hc{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new h_(e,t,n)}_apply(e){const t=hC(e,this.type,this._docOrFields,this._inclusive);return new li(e.firestore,e.converter,function e(e,t){return new rd(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function hT(...e){return h_._create("startAt",e,!0)}function hb(...e){return h_._create("startAfter",e,!1)}class hE extends hc{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new hE(e,t,n)}_apply(e){const t=hC(e,this.type,this._docOrFields,this._inclusive);return new li(e.firestore,e.converter,function e(e,t){return new rd(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function hx(...e){return hE._create("endBefore",e,!1)}function hS(...e){return hE._create("endAt",e,!0)}function hC(e,t,n,r){if(n[0]=(0,o.Ku)(n[0]),n[0]instanceof hs)return function e(e,t,n,r,s){if(!r)throw new N(C.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of ry(e))if(n.field.isKeyField())i.push(nC(t,r.key));else{const e=r.data.field(n.field);if(no(e))throw new N(C.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new N(C.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new nK(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=lW(e.firestore);return function e(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new N(C.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new N(C.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!rp(e)&&-1!==u.indexOf("/"))throw new N(C.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(ee.fromString(u));if(!er.isDocumentKey(n))throw new N(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new er(n);a.push(nC(t,s))}else{const e=l3(n,r,u);a.push(e)}}return new nK(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function hN(e,t,n){if("string"==typeof(n=(0,o.Ku)(n))){if(""===n)throw new N(C.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!rp(t)&&-1!==n.indexOf("/"))throw new N(C.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(ee.fromString(n));if(!er.isDocumentKey(r))throw new N(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nC(e,new er(r))}if(n instanceof lo)return nC(e,n._key);throw new N(C.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${c8(n)}.`)}function hD(e,t){if(!Array.isArray(e)||0===e.length)throw new N(C.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function hk(e,t){const n=function e(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function e(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new N(C.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(C.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function hA(e,t){if(!(t instanceof hh||t instanceof hf))throw new N(C.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class hR{convertValue(e,t="none"){switch(nw(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ne(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(nt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw T(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return tY(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;const s=null===(r=null===(n=null===(t=e.fields)||void 0===t?void 0:t[np].arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map(e=>ne(e.doubleValue));return new lB(s)}convertGeoPoint(e){return new lU(ne(e.latitude),ne(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":const n=na(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(nu(e));default:return null}}convertTimestamp(e){const t=t7(e);return new H(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ee.fromString(e);E(id(n),9688,{name:e});const r=new nh(n.get(1),n.get(3)),s=new er(n.popFirst(5));return r.isEqual(t)||v(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function hV(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class hM extends hR{constructor(e){super(),this.firestore=e}convertBytes(e){return new lO(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new lo(this.firestore,null,t)}}function hF(e){return new lM("sum",l7("sum",e))}function hO(e){return new lM("avg",l7("average",e))}function hP(){return new lM("count")}function hL(e,t){var n,r;return e instanceof lM&&t instanceof lM&&e.aggregateType===t.aggregateType&&(null===(n=e._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=t._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function hq(e,t){return ld(e.query,t.query)&&deepEqual(e.data(),t.data())}class hU{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class hB extends hs{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new hz(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(ho("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class hz extends hB{data(e={}){return super.data(e)}}class h${constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new hU(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new hz(this._firestore,this._userDataWriter,n.key,n,new hU(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new N(C.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function e(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{const r=new hz(e._firestore,e._userDataWriter,n.doc.key,n.doc,new hU(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{const r=new hz(e._firestore,e._userDataWriter,t.doc.key,t.doc,new hU(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:hK(t.type),doc:r,oldIndex:s,newIndex:i}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function hK(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return T(61501,{type:e})}}function hG(e,t){return e instanceof hB&&t instanceof hB?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof h$&&t instanceof h$&&e._firestore===t._firestore&&ld(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function hQ(e){e=c9(e,lo);const t=c9(e.firestore,lv);return cG(lT(t),e._key).then(n=>h5(t,e,n))}class hj extends hR{constructor(e){super(),this.firestore=e}convertBytes(e){return new lO(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new lo(this.firestore,null,t)}}function hW(e){e=c9(e,lo);const t=c9(e.firestore,lv),n=lT(t),r=new hj(t);return cK(n,e._key).then(n=>new hB(t,r,e._key,n,new hU(null!==n&&n.hasLocalMutations,!0),e.converter))}function hY(e){e=c9(e,lo);const t=c9(e.firestore,lv);return cG(lT(t),e._key,{source:"server"}).then(n=>h5(t,e,n))}function hH(e){e=c9(e,li);const t=c9(e.firestore,lv),n=lT(t),r=new hj(t);return ha(e._query),cj(n,e._query).then(n=>new h$(t,r,e,n))}function hJ(e){e=c9(e,li);const t=c9(e.firestore,lv),n=lT(t),r=new hj(t);return cQ(n,e._query).then(n=>new h$(t,r,e,n))}function hX(e){e=c9(e,li);const t=c9(e.firestore,lv),n=lT(t),r=new hj(t);return cj(n,e._query,{source:"server"}).then(n=>new h$(t,r,e,n))}function hZ(e,t,n){e=c9(e,lo);const r=c9(e.firestore,lv),s=hV(e.converter,t,n);return h6(r,[lY(lW(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,r9.none())])}function h0(e,t,n,...r){e=c9(e,lo);const s=c9(e.firestore,lv),i=lW(s);let o;o="string"==typeof(t=getModularInstance(t))||t instanceof lP?l4(i,"updateDoc",e._key,t,n,r):l2(i,"updateDoc",e._key,t);return h6(s,[o.toMutation(e._key,r9.exists(!0))])}function h1(e){return h6(c9(e.firestore,lv),[new sh(e._key,r9.none())])}function h2(e,t){const n=c9(e.firestore,lv),r=ll(e),s=hV(e.converter,t);return h6(n,[lY(lW(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,r9.exists(!1))]).then(()=>r)}function h4(e,...t){var n,r,s;e=getModularInstance(e);let i={includeMetadataChanges:!1,source:"default"},o=0;"object"!=typeof t[o]||lp(t[o])||(i=t[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges,source:i.source};if(lp(t[o])){const e=t[o];t[o]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[o+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[o+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,c,l;if(e instanceof lo)c=c9(e.firestore,lv),l=rm(e._key.path),u={next:n=>{t[o]&&t[o](h5(c,e,n))},error:t[o+1],complete:t[o+2]};else{const n=c9(e,li);c=c9(n.firestore,lv),l=n._query;const r=new hj(c);u={next:e=>{t[o]&&t[o](new h$(c,r,n,e))},error:t[o+1],complete:t[o+2]},ha(e._query)}return function e(e,t,n,r){const s=new cS(r),i=new uP(t,s,n);return e.asyncQueue.enqueueAndForget(async()=>uk(await cB(e),i)),()=>{s.xu(),e.asyncQueue.enqueueAndForget(async()=>uA(await cB(e),i))}}(lT(c),l,a,u)}function h3(e,t){return cY(lT(e=c9(e,lv)),lp(t)?t:{next:t})}function h6(e,t){return function e(e,t){const n=new D;return e.asyncQueue.enqueueAndForget(async()=>u1(await cq(e),t,n)),n.promise}(lT(e),t)}function h5(e,t,n){const r=n.docs.get(t._key),s=new hj(e);return new hB(e,s,t._key,r,new hU(n.hasPendingWrites,n.fromCache),t.converter)}function h8(e){return h9(e,{count:hP()})}function h9(e,t){const n=c9(e.firestore,lv),r=lT(n),s=tH(t,(e,t)=>new sp(t,e.aggregateType,e._internalFieldPath));return cW(r,e._query,s).then(t=>(function e(e,t,n){const r=new hj(e),s=new lF(t,r,n);return s})(n,e,t))}class h7{constructor(e){this.kind="memory",this._onlineComponentProvider=cE.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider={build:()=>new c_(void 0)}}toJSON(){return{kind:this.kind}}}class de{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=dl(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class dt{constructor(){this.kind="memoryEager",this._offlineComponentProvider=cI.provider}toJSON(){return{kind:this.kind}}}class dn{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new c_(e)}}toJSON(){return{kind:this.kind}}}function dr(){return new dt}function ds(e){return new dn(null==e?void 0:e.cacheSizeBytes)}function di(e){return new h7(e)}function da(e){return new de(e)}class du{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=cE.provider,this._offlineComponentProvider={build:t=>new cT(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class dc{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=cE.provider,this._offlineComponentProvider={build:t=>new cb(t,null==e?void 0:e.cacheSizeBytes)}}}function dl(e){return new du(null==e?void 0:e.forceOwnership)}function dh(){return new dc}const dd={maxAttempts:5};class df{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=lW(e)}set(e,t,n){this._verifyNotCommitted();const r=dm(e,this._firestore),s=hV(r.converter,t,n),i=lY(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,r9.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=dm(e,this._firestore);let i;return i="string"==typeof(t=getModularInstance(t))||t instanceof lP?l4(this._dataReader,"WriteBatch.update",s._key,t,n,r):l2(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,r9.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=dm(e,this._firestore);return this._mutations=this._mutations.concat(new sh(t._key,r9.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new N(C.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function dm(e,t){if((e=(0,o.Ku)(e)).firestore!==t)throw new N(C.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class dg{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=lW(e)}get(e){const t=dm(e,this._firestore),n=new hM(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return T(24041);const r=e[0];if(r.isFoundDocument())return new hs(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new hs(this._firestore,n,t._key,null,t.converter);throw T(18433,{doc:r})})}set(e,t,n){const r=dm(e,this._firestore),s=hV(r.converter,t,n),i=lY(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=dm(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof lP?l4(this._dataReader,"Transaction.update",s._key,t,n,r):l2(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=dm(e,this._firestore);return this._transaction.delete(t._key),this}}class dp extends dg{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=dm(e,this._firestore),n=new hj(this._firestore);return super.get(e).then(e=>new hB(this._firestore,n,t._key,e._document,new hU(!1,!1),t.converter))}}function dy(e,t,n){e=c9(e,lv);const r=Object.assign(Object.assign({},dd),n);!function e(e){if(e.maxAttempts<1)throw new N(C.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r);return function e(e,t,n){const r=new D;return e.asyncQueue.enqueueAndForget(async()=>{const s=await cU(e);new cD(e.asyncQueue,s,n,t,r).Wu()}),r.promise}(lT(e),n=>t(new dp(e,n)),r)}function dw(){return new lH("deleteField")}function dv(){return new lX("serverTimestamp")}function dI(...e){return new lZ("arrayUnion",e)}function d_(...e){return new l0("arrayRemove",e)}function dT(e){return new l1("increment",e)}function db(e){return new lB(e)}function dE(e){return lT(e=c9(e,lv)),new df(e,t=>h6(e,t))}function dx(e,t){const n=lT(e=c9(e,lv));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return I("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function e(e){const t="string"==typeof e?function e(e){try{return JSON.parse(e)}catch(e){throw new N(C.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const e of t.indexes){const t=dS(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(const t of e.fields){const e=ht("setIndexConfiguration",dS(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new ec(e,2)):"ASCENDING"===t.order?r.push(new ec(e,0)):"DESCENDING"===t.order&&r.push(new ec(e,1))}n.push(new ei(ei.UNKNOWN_ID,t,r,eh.empty()))}return n}(t);return cX(n,r)}function dS(e,t){if("string"!=typeof e[t])throw new N(C.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class dC{constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function dN(e){var t;e=c9(e,lv);const n=dV.get(e);if(n)return n;if("persistent"!==(null===(t=lT(e)._uninitializedComponentsProvider)||void 0===t?void 0:t._offline.kind))return null;const r=new dC(e);return dV.set(e,r),r}function dD(e){dR(e,!0)}function dk(e){dR(e,!1)}function dA(e){c0(lT(e._firestore)).then(e=>w("deleting all persistent cache indexes succeeded")).catch(e=>I("deleting all persistent cache indexes failed",e))}function dR(e,t){cZ(lT(e._firestore),t).then(e=>w(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>I(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}const dV=new WeakMap;function dM(e){var t;const n=null===(t=lT(c9(e.firestore,lv))._onlineComponents)||void 0===t?void 0:t.datastore.serializer;return void 0===n?null:s7(n,rw(e._query)).gt}function dF(e,t){var n;const r=tH(t,(e,t)=>new sp(t,e.aggregateType,e._internalFieldPath)),s=null===(n=lT(c9(e.firestore,lv))._onlineComponents)||void 0===n?void 0:n.datastore.serializer;return void 0===s?null:ie(s,rv(e._query),r,!0).request}class dO{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return dP.instance.onExistenceFilterMismatch(e)}}class dP{constructor(){this.vc=new Map}static get instance(){return dL||(dL=new dP,function e(e){if(sT)throw new Error("a TestingHooksSpi instance is already set");sT=e}(dL)),dL}ht(e){this.vc.forEach(t=>t(e))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.vc;return n.set(t,e),()=>n.delete(t)}}let dL=null;!function e(t,n=!0){!function e(e){m=e}(r.MF),(0,r.om)(new s.uA("firestore",(e,{instanceIdentifier:t,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new lv(new V(e.getProvider("auth-internal")),new P(s,e.getProvider("app-check-internal")),function e(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(C.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new nh(e.options.projectId,t)}(s,t),s);return r=Object.assign({useFetchStreams:n},r),i._setSettings(r),i},"PUBLIC").setMultipleInstances(!0)),(0,r.KO)(h,d,t),(0,r.KO)(h,d,"esm2017")}()}}]);